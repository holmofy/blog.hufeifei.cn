<!doctype html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-H58NSPXYPF"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-H58NSPXYPF")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?b3392fb5f6d65fb10354f590338d1ee4",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(t,e,n,c,a,i){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/95vxjpui4h",(i=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,i)}(window,document,"clarity","script")</script><title>JavaIO怎么调用WindowsAPI的——从Native层剖析JavaIO文件读写 | holmofy</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="baidu_union_verify" content="b7d27ec946758934fcdf3c5c26386237"><meta description="上一篇文章中列举了JavaIO中FileDescriptor和File类提供的一些文件操作，这些操作还只是对文件系统中的文件进行创建或删除操作。鉴于大一玩过Window编程(对Linux API不是很熟悉)，所以这篇文章会从Windows C API去分析一下Java提供给我们的几个文件读写类。  建议结合着源代码看这篇文章(这篇文章就是记录我看源代码的过程，这里的java版本是1.8.0_131"><meta property="og:type" content="article"><meta property="og:title" content="JavaIO怎么调用WindowsAPI的——从Native层剖析JavaIO文件读写"><meta property="og:url" content="https://blog.hufeifei.cn/2017/08/Java/JavaIO%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8WindowsAPI%E7%9A%84/index.html"><meta property="og:site_name" content="holmofy"><link rel="canonical" href="https://blog.hufeifei.cn/2017/08/Java/JavaIO%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8WindowsAPI%E7%9A%84/index.html"><meta property="description" content="上一篇文章中列举了JavaIO中FileDescriptor和File类提供的一些文件操作，这些操作还只是对文件系统中的文件进行创建或删除操作。鉴于大一玩过Window编程(对Linux API不是很熟悉)，所以这篇文章会从Windows C API去分析一下Java提供给我们的几个文件读写类。  建议结合着源代码看这篇文章(这篇文章就是记录我看源代码的过程，这里的java版本是1.8.0_131"><meta name="description" content="上一篇文章中列举了JavaIO中FileDescriptor和File类提供的一些文件操作，这些操作还只是对文件系统中的文件进行创建或删除操作。鉴于大一玩过Window编程(对Linux API不是很熟悉)，所以这篇文章会从Windows C API去分析一下Java提供给我们的几个文件读写类。  建议结合着源代码看这篇文章(这篇文章就是记录我看源代码的过程，这里的java版本是1.8.0_131"><meta property="og:description" content="上一篇文章中列举了JavaIO中FileDescriptor和File类提供的一些文件操作，这些操作还只是对文件系统中的文件进行创建或删除操作。鉴于大一玩过Window编程(对Linux API不是很熟悉)，所以这篇文章会从Windows C API去分析一下Java提供给我们的几个文件读写类。  建议结合着源代码看这篇文章(这篇文章就是记录我看源代码的过程，这里的java版本是1.8.0_131"><meta property="article:published_time" content="2017-08-12T16:00:00.000Z"><meta property="article:modified_time" content="2024-05-03T05:17:06.695Z"><meta property="article:author" content="胡飞飞"><meta property="article:tag" content="Java"><meta property="article:tag" content="DB"><meta property="article:tag" content="Alibaba"><meta property="article:tag" content="Holmofy"><meta property="article:tag" content="胡飞飞"><meta property="twitter:card" content="summary"><script data-ad-client="ca-pub-7111912103882824" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7111912103882824" crossorigin="anonymous"></script><script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script><script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async defer></script><link rel="alternate" href="/atom.xml" title="holmofy" type="application/atom+xml"><link rel="icon" href="//www.hufeifei.cn/favicon.jpg"><link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"><link href="//unpkg.com/@waline/client@v3/dist/waline.css" rel="stylesheet" type="text/css"><link href="//at.alicdn.com/t/font_841402_efkj8jo1xld.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/font-awesome/5.15.3/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/style.css"><link rel="dns-prefetch" href="//static.zhimg.com"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdn.jsdelivr.net"><link rel="dns-prefetch" href="//img-blog.csdn.net"><link rel="dns-prefetch" href="//img-blog.csdnimg.cn"><meta name="generator" content="Hexo 6.3.0"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><style>
    figure.codeblock {
       margin: 0;
    }
    figure figcaption .tabs {
      display: flex;
      margin: 0;
    }
    figure figcaption .tabs .tab {
      cursor: pointer;
      list-style: none;
      padding: 5px 15px;
    }
    figure figcaption .tabs .tab.active {
      background: #2d2d2d;
      color: white;
    }
  </style></head><body><amp-auto-ads type="adsense" data-ad-client="ca-pub-7111912103882824"></amp-auto-ads><div id="container"><div id="wrap"><header id="header"><div class="outer" id="header-outer"><div class="inner" id="header-inner"><nav id="main-nav"><a class="nav-icon" id="main-nav-toggle"><i class="fas fa-bars"></i></a><a class="main-nav-link" href="//www.hufeifei.cn">主页</a><a class="main-nav-link" href="/">博客</a><a class="main-nav-link" href="/archives">归档</a><a class="main-nav-link" target="_blank" rel="noopener" href="//algo.hufeifei.cn">算法</a><a class="main-nav-link" href="/book">书籍</a><a class="main-nav-link" href="/github">Github</a></nav><nav id="sub-nav"><a class="nav-icon" id="nav-rss-link" href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a><a class="nav-icon" id="nav-search-btn" title="Search"><i class="fas fa-search"></i></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="fas fa-search"></i></button><input type="hidden" name="sitesearch" value="https://blog.hufeifei.cn"></form></div></div></div></header><div class="outer"><section id="main"><article class="article article-type-post" id="post-Java/JavaIO怎么调用WindowsAPI的" itemscope itemprop="blogPost"><div class="article-meta"><a class="article-date" href="/2017/08/Java/JavaIO%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8WindowsAPI%E7%9A%84/"><time datetime="2017-08-12T16:00:00.000Z" itemprop="datePublished">2017-08-13</time></a><div class="article-category"><a class="article-category-link" href="/categories/JAVA/">JAVA</a></div><div class="article-views leancloud_visitors" id="/2017/08/Java/JavaIO%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8WindowsAPI%E7%9A%84/" data-flag-title="JavaIO怎么调用WindowsAPI的——从Native层剖析JavaIO文件读写" title="Views"><i class="fas fa-eye"></i><span class="waline-pageview-count" data-path="/2017/08/Java/JavaIO%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8WindowsAPI%E7%9A%84/"></span></div></div><div class="article-inner"><header class="article-header" style="text-align:center"><h1 class="article-title" itemprop="name">JavaIO怎么调用WindowsAPI的——从Native层剖析JavaIO文件读写</h1></header><div class="article-entry" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/holmofy/article/details/75269866">上一篇文章</a>中列举了JavaIO中FileDescriptor和File类提供的一些文件操作，这些操作还只是对文件系统中的文件进行创建或删除操作。鉴于大一玩过Window编程(对Linux API不是很熟悉)，所以这篇文章会从Windows C API去分析一下Java提供给我们的几个文件读写类。</p><blockquote><p>建议结合着源代码看这篇文章(这篇文章就是记录我看源代码的过程，这里的java版本是1.8.0_131)</p></blockquote><h2>RandomAccessFile</h2><p>这个类就是完全模仿C语言的文件读写操作，允许随机读取，想读文件的哪个部分就可以把文件流指针指到哪儿。下面会列一张表将这个类中的常用方法和标准C语言API进行对比，然后再看一下Java在Native层是怎么实现这个类的：</p><table><thead><tr><th align="center">Java</th><th align="center">C</th></tr></thead><tbody><tr><td align="center"><code>public int read(byte b[], int off, int len)</code><br><code>public int read(byte b[])</code><br><code>public final void readFully(byte b[])</code><br><code>public final void readFully(byte b[], int off, int len)</code></td><td align="center"><code>size_t fread( void *buffer, size_t size, size_t count, FILE *stream );</code></td></tr><tr><td align="center"><code>public int read()</code></td><td align="center"><code>int fgetc( FILE *stream );</code><br><code>int getc( FILE *stream );</code></td></tr><tr><td align="center"><code>public void write(byte b[])</code><br><code>public void write(byte b[], int off, int len)</code></td><td align="center"><code>size_t fwrite( const void *buffer, size_t size, size_t count, FILE *stream );</code></td></tr><tr><td align="center"><code>public void write(int b)</code></td><td align="center"><code>int fputc( int ch, FILE *stream );</code><br><code>int putc( int ch, FILE *stream );</code></td></tr><tr><td align="center"><code>public void seek(long pos)</code><br><code>public int skipBytes(int n)</code></td><td align="center"><code>int fseek( FILE *stream, long offset, int origin );</code><br><code>int fsetpos( FILE *stream, const fpos_t *pos );</code><br><code>void rewind(FILE *stream);</code></td></tr><tr><td align="center"><code>public native long getFilePointer()</code></td><td align="center"><code>long ftell( FILE *stream );</code><br><code>int fgetpos( FILE *stream, fpos_t *pos );</code></td></tr></tbody></table><p>RandomAccessFile还同时实现了<code>DataOutput, DataInput</code>两个接口，所以同时拥有了<code>DataInputStream</code>和<code>DataOutputStream</code>两个类的基本方法。</p><p><img src="http://img-blog.csdn.net/20170820162027077?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSG9sbW9meQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" rel="external noreferrer nofollow noopener" referrerpolicy="no-referrer" alt="RandomAccessFile"></p><h3>open</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先从构造方法开始看</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">RandomAccessFile</span><span class="params">(String name, String mode)</span></span><br><span class="line">    <span class="keyword">throws</span> FileNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">this</span>(name != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">File</span>(name) : <span class="literal">null</span>, mode);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// mode参数指定文件的打开模式</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">RandomAccessFile</span><span class="params">(File file, String mode)</span></span><br><span class="line">    <span class="keyword">throws</span> FileNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (file != <span class="literal">null</span> ? file.getPath() : <span class="literal">null</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">imode</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// r 表示“只读”,调用写操作将会抛出IO异常</span></span><br><span class="line">    <span class="keyword">if</span> (mode.equals(<span class="string">&quot;r&quot;</span>))</span><br><span class="line">        imode = O_RDONLY;</span><br><span class="line">    <span class="comment">// rw 表示“可读可写”,如果文件不存在就会创建它</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode.startsWith(<span class="string">&quot;rw&quot;</span>)) &#123;</span><br><span class="line">        imode = O_RDWR;</span><br><span class="line">        rw = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (mode.length() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// rws 表示每一次写入操作文件内容(content)或元数据(metadata)，</span></span><br><span class="line">            <span class="comment">// 底层存储设备也会同步写入</span></span><br><span class="line">            <span class="keyword">if</span> (mode.equals(<span class="string">&quot;rws&quot;</span>))</span><br><span class="line">                imode |= O_SYNC;</span><br><span class="line">            <span class="comment">// rws 表示每一次写入操作文件内容(content)</span></span><br><span class="line">            <span class="comment">// 底层存储设备也会同步写入</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mode.equals(<span class="string">&quot;rwd&quot;</span>))</span><br><span class="line">                imode |= O_DSYNC;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                imode = -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">// “rwd”模式可用于减少执行的I / O操作的数量。</span></span><br><span class="line">            <span class="comment">// 使用“rwd”更新时只要写入文件内容;</span></span><br><span class="line">            <span class="comment">// 使用“rws”更新时要写入文件内容以及文件元数据(文件大小,文件名等信息)，</span></span><br><span class="line">            <span class="comment">// 而文件元数据的更新,通常需要至少一个底层IO操作</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (imode &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal mode \&quot;&quot;</span> + mode</span><br><span class="line">                                           + <span class="string">&quot;\&quot; must be one of &quot;</span></span><br><span class="line">                                           + <span class="string">&quot;\&quot;r\&quot;, \&quot;rw\&quot;, \&quot;rws\&quot;,&quot;</span></span><br><span class="line">                                           + <span class="string">&quot; or \&quot;rwd\&quot;&quot;</span>);</span><br><span class="line">    <span class="type">SecurityManager</span> <span class="variable">security</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="literal">null</span>) &#123;</span><br><span class="line">        security.checkRead(name);</span><br><span class="line">        <span class="keyword">if</span> (rw) &#123;</span><br><span class="line">            security.checkWrite(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (file.isInvalid()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;Invalid file path&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fd = <span class="keyword">new</span> <span class="title class_">FileDescriptor</span>();</span><br><span class="line">    fd.attach(<span class="built_in">this</span>);</span><br><span class="line">    path = name;</span><br><span class="line">    <span class="comment">// 最终辗转调用native方法</span></span><br><span class="line">    open(name, imode);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(String name, <span class="type">int</span> mode)</span></span><br><span class="line">    <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">    open0(name, mode);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最终的native方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">open0</span><span class="params">(String name, <span class="type">int</span> mode)</span></span><br><span class="line">    <span class="keyword">throws</span> FileNotFoundException;</span><br></pre></td></tr></table></figure><p>下面看一下native层是怎么打开文件的：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// RandomAccessFile.c文件</span></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_RandomAccessFile_open</span><span class="params">(JNIEnv *env,</span></span><br><span class="line"><span class="params">                                   jobject this, jstring path, jint mode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> flags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 构造标志位</span></span><br><span class="line">    <span class="keyword">if</span> (mode &amp; java_io_RandomAccessFile_O_RDONLY)</span><br><span class="line">        flags = O_RDONLY;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode &amp; java_io_RandomAccessFile_O_RDWR) &#123;</span><br><span class="line">        flags = O_RDWR | O_CREAT;</span><br><span class="line">        <span class="keyword">if</span> (mode &amp; java_io_RandomAccessFile_O_SYNC)</span><br><span class="line">            flags |= O_SYNC;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mode &amp; java_io_RandomAccessFile_O_DSYNC)</span><br><span class="line">            flags |= O_DSYNC;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// fileOpen</span></span><br><span class="line">    fileOpen(env, this, path, raf_fd, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util_md.c文件</span></span><br><span class="line"><span class="comment">// 这里看的windows上的实现</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">fileOpen</span><span class="params">(JNIEnv *env, jobject this, jstring path, jfieldID fid, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    FD h = winFileHandleOpen(env, path, flags);</span><br><span class="line">    <span class="keyword">if</span> (h &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        SET_FD(this, h, fid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FD</span><br><span class="line"><span class="title function_">winFileHandleOpen</span><span class="params">(JNIEnv *env, jstring path, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 将标志位解析成Windows API中规定的标志位</span></span><br><span class="line">    <span class="type">const</span> DWORD access =</span><br><span class="line">        (flags &amp; O_WRONLY) ?  GENERIC_WRITE :</span><br><span class="line">        (flags &amp; O_RDWR)   ? (GENERIC_READ | GENERIC_WRITE) :</span><br><span class="line">        GENERIC_READ;</span><br><span class="line">    <span class="type">const</span> DWORD sharing =</span><br><span class="line">        FILE_SHARE_READ | FILE_SHARE_WRITE;</span><br><span class="line">    <span class="type">const</span> DWORD disposition =</span><br><span class="line">        <span class="comment">/* Note: O_TRUNC overrides O_CREAT */</span></span><br><span class="line">        (flags &amp; O_TRUNC) ? CREATE_ALWAYS :</span><br><span class="line">        (flags &amp; O_CREAT) ? OPEN_ALWAYS   :</span><br><span class="line">        OPEN_EXISTING;</span><br><span class="line">    <span class="type">const</span> DWORD  maybeWriteThrough =</span><br><span class="line">        (flags &amp; (O_SYNC | O_DSYNC)) ?</span><br><span class="line">        FILE_FLAG_WRITE_THROUGH :</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL;</span><br><span class="line">    <span class="type">const</span> DWORD maybeDeleteOnClose =</span><br><span class="line">        (flags &amp; O_TEMPORARY) ?</span><br><span class="line">        FILE_FLAG_DELETE_ON_CLOSE :</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL;</span><br><span class="line">    <span class="type">const</span> DWORD flagsAndAttributes = maybeWriteThrough | maybeDeleteOnClose;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件句柄</span></span><br><span class="line">    HANDLE h = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转成Windows路径</span></span><br><span class="line">    WCHAR *pathbuf = pathToNTPath(env, path, JNI_TRUE);</span><br><span class="line">    <span class="keyword">if</span> (pathbuf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* Exception already pending */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用windows API</span></span><br><span class="line">    h = CreateFileW(</span><br><span class="line">        pathbuf,            <span class="comment">/* Wide char path name */</span></span><br><span class="line">        access,             <span class="comment">/* Read and/or write permission */</span></span><br><span class="line">        sharing,            <span class="comment">/* File sharing flags */</span></span><br><span class="line">        <span class="literal">NULL</span>,               <span class="comment">/* Security attributes */</span></span><br><span class="line">        disposition,        <span class="comment">/* creation disposition */</span></span><br><span class="line">        flagsAndAttributes, <span class="comment">/* flags and attributes */</span></span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">free</span>(pathbuf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (h == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        throwFileNotFoundException(env, path);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最后将文件句柄作为FileDescriptor返回</span></span><br><span class="line">    <span class="keyword">return</span> (jlong) h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util.md.h文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FD jlong</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SET_FD(this, fd, fid) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((*env)-&gt;GetObjectField(env, (this), (fid)) != NULL) \</span></span><br><span class="line"><span class="meta">        (*env)-&gt;SetLongField(env, (*env)-&gt;GetObjectField(env, (this), (fid)), IO_handle_fdID, (fd))</span></span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/EN-US/library/windows/desktop/aa363858.aspx">点击这里</a>可以查看<code>CreateFile</code>的API文档：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回文件句柄</span></span><br><span class="line">HANDLE WINAPI <span class="title function_">CreateFile</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="comment">// 创建(或打开)的文件名(或设备名)</span></span></span><br><span class="line"><span class="params">  _In_     LPCTSTR               lpFileName,</span></span><br><span class="line"><span class="params">  <span class="comment">// 访问属性,这个值通常是GENERIC_READ,GENERIC_WRITE,或者(GENERIC_READ | GENERIC_WRITE).</span></span></span><br><span class="line"><span class="params">  _In_     DWORD                 dwDesiredAccess,</span></span><br><span class="line"><span class="params">  <span class="comment">// 文件共享模式: FILE_SHARE_READ,FILE_SHARE_READ,FILE_SHARE_WRITE</span></span></span><br><span class="line"><span class="params">  _In_     DWORD                 dwShareMode,</span></span><br><span class="line"><span class="params">  <span class="comment">// SECURITY_ATTRIBUTES结构体指针，该参数可以为NULL</span></span></span><br><span class="line"><span class="params">  _In_opt_ LPSECURITY_ATTRIBUTES lpSecurityAttributes,</span></span><br><span class="line"><span class="params">  <span class="comment">// 文件创建的配置:</span></span></span><br><span class="line"><span class="params">  <span class="comment">//   CREATE_ALWAYS,总是创建新的文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">//   CREATE_NEW,不存在就创建新文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">//   OPEN_ALWAYS,总是打开文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">//   OPEN_EXISTING,仅当文件存在时打开文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">//   TRUNCATE_EXISTING,如果文件存在,删除原来的数据</span></span></span><br><span class="line"><span class="params">  _In_     DWORD                 dwCreationDisposition,</span></span><br><span class="line"><span class="params">  <span class="comment">// 文件的属性标记:</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_ATTRIBUTE_ARCHIVE,归档文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_ATTRIBUTE_ENCRYPTED,加密文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_ATTRIBUTE_HIDDEN,隐藏文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_ATTRIBUTE_NORMAL,普通文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_ATTRIBUTE_READONLY,只读文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_ATTRIBUTE_TEMPORARY,临时文件</span></span></span><br><span class="line"><span class="params">  <span class="comment">// ...</span></span></span><br><span class="line"><span class="params">  _In_     DWORD                 dwFlagsAndAttributes,</span></span><br><span class="line"><span class="params">  <span class="comment">// 使用某个文件的属性作为模板</span></span></span><br><span class="line"><span class="params">  _In_opt_ HANDLE                hTemplateFile</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><h3>read</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有的read方法最终都会辗转调用这两个方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">read0</span><span class="params">()</span> <span class="keyword">throws</span> IOException; <span class="comment">// 读取一个字节</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">readBytes</span><span class="params">(<span class="type">byte</span> b[], <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException; <span class="comment">// 读取多个字节</span></span><br></pre></td></tr></table></figure><p>Native层代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// RandomAccessFile.c文件</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_RandomAccessFile_read</span><span class="params">(JNIEnv *env, jobject this)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> readSingle(env, this, raf_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_RandomAccessFile_readBytes</span><span class="params">(JNIEnv *env,</span></span><br><span class="line"><span class="params">    jobject this, jbyteArray bytes, jint off, jint len)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> readBytes(env, this, bytes, off, len, raf_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util.c文件</span></span><br><span class="line">jint</span><br><span class="line"><span class="title function_">readSingle</span><span class="params">(JNIEnv *env, jobject this, jfieldID fid)</span> &#123;</span><br><span class="line">    jint nread;</span><br><span class="line">    <span class="type">char</span> ret;</span><br><span class="line">    FD fd = GET_FD(this, fid);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">&quot;Stream Closed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用IO_Read</span></span><br><span class="line">    nread = IO_Read(fd, &amp;ret, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">0</span>) &#123; <span class="comment">/* EOF */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">-1</span>) &#123; <span class="comment">/* error */</span></span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">&quot;Read error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret &amp; <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 缓存大小 */</span></span><br><span class="line"><span class="comment">// 估计这也是为什么BufferedInputStream缓存大小为8192的原因</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 8192</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 越界判断 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">outOfBounds</span><span class="params">(JNIEnv *env, jint off, jint len, jbyteArray <span class="built_in">array</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ((off &lt; <span class="number">0</span>) ||</span><br><span class="line">            (len &lt; <span class="number">0</span>) ||</span><br><span class="line">            <span class="comment">// We are very careful to avoid signed integer overflow,</span></span><br><span class="line">            <span class="comment">// the result of which is undefined in C.</span></span><br><span class="line">            ((*env)-&gt;GetArrayLength(env, <span class="built_in">array</span>) - off &lt; len));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jint</span><br><span class="line"><span class="title function_">readBytes</span><span class="params">(JNIEnv *env, jobject this, jbyteArray bytes,</span></span><br><span class="line"><span class="params">          jint off, jint len, jfieldID fid)</span></span><br><span class="line">&#123;</span><br><span class="line">    jint nread;</span><br><span class="line">    <span class="comment">// 在栈中申请的默认缓存空间</span></span><br><span class="line">    <span class="type">char</span> stackBuf[BUF_SIZE];</span><br><span class="line">    <span class="type">char</span> *buf = <span class="literal">NULL</span>;</span><br><span class="line">    FD fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IS_NULL(bytes)) &#123;</span><br><span class="line">        JNU_ThrowNullPointerException(env, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outOfBounds(env, off, len, bytes)) &#123;</span><br><span class="line">        JNU_ThrowByName(env, <span class="string">&quot;java/lang/IndexOutOfBoundsException&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据想要读取的字节数，申请对应大小的缓冲区</span></span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; BUF_SIZE) &#123;</span><br><span class="line">        <span class="comment">// 申请缓冲区内存</span></span><br><span class="line">        buf = <span class="built_in">malloc</span>(len);</span><br><span class="line">        <span class="keyword">if</span> (buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            JNU_ThrowOutOfMemoryError(env, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果需要读取的字节数小于默认缓存大小</span></span><br><span class="line">        <span class="comment">// 则使用栈缓存区</span></span><br><span class="line">        buf = stackBuf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取文件句柄</span></span><br><span class="line">    fd = GET_FD(this, fid);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">&quot;Stream Closed&quot;</span>);</span><br><span class="line">        nread = <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 也是调用IO_Read方法读取文件</span></span><br><span class="line">        nread = IO_Read(fd, buf, len);</span><br><span class="line">        <span class="keyword">if</span> (nread &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            (*env)-&gt;SetByteArrayRegion(env, bytes, off, nread, (jbyte *)buf);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">-1</span>) &#123;</span><br><span class="line">            JNU_ThrowIOExceptionWithLastError(env, <span class="string">&quot;Read error&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">/* EOF */</span></span><br><span class="line">            nread = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放缓冲区内存</span></span><br><span class="line">    <span class="keyword">if</span> (buf != stackBuf) &#123;</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util_md.h文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IO_Read handleRead</span></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util_md.c文件</span></span><br><span class="line">JNIEXPORT</span><br><span class="line">jint</span><br><span class="line"><span class="title function_">handleRead</span><span class="params">(FD fd, <span class="type">void</span> *buf, jint len)</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD read = <span class="number">0</span>;</span><br><span class="line">    BOOL result = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Windows上FileDescriptor就是Handle文件句柄</span></span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line">    <span class="keyword">if</span> (h == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用Windows API</span></span><br><span class="line">    result = ReadFile(h,          <span class="comment">/* File handle to read */</span></span><br><span class="line">                      buf,        <span class="comment">/* address to put data */</span></span><br><span class="line">                      len,        <span class="comment">/* number of bytes to read */</span></span><br><span class="line">                      &amp;read,      <span class="comment">/* number of bytes read */</span></span><br><span class="line">                      <span class="literal">NULL</span>);      <span class="comment">/* no overlapped struct */</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> error = GetLastError();</span><br><span class="line">        <span class="keyword">if</span> (error == ERROR_BROKEN_PIPE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* EOF */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (jint)read;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/EN-US/library/4ad4580d-c002-44a4-a5f6-757e83ed8732.aspx">点击这里</a>查看ReadFile的API文档</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BOOL WINAPI <span class="title function_">ReadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="comment">// 文件句柄</span></span></span><br><span class="line"><span class="params">  _In_        HANDLE       hFile,</span></span><br><span class="line"><span class="params">  <span class="comment">// 接收数据的字节缓冲区</span></span></span><br><span class="line"><span class="params">  _Out_       LPVOID       lpBuffer,</span></span><br><span class="line"><span class="params">  <span class="comment">// 读取数据的长度</span></span></span><br><span class="line"><span class="params">  _In_        DWORD        nNumberOfBytesToRead,</span></span><br><span class="line"><span class="params">  <span class="comment">// 接受数据读取的长度，当lpOverlapped参数不为NULL，该参数可以为NULL</span></span></span><br><span class="line"><span class="params">  _Out_opt_   LPDWORD      lpNumberOfBytesRead,</span></span><br><span class="line"><span class="params">  <span class="comment">// OVERLAPPED结构体指针，用于使用FILE_FLAG_OVERLAPPED标记打开的文件</span></span></span><br><span class="line"><span class="params">  _Inout_opt_ LPOVERLAPPED lpOverlapped</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><h3>write</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有的write方法最终都会调用这两个方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">write0</span><span class="params">(<span class="type">int</span> b)</span> <span class="keyword">throws</span> IOException; <span class="comment">// 写入一个字节</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">writeBytes</span><span class="params">(<span class="type">byte</span> b[], <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException; <span class="comment">// 写入多个字节</span></span><br></pre></td></tr></table></figure><p>Native层源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// RandomAccessFile.c文件</span></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_RandomAccessFile_write</span><span class="params">(JNIEnv *env, jobject this, jint byte)</span> &#123;</span><br><span class="line">    writeSingle(env, this, byte, JNI_FALSE, raf_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_RandomAccessFile_writeBytes</span><span class="params">(JNIEnv *env,</span></span><br><span class="line"><span class="params">    jobject this, jbyteArray bytes, jint off, jint len)</span> &#123;</span><br><span class="line">    writeBytes(env, this, bytes, off, len, JNI_FALSE, raf_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util.c文件</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">writeSingle</span><span class="params">(JNIEnv *env, jobject this, jint byte, jboolean append, jfieldID fid)</span> &#123;</span><br><span class="line">    <span class="comment">// Discard the 24 high-order bits of byte. See OutputStream#write(int)</span></span><br><span class="line">    <span class="comment">// 在OutputStream.write(int)方法中已经通过位运算处理了int的高24位字节</span></span><br><span class="line">    <span class="comment">// 所以这里可以直接强转</span></span><br><span class="line">    <span class="type">char</span> c = (<span class="type">char</span>) byte;</span><br><span class="line">    jint n;</span><br><span class="line">    <span class="comment">// 获取文件句柄(Windows)</span></span><br><span class="line">    FD fd = GET_FD(this, fid);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">&quot;Stream Closed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (append == JNI_TRUE) &#123;</span><br><span class="line">        <span class="comment">// 向后追加</span></span><br><span class="line">        n = IO_Append(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 覆盖写入</span></span><br><span class="line">        n = IO_Write(fd, &amp;c, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">&quot;Write error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">writeBytes</span><span class="params">(JNIEnv *env, jobject this, jbyteArray bytes,</span></span><br><span class="line"><span class="params">           jint off, jint len, jboolean append, jfieldID fid)</span></span><br><span class="line">&#123;</span><br><span class="line">    jint n;</span><br><span class="line">    <span class="comment">// 栈内存缓冲区</span></span><br><span class="line">    <span class="type">char</span> stackBuf[BUF_SIZE];</span><br><span class="line">    <span class="type">char</span> *buf = <span class="literal">NULL</span>;</span><br><span class="line">    FD fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IS_NULL(bytes)) &#123;</span><br><span class="line">        JNU_ThrowNullPointerException(env, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outOfBounds(env, off, len, bytes)) &#123;</span><br><span class="line">        JNU_ThrowByName(env, <span class="string">&quot;java/lang/IndexOutOfBoundsException&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; BUF_SIZE) &#123;</span><br><span class="line">        buf = <span class="built_in">malloc</span>(len);</span><br><span class="line">        <span class="keyword">if</span> (buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            JNU_ThrowOutOfMemoryError(env, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buf = stackBuf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java层字节数组，转成Native层字节数组</span></span><br><span class="line">    <span class="comment">// Java中数组是一个对象，对象头部有部分其他信息(比如数组的长度)</span></span><br><span class="line">    <span class="comment">// 不像C语言的字节数组那么单纯</span></span><br><span class="line">    (*env)-&gt;GetByteArrayRegion(env, bytes, off, len, (jbyte *)buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(*env)-&gt;ExceptionOccurred(env)) &#123;</span><br><span class="line">        off = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 这里要循环，IO_Append,IO_Write底层调用的WriteFile API</span></span><br><span class="line">        <span class="comment">// 不是让写多少就写多少</span></span><br><span class="line">        <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            fd = GET_FD(this, fid);</span><br><span class="line">            <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">                JNU_ThrowIOException(env, <span class="string">&quot;Stream Closed&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (append == JNI_TRUE) &#123;</span><br><span class="line">                <span class="comment">// 向后追加</span></span><br><span class="line">                n = IO_Append(fd, buf+off, len);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 覆盖写入</span></span><br><span class="line">                n = IO_Write(fd, buf+off, len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">                JNU_ThrowIOExceptionWithLastError(env, <span class="string">&quot;Write error&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 已写入n个字节</span></span><br><span class="line">            off += n;</span><br><span class="line">            len -= n;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放内存</span></span><br><span class="line">    <span class="keyword">if</span> (buf != stackBuf) &#123;</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util_md.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IO_Append handleAppend</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IO_Write handleWrite</span></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util_md.c</span></span><br><span class="line">jint <span class="title function_">handleWrite</span><span class="params">(FD fd, <span class="type">const</span> <span class="type">void</span> *buf, jint len)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> writeInternal(fd, buf, len, JNI_FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jint <span class="title function_">handleAppend</span><span class="params">(FD fd, <span class="type">const</span> <span class="type">void</span> *buf, jint len)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> writeInternal(fd, buf, len, JNI_TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> jint <span class="title function_">writeInternal</span><span class="params">(FD fd, <span class="type">const</span> <span class="type">void</span> *buf, jint len, jboolean append)</span></span><br><span class="line">&#123;</span><br><span class="line">    BOOL result = <span class="number">0</span>;</span><br><span class="line">    DWORD written = <span class="number">0</span>;</span><br><span class="line">    HANDLE h = (HANDLE)fd;<span class="comment">// Windows中文件句柄就是FileDescriptor</span></span><br><span class="line">    <span class="keyword">if</span> (h != INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        OVERLAPPED ov;</span><br><span class="line">        LPOVERLAPPED lpOv;</span><br><span class="line">        <span class="keyword">if</span> (append == JNI_TRUE) &#123;</span><br><span class="line">            <span class="comment">// 构造OVERLAPPED结构体</span></span><br><span class="line">            ov.Offset = (DWORD)<span class="number">0xFFFFFFFF</span>;</span><br><span class="line">            ov.OffsetHigh = (DWORD)<span class="number">0xFFFFFFFF</span>;</span><br><span class="line">            ov.hEvent = <span class="literal">NULL</span>;</span><br><span class="line">            lpOv = &amp;ov;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lpOv = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用Windows API</span></span><br><span class="line">        result = WriteFile(h,                <span class="comment">/* File handle to write */</span></span><br><span class="line">                           buf,              <span class="comment">/* pointers to the buffers */</span></span><br><span class="line">                           len,              <span class="comment">/* number of bytes to write */</span></span><br><span class="line">                           &amp;written,         <span class="comment">/* receives number of bytes written */</span></span><br><span class="line">                           lpOv);            <span class="comment">/* overlapped struct */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((h == INVALID_HANDLE_VALUE) || (result == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (jint)written;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/EN-US/library/9d6fa723-fe3e-4052-b0b3-2686eee076a7.aspx">点击这里</a>查看WriteFile的API文档</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BOOL WINAPI <span class="title function_">WriteFile</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="comment">// 文件句柄</span></span></span><br><span class="line"><span class="params">  _In_        HANDLE       hFile,</span></span><br><span class="line"><span class="params">  <span class="comment">// 要写入的字节数据</span></span></span><br><span class="line"><span class="params">  _In_        LPCVOID      lpBuffer,</span></span><br><span class="line"><span class="params">  <span class="comment">// 要写入多少数据</span></span></span><br><span class="line"><span class="params">  _In_        DWORD        nNumberOfBytesToWrite,</span></span><br><span class="line"><span class="params">  <span class="comment">// 实际写入了多少数据，作为返回值</span></span></span><br><span class="line"><span class="params">  _Out_opt_   LPDWORD      lpNumberOfBytesWritten,</span></span><br><span class="line"><span class="params">  <span class="comment">// OVERLAPPED结构体指针，对FILE_FLAG_OVERLAPPED方式打开的文件有效</span></span></span><br><span class="line"><span class="params">  _Inout_opt_ LPOVERLAPPED lpOverlapped</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><h3>seek</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">seek0</span><span class="params">(<span class="type">long</span> pos)</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure><p>Native层源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// RandomAccessFile.c文件</span></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_RandomAccessFile_seek0</span><span class="params">(JNIEnv *env,</span></span><br><span class="line"><span class="params">                    jobject this, jlong pos)</span> &#123;</span><br><span class="line"></span><br><span class="line">    FD fd;</span><br><span class="line"></span><br><span class="line">    fd = GET_FD(this, raf_fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">&quot;Stream Closed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; jlong_zero) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">&quot;Negative seek offset&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IO_Lseek(fd, pos, SEEK_SET) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// 调用IO_Lseek函数</span></span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">&quot;Seek failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util_md.h文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IO_Lseek handleLseek</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util_md.c文件</span></span><br><span class="line">jlong</span><br><span class="line"><span class="title function_">handleLseek</span><span class="params">(FD fd, jlong offset, jint whence)</span></span><br><span class="line">&#123;</span><br><span class="line">    LARGE_INTEGER pos, distance;</span><br><span class="line">    DWORD lowPos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> highPos = <span class="number">0</span>;</span><br><span class="line">    DWORD op = FILE_CURRENT;</span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (whence == SEEK_END) &#123;</span><br><span class="line">        op = FILE_END;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (whence == SEEK_CUR) &#123;</span><br><span class="line">        op = FILE_CURRENT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (whence == SEEK_SET) &#123;</span><br><span class="line">        op = FILE_BEGIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    distance.QuadPart = offset;</span><br><span class="line">    <span class="comment">// 调用SetFilePointerEx API</span></span><br><span class="line">    <span class="keyword">if</span> (SetFilePointerEx(h, distance, &amp;pos, op) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回移动后的位置</span></span><br><span class="line">    <span class="keyword">return</span> long_to_jlong(pos.QuadPart);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/EN-US/library/a6fdfa00-626d-425d-b00e-c174b19ea4b9.aspx">点击这里</a>查看SetFilePointEx的API文档</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">BOOL WINAPI <span class="title function_">SetFilePointerEx</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="comment">// 文件句柄</span></span></span><br><span class="line"><span class="params">  _In_      HANDLE         hFile,</span></span><br><span class="line"><span class="params">  <span class="comment">// 要移动的距离</span></span></span><br><span class="line"><span class="params">  _In_      LARGE_INTEGER  liDistanceToMove,</span></span><br><span class="line"><span class="params">  <span class="comment">// 移动后的文件指针位置</span></span></span><br><span class="line"><span class="params">  _Out_opt_ PLARGE_INTEGER lpNewFilePointer,</span></span><br><span class="line"><span class="params">  <span class="comment">// 移动的相对起点：</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_BEGIN 文件开头</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_END 文件结尾</span></span></span><br><span class="line"><span class="params">  <span class="comment">// FILE_CURRENT 当前位置</span></span></span><br><span class="line"><span class="params">  _In_      DWORD          dwMoveMethod</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><h3>getFilePointer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">getFilePointer</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure><p>Native层源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jlong JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_RandomAccessFile_getFilePointer</span><span class="params">(JNIEnv *env, jobject this)</span> &#123;</span><br><span class="line">    FD fd;</span><br><span class="line">    jlong ret;</span><br><span class="line"></span><br><span class="line">    fd = GET_FD(this, raf_fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException(env, <span class="string">&quot;Stream Closed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 仍然是调用IO_Lseek方法，但是最后参数(相对位置),设置为当前位置</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = IO_Lseek(fd, <span class="number">0L</span>, SEEK_CUR)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">&quot;Seek failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RandomAccessFile类最终调用的是Windows的四个API：OpenFile，ReadFile，WriteFile，GetFilePointer</p><h2>FileInputStream和FileOutputStream</h2><p>FileInputStream和FileOutputStream与C++的STL中的文件流API类似：面向对象，RandomAccessFile仅仅以面向对象方式封装了文件读写。Java的文件流功能上肯定不如C++，要知道C++的运算符重载，模板类等语言特性让C++的文件操作简单了很多(相反调试也变得更加困难)。</p><p>C++中<code>std::basic_ifstream</code>代表了文件输入流，<code>std::basic_ofstream</code>代表了文件输出流，又因为C++有多继承的特性所以还有一个<code>std::basic_fstream</code>融合了前两者的功能(实际上并非继承自前两个类而是继承自basic_iostream类)。</p><p><img src="http://img-blog.csdn.net/20170820162211680?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSG9sbW9meQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" rel="external noreferrer nofollow noopener" referrerpolicy="no-referrer" alt="C++中的IO流"></p><p>不过C++虽好，但Java的native实现仍使用C语言(实际上Java API几乎都是C语言实现，而JVM的实现Hotspot才使用到了C++)。</p><p>事实上FileInputStream和FileOutputStream的实现和RandomAccessFile几近一致：</p><h3>FileInputStream的native方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">open0</span><span class="params">(String name)</span> <span class="keyword">throws</span> FileNotFoundException;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">read0</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">readBytes</span><span class="params">(<span class="type">byte</span> b[], <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">skip</span><span class="params">(<span class="type">long</span> n)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">available</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure><p>Native层源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT <span class="type">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_FileInputStream_open</span><span class="params">(JNIEnv *env, jobject this, jstring path)</span> &#123;</span><br><span class="line">    <span class="comment">// fileOpen，这和RandomAccessFile打开文件调用同一个函数</span></span><br><span class="line">    fileOpen(env, this, path, fis_fd, O_RDONLY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_FileInputStream_read</span><span class="params">(JNIEnv *env, jobject this)</span> &#123;</span><br><span class="line">    <span class="comment">// readSingle，读取单个字节</span></span><br><span class="line">    <span class="keyword">return</span> readSingle(env, this, fis_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_FileInputStream_readBytes</span><span class="params">(JNIEnv *env, jobject this,</span></span><br><span class="line"><span class="params">        jbyteArray bytes, jint off, jint len)</span> &#123;</span><br><span class="line">    <span class="comment">// readBytes，读取多个字节</span></span><br><span class="line">    <span class="keyword">return</span> readBytes(env, this, bytes, off, len, fis_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jlong JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_FileInputStream_skip</span><span class="params">(JNIEnv *env, jobject this, jlong toSkip)</span> &#123;</span><br><span class="line">    jlong cur = jlong_zero;</span><br><span class="line">    jlong end = jlong_zero;</span><br><span class="line">    FD fd = GET_FD(this, fis_fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException (env, <span class="string">&quot;Stream Closed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// IO_Lseek函数，和RandomAccessFile的seek方法实现类似</span></span><br><span class="line">    <span class="keyword">if</span> ((cur = IO_Lseek(fd, (jlong)<span class="number">0</span>, (jint)SEEK_CUR)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">&quot;Seek error&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((end = IO_Lseek(fd, toSkip, (jint)SEEK_CUR)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">&quot;Seek error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (end - cur);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_FileInputStream_available</span><span class="params">(JNIEnv *env, jobject this)</span> &#123;</span><br><span class="line">    jlong ret;</span><br><span class="line">    FD fd = GET_FD(this, fis_fd);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        JNU_ThrowIOException (env, <span class="string">&quot;Stream Closed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 唯一出了点新花样的可能就是这个IO_Available函数</span></span><br><span class="line">    <span class="keyword">if</span> (IO_Available(fd, &amp;ret)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ret &gt; INT_MAX) &#123;</span><br><span class="line">            ret = (jlong) INT_MAX;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ret = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jlong_to_jint(ret);</span><br><span class="line">    &#125;</span><br><span class="line">    JNU_ThrowIOExceptionWithLastError(env, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// io_util_md.h文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IO_Available handleAvailable</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">handleAvailable</span><span class="params">(FD fd, jlong *pbytes)</span> &#123;</span><br><span class="line">    HANDLE h = (HANDLE)fd;</span><br><span class="line">    DWORD type = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取文件类型，调用Windows API</span></span><br><span class="line">    type = GetFileType(h);</span><br><span class="line">    <span class="comment">/* Handle is for keyboard or pipe */</span></span><br><span class="line">    <span class="keyword">if</span> (type == FILE_TYPE_CHAR || type == FILE_TYPE_PIPE) &#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="type">long</span> lpbytes;</span><br><span class="line">        <span class="comment">// 获取标准输入流</span></span><br><span class="line">        HANDLE stdInHandle = GetStdHandle(STD_INPUT_HANDLE);</span><br><span class="line">        <span class="keyword">if</span> (stdInHandle == h) &#123;</span><br><span class="line">            ret = handleStdinAvailable(fd, &amp;lpbytes); <span class="comment">/* keyboard */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ret = handleNonSeekAvailable(fd, &amp;lpbytes); <span class="comment">/* pipe */</span></span><br><span class="line">        &#125;</span><br><span class="line">        (*pbytes) = (jlong)(lpbytes);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Handle is for regular file */</span></span><br><span class="line">    <span class="keyword">if</span> (type == FILE_TYPE_DISK) &#123;</span><br><span class="line">        jlong current, end;</span><br><span class="line"></span><br><span class="line">        LARGE_INTEGER filesize;</span><br><span class="line">        current = handleLseek(fd, <span class="number">0</span>, SEEK_CUR);</span><br><span class="line">        <span class="keyword">if</span> (current &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用Windows API获取文件大小</span></span><br><span class="line">        <span class="keyword">if</span> (GetFileSizeEx(h, &amp;filesize) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        end = long_to_jlong(filesize.QuadPart);</span><br><span class="line">        *pbytes = end - current;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/EN-US/library/windows/desktop/aa364960.aspx">GetFileType</a>和<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/EN-US/library/windows/desktop/aa364957.aspx">GetFileSizeEx</a>的API文档</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FILE_TYPE_CHAR  字符文件，典型的如：打印设备或控制台</span></span><br><span class="line"><span class="comment">// FILE_TYPE_DISK  磁盘文件</span></span><br><span class="line"><span class="comment">// FILE_TYPE_PIPE  管道文件，如Socket，命名管道，匿名管道</span></span><br><span class="line"><span class="comment">// FILE_TYPE_REMOTE 未使用</span></span><br><span class="line"><span class="comment">// FILE_TYPE_UNKNOWN  未知设备，或者函数调用出错</span></span><br><span class="line">DWORD WINAPI <span class="title function_">GetFileType</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="comment">// 文件句柄</span></span></span><br><span class="line"><span class="params">  _In_ HANDLE hFile</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line">BOOL WINAPI <span class="title function_">GetFileSizeEx</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="comment">// 文件句柄</span></span></span><br><span class="line"><span class="params">  _In_  HANDLE         hFile,</span></span><br><span class="line"><span class="params">  <span class="comment">// 接收文件大小的长整型指针</span></span></span><br><span class="line"><span class="params">  _Out_ PLARGE_INTEGER lpFileSize</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><h3>FileOutputStream的native方法</h3><p>FileOutputStream的native实现就更简单了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">open0</span><span class="params">(String name, <span class="type">boolean</span> append)</span> <span class="keyword">throws</span> FileNotFoundException;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> b, <span class="type">boolean</span> append)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">writeBytes</span><span class="params">(<span class="type">byte</span> b[], <span class="type">int</span> off, <span class="type">int</span> len, <span class="type">boolean</span> append)</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure><p>Native源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT <span class="type">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_FileOutputStream_open</span><span class="params">(JNIEnv *env, jobject this,</span></span><br><span class="line"><span class="params">                                   jstring path, jboolean append)</span> &#123;</span><br><span class="line">    <span class="comment">// fileOpen:打开文件</span></span><br><span class="line">    fileOpen(env, this, path, fos_fd,</span><br><span class="line">             O_WRONLY | O_CREAT | (append ? O_APPEND : O_TRUNC));</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_FileOutputStream_write</span><span class="params">(JNIEnv *env, jobject this, jint byte, jboolean append)</span> &#123;</span><br><span class="line">    <span class="comment">// writeSingle:写入单个字节</span></span><br><span class="line">    writeSingle(env, this, byte, append, fos_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL</span><br><span class="line"><span class="title function_">Java_java_io_FileOutputStream_writeBytes</span><span class="params">(JNIEnv *env,</span></span><br><span class="line"><span class="params">    jobject this, jbyteArray bytes, jint off, jint len, jboolean append)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// writeBytes:写入多个字节</span></span><br><span class="line">    writeBytes(env, this, bytes, off, len, append, fos_fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-copyright"><p>本作品采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a> 进行许可。</p><p>转载时请注明<a href="https://blog.hufeifei.cn/2017/08/Java/JavaIO%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8WindowsAPI%E7%9A%84/">原文链接</a>：https://blog.hufeifei.cn/2017/08/Java/JavaIO%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8WindowsAPI%E7%9A%84/</p></div><footer class="article-footer"></footer></div><div id="article-reward"><i class="iconfont ic-money"></i><div>鼓励一下</div><table><thead><tr><th style="text-align:center">支付宝</th><th style="text-align:center">微信</th></tr></thead><tbody><tr><td style="text-align:center"><img width="150" src="https://www.hufeifei.cn/reward-img/alipay.jpg"></td><td style="text-align:center"><img width="135" src="https://www.hufeifei.cn/reward-img/wechat.jpg"></td></tr></tbody></table></div><nav id="article-nav"><a class="article-nav-link-wrap" href="/2017/08/Windows/LocalDB%E7%9A%84%E4%BD%BF%E7%94%A8/" id="article-nav-newer"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">LocalDB使用详解</div></a><a class="article-nav-link-wrap" href="/2017/08/WebFront/%E5%B0%86Sublime%E6%89%93%E9%80%A0%E6%88%90%E8%B6%85%E5%BC%BA%E5%89%8D%E7%AB%AFIDE/" id="article-nav-older"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">将Sublime打造成超强前端IDE</div></a></nav></article><div id="waline-comments"></div><script type="module">import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';init({"el":"#waline-comments","pageview":true,"enable":true,"serverURL":"https://api.waline.blog.hufeifei.cn","avatar":"mp","pageSize":10,"lang":"zh-cn","placeholder":"Just go go","visitor":true,"recordIP":true,"requiredFields":["nick"]});</script></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">关注微信公众号</h3><div class="widget wechat"><img src="//www.hufeifei.cn/wechat-public-account.jpg"></div></div><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C&C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/J2EE/">J2EE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux%E8%BF%90%E7%BB%B4/">Linux运维</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/">Ruby</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Rust/">Rust</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E6%97%A5%E5%B8%B8/">代码日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%95%86%E4%B8%9A/">商业</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E6%B5%8E%E4%B8%8E%E9%87%91%E8%9E%8D/">经济与金融</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/">计算机组成</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/AVL/" style="font-size:11.11px">AVL</a> <a href="/tags/Alibaba/" style="font-size:14.44px">Alibaba</a> <a href="/tags/Android/" style="font-size:18.89px">Android</a> <a href="/tags/B-Tree/" style="font-size:12.22px">B-Tree</a> <a href="/tags/BKD-Tree/" style="font-size:10px">BKD-Tree</a> <a href="/tags/BST/" style="font-size:10px">BST</a> <a href="/tags/BigData/" style="font-size:11.11px">BigData</a> <a href="/tags/C/" style="font-size:14.44px">C</a> <a href="/tags/CGlib/" style="font-size:10px">CGlib</a> <a href="/tags/CS/" style="font-size:11.11px">CS</a> <a href="/tags/Canal/" style="font-size:10px">Canal</a> <a href="/tags/ClassLoader/" style="font-size:10px">ClassLoader</a> <a href="/tags/ClickHouse/" style="font-size:10px">ClickHouse</a> <a href="/tags/Config/" style="font-size:10px">Config</a> <a href="/tags/Cryptography/" style="font-size:10px">Cryptography</a> <a href="/tags/DB/" style="font-size:20px">DB</a> <a href="/tags/Dapper/" style="font-size:10px">Dapper</a> <a href="/tags/DataStructure/" style="font-size:14.44px">DataStructure</a> <a href="/tags/Debezium/" style="font-size:10px">Debezium</a> <a href="/tags/Diamond/" style="font-size:10px">Diamond</a> <a href="/tags/Distributed/" style="font-size:13.33px">Distributed</a> <a href="/tags/ElasticSearch/" style="font-size:10px">ElasticSearch</a> <a href="/tags/Encoding/" style="font-size:10px">Encoding</a> <a href="/tags/FastJson/" style="font-size:10px">FastJson</a> <a href="/tags/File/" style="font-size:10px">File</a> <a href="/tags/FlowMarketing/" style="font-size:10px">FlowMarketing</a> <a href="/tags/Grade/" style="font-size:10px">Grade</a> <a href="/tags/Gson/" style="font-size:10px">Gson</a> <a href="/tags/HTTP/" style="font-size:10px">HTTP</a> <a href="/tags/Handler/" style="font-size:10px">Handler</a> <a href="/tags/Hanlder/" style="font-size:10px">Hanlder</a> <a href="/tags/Hessian/" style="font-size:10px">Hessian</a> <a href="/tags/IO-Multiplex/" style="font-size:10px">IO-Multiplex</a> <a href="/tags/JAVA/" style="font-size:18.89px">JAVA</a> <a href="/tags/JVM/" style="font-size:10px">JVM</a> <a href="/tags/KD-Tree/" style="font-size:10px">KD-Tree</a> <a href="/tags/KDB-Tree/" style="font-size:10px">KDB-Tree</a> <a href="/tags/Kafka/" style="font-size:10px">Kafka</a> <a href="/tags/Kubernetes/" style="font-size:10px">Kubernetes</a> <a href="/tags/LSM-Tree/" style="font-size:11.11px">LSM-Tree</a> <a href="/tags/Linux/" style="font-size:17.78px">Linux</a> <a href="/tags/Lock/" style="font-size:11.11px">Lock</a> <a href="/tags/Lucene/" style="font-size:10px">Lucene</a> <a href="/tags/MQ/" style="font-size:10px">MQ</a> <a href="/tags/Macro/" style="font-size:10px">Macro</a> <a href="/tags/Magisk/" style="font-size:10px">Magisk</a> <a href="/tags/MultiDex/" style="font-size:10px">MultiDex</a> <a href="/tags/MySQL/" style="font-size:17.78px">MySQL</a> <a href="/tags/NIO/" style="font-size:10px">NIO</a> <a href="/tags/Nginx/" style="font-size:11.11px">Nginx</a> <a href="/tags/OGNL/" style="font-size:10px">OGNL</a> <a href="/tags/OpenResty/" style="font-size:10px">OpenResty</a> <a href="/tags/OpenTelemetry/" style="font-size:10px">OpenTelemetry</a> <a href="/tags/Oracle/" style="font-size:10px">Oracle</a> <a href="/tags/PostgreSQL/" style="font-size:10px">PostgreSQL</a> <a href="/tags/RB-Tree/" style="font-size:10px">RB-Tree</a> <a href="/tags/Redis/" style="font-size:10px">Redis</a> <a href="/tags/Rust/" style="font-size:10px">Rust</a> <a href="/tags/Sharding/" style="font-size:10px">Sharding</a> <a href="/tags/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size:10px">SpringCloud</a> <a href="/tags/SpringCloudConfig/" style="font-size:10px">SpringCloudConfig</a> <a href="/tags/Sqlite/" style="font-size:10px">Sqlite</a> <a href="/tags/SurfaceView/" style="font-size:10px">SurfaceView</a> <a href="/tags/VSCode/" style="font-size:11.11px">VSCode</a> <a href="/tags/WebFlux/" style="font-size:10px">WebFlux</a> <a href="/tags/WebPush/" style="font-size:10px">WebPush</a> <a href="/tags/Web%E6%8C%96%E6%8E%98/" style="font-size:11.11px">Web挖掘</a> <a href="/tags/awk/" style="font-size:10px">awk</a> <a href="/tags/bit-hack/" style="font-size:10px">bit-hack</a> <a href="/tags/cheat-sheet/" style="font-size:10px">cheat sheet</a> <a href="/tags/curl/" style="font-size:10px">curl</a> <a href="/tags/epoll/" style="font-size:10px">epoll</a> <a href="/tags/gRPC/" style="font-size:10px">gRPC</a> <a href="/tags/grep/" style="font-size:10px">grep</a> <a href="/tags/kqueue/" style="font-size:10px">kqueue</a> <a href="/tags/libev/" style="font-size:10px">libev</a> <a href="/tags/libevent/" style="font-size:10px">libevent</a> <a href="/tags/libuv/" style="font-size:10px">libuv</a> <a href="/tags/metaq/" style="font-size:10px">metaq</a> <a href="/tags/poll/" style="font-size:10px">poll</a> <a href="/tags/sed/" style="font-size:10px">sed</a> <a href="/tags/select/" style="font-size:10px">select</a> <a href="/tags/ssh/" style="font-size:10px">ssh</a> <a href="/tags/%E5%8E%86%E5%8F%B2/" style="font-size:10px">历史</a> <a href="/tags/%E5%95%86%E4%B8%9A/" style="font-size:10px">商业</a> <a href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size:10px">心理学</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size:11.11px">生活</a> <a href="/tags/%E7%A8%8E%E6%94%B6/" style="font-size:10px">税收</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:14.44px">算法</a> <a href="/tags/%E7%BB%8F%E6%B5%8E/" style="font-size:15.56px">经济</a> <a href="/tags/%E8%90%A5%E9%94%80/" style="font-size:10px">营销</a> <a href="/tags/%E8%B4%A7%E5%B8%81/" style="font-size:10px">货币</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size:16.67px">随笔</a></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/04/economic/value-added-tax/">增值税与贫富差距</a></li><li><a href="/2024/01/Net/x-forward-for/">“真”的IP真的是真的吗？</a></li><li><a href="/2024/01/paper/MarkupLM-web-extract/">【译】基于MarkupLM的web数据抽取</a></li><li><a href="/2023/09/economic/tax-reform/">直接税改革——王朝周期律的胜负手</a></li><li><a href="/2023/09/Rust/macro-rules-learning/">Rust中的宏</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">网站运营不易</h3><div class="ads-wrapper"><div class="google_ads"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7111912103882824" data-ad-slot="8429272980" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></aside></div><footer id="footer"><div class="outer"><div class="inner" id="footer-info"><p><a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备17009276号</a><i class="far fa-copyright"></i>2016 ~ 2024 胡飞飞</p><p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><i class="fas fa-angle-right"></i>Theme by <a target="_blank" rel="noopener" href="https://github.com/holmofy/hexo-theme-paper">paper</a></p></div></div></footer></div><nav id="mobile-nav"><a class="mobile-nav-link" href="//www.hufeifei.cn">主页</a><a class="mobile-nav-link" href="/">博客</a><a class="mobile-nav-link" href="/archives">归档</a><a class="mobile-nav-link" target="_blank" rel="noopener" href="//algo.hufeifei.cn">算法</a><a class="mobile-nav-link" href="/book">书籍</a><a class="mobile-nav-link" href="/github">Github</a></nav><script src="//cdnjs.loli.net/ajax/libs/jquery/3.0.0/jquery.min.js"></script><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/script.js"></script></div><script>
  $(document).ready(function() {
    $('figure.codeblock').find('.tab').click(function() {
        var $codeblock = $(this).parent().parent().parent();
        var $tab = $(this);
        // remove "active" css class on all tabs
        $tab.siblings().removeClass('active');
        // add "active" css class on the clicked tab
        $tab.addClass('active');
        // hide all tab contents
        $codeblock.find('.highlight').hide();
        // show only the right one
        $codeblock.find('.highlight.' + $tab.text()).show();
    });
  });
  </script><script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'BPJzNs1QEtbYa3Bn0gMAQHBAzX3Jm71llGUKHTkKEUs3D9xiDYZ0DWJ3S9sfCAAJHxXEoBkUANFyONjeIlgrJUo'' });</script></body></html>