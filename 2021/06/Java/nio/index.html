<!doctype html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-H58NSPXYPF"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-H58NSPXYPF")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?b3392fb5f6d65fb10354f590338d1ee4",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(t,e,n,c,a,i){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/95vxjpui4h",(i=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,i)}(window,document,"clarity","script")</script><title>深入浅出NIO | holmofy</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="baidu_union_verify" content="b7d27ec946758934fcdf3c5c26386237"><meta description="[TOC] 计算机存储体系结构"><meta property="og:type" content="article"><meta property="og:title" content="深入浅出NIO"><meta property="og:url" content="https://blog.hufeifei.cn/2021/06/Java/nio/index.html"><meta property="og:site_name" content="holmofy"><link rel="canonical" href="https://blog.hufeifei.cn/2021/06/Java/nio/index.html"><meta property="description" content="[TOC] 计算机存储体系结构"><meta name="description" content="[TOC] 计算机存储体系结构"><meta property="og:description" content="[TOC] 计算机存储体系结构"><meta property="article:published_time" content="2021-06-12T16:00:00.000Z"><meta property="article:modified_time" content="2024-05-03T05:17:06.699Z"><meta property="article:author" content="胡飞飞"><meta property="article:tag" content="Java"><meta property="article:tag" content="NIO"><meta property="article:tag" content="IO多路复用"><meta property="keywords" content="Java,NIO,IO多路复用"><meta property="twitter:card" content="summary"><script data-ad-client="ca-pub-7111912103882824" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7111912103882824" crossorigin="anonymous"></script><script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script><script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async defer></script><link rel="alternate" href="/atom.xml" title="holmofy" type="application/atom+xml"><link rel="icon" href="//www.hufeifei.cn/favicon.jpg"><link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"><link href="//unpkg.com/@waline/client@v3/dist/waline.css" rel="stylesheet" type="text/css"><link href="//at.alicdn.com/t/font_841402_efkj8jo1xld.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/font-awesome/5.15.3/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/style.css"><link rel="dns-prefetch" href="//static.zhimg.com"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdn.jsdelivr.net"><link rel="dns-prefetch" href="//img-blog.csdn.net"><link rel="dns-prefetch" href="//img-blog.csdnimg.cn"><meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><style>
    figure.codeblock {
       margin: 0;
    }
    figure figcaption .tabs {
      display: flex;
      margin: 0;
    }
    figure figcaption .tabs .tab {
      cursor: pointer;
      list-style: none;
      padding: 5px 15px;
    }
    figure figcaption .tabs .tab.active {
      background: #2d2d2d;
      color: white;
    }
  </style></head><body><amp-auto-ads type="adsense" data-ad-client="ca-pub-7111912103882824"></amp-auto-ads><div id="container"><div id="wrap"><header id="header"><div class="outer" id="header-outer"><div class="inner" id="header-inner"><nav id="main-nav"><a class="nav-icon" id="main-nav-toggle"><i class="fas fa-bars"></i></a><a class="main-nav-link" href="//www.hufeifei.cn">主页</a><a class="main-nav-link" href="/">博客</a><a class="main-nav-link" href="/archives">归档</a><a class="main-nav-link" target="_blank" rel="noopener" href="//algo.hufeifei.cn">算法</a><a class="main-nav-link" href="/book">书籍</a><a class="main-nav-link" href="/github">Github</a></nav><nav id="sub-nav"><a class="nav-icon" id="nav-rss-link" href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a><a class="nav-icon" id="nav-search-btn" title="Search"><i class="fas fa-search"></i></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="fas fa-search"></i></button><input type="hidden" name="sitesearch" value="https://blog.hufeifei.cn"></form></div></div></div></header><div class="outer"><section id="main"><article class="article article-type-post" id="post-Java/nio" itemscope itemprop="blogPost"><div class="article-meta"><a class="article-date" href="/2021/06/Java/nio/"><time datetime="2021-06-12T16:00:00.000Z" itemprop="datePublished">2021-06-13</time></a><div class="article-category"><a class="article-category-link" href="/categories/JAVA/">JAVA</a></div><div class="article-views leancloud_visitors" id="/2021/06/Java/nio/" data-flag-title="深入浅出NIO" title="Views"><i class="fas fa-eye"></i><span class="waline-pageview-count" data-path="/2021/06/Java/nio/"></span></div></div><div class="article-inner"><header class="article-header" style="text-align:center"><h1 class="article-title" itemprop="name">深入浅出NIO</h1></header><div class="article-entry" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>[TOC]</p><h2>计算机存储体系结构</h2><p><img src="https://media.geeksforgeeks.org/wp-content/uploads/Untitled-drawing-4-4.png"></p><p>《计算机组成原理》里都学过计算机的存储结构，从CPU -&gt; Cache -&gt; Memory -&gt; Disk 速度逐层递减，容量逐层增大。这主要是由于上层的CPU、Cache的制作成本高昂导致。</p><p>早期的计算机架构以南北桥<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://baike.baidu.com/item/%E5%8D%97%E5%8C%97%E6%A1%A5 南北桥
">[1]</span></a></sup>架构为主，由于南北桥之前传输速率之差逐渐成为整体性能发挥的瓶颈，南北桥架构也就被淘汰了。</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Chipset_schematic.svg"></p><p>北桥被集成到CPU芯片内<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Northbridge_%28computing%29 Northbridge
">[2]</span></a></sup>，南桥<sup id="fnref:3"><a href="#fn:3" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Northbridge_%28computing%29 Southbridge
">[3]</span></a></sup>与其他的I/O功能逐渐演变成PCH(Platform Controller Hub<sup id="fnref:4"><a href="#fn:4" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Platform_Controller_Hub Platform Controller Hub
">[4]</span></a></sup>)</p><h2>从PIO到DMA的演进</h2><p><img src="https://p.pstatp.com/origin/pgc-image/0a311e96901443baadb8231669979dce" rel="external noreferrer nofollow noopener" referrerpolicy="no-referrer"></p><p>最早的内存与外围I/O设备的数据传输方式是Programmed input–output(PIO<sup id="fnref:5"><a href="#fn:5" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Programmed_input%E2%80%93output Programmed input–output
">[5]</span></a></sup>)，它的过程是这样的：</p><ul><li>CPU 请求 I/O 操作；</li><li>I/O 模块执行操作；</li><li>I/O 模块设置状态位；</li><li>CPU 定期检查状态位；</li></ul><p>I/O 模块不直接通知 CPU，CPU 可能会等待或稍后返回，在编程下的 I/O 数据传输在CPU视角下非常像内存访问，I/O设备也有自己的地址<sup id="fnref:6"><a href="#fn:6" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Input/output_base_address Input/output base address
">[6]</span></a></sup>，所以它也被叫做<strong>Memory-mapped I/O</strong> (<strong>MMIO</strong>)<sup id="fnref:7"><a href="#fn:7" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Memory-mapped_I/O Memory-mapped I/O
">[7]</span></a></sup>（注意：和后面讲的mmap要区分开）。</p><p>这种方式严重浪费CPU的时间，所以衍生了中断I/O<sup id="fnref:8"><a href="#fn:8" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Interrupt Interrupt
">[8]</span></a></sup>：</p><ul><li>CPU 发出读命令</li><li>I/O 模块从外设准备数据，而 CPU 做其他工作</li><li>I/O 模块中断 CPU</li><li>CPU读取数据</li></ul><p>中断I/O基于CPU专门为IO设计的一类特殊指令，例如x86的in<sup id="fnref:9"><a href="#fn:9" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://c9x.me/x86/html/file_module_x86_id_139.html x86 in Instruction
">[9]</span></a></sup>和out<sup id="fnref:10"><a href="#fn:10" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://c9x.me/x86/html/file_module_x86_id_222.html x86 out Instruction
">[10]</span></a></sup>指令，这种基于IO端口指令的中断I/O也被叫做<strong>port-mapped I/O</strong> (<strong>PMIO</strong>)。</p><blockquote><p>这里可以看<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15371953/memory-mapped-i-o-vs-port-mapped-i-o">MMIO vs. PMIO相关讨论</a></p></blockquote><p><img src="https://pic2.zhimg.com/80/v2-2ad2ec819e69e106d44704fab3c141b1_1440w.jpg"></p><p>这两种模式都依赖CPU传输，传输过程中CPU不能做其他事情，随着网卡和磁盘等I/O设备需要传输的数据量越来越多，用CPU搬运肯定是忙不过来的。于是计算机科学家们设计了Direct Memory Access（DMA<sup id="fnref:11"><a href="#fn:11" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Direct_memory_access Direct memory access">[11]</span></a></sup>）来专门负责I/O设备与内存之间的拷贝。</p><p>什么是 DMA 技术？简单理解就是，<strong>在进行 I/O 设备和内存的数据传输的时候，数据搬运的工作全部交给 DMA 控制器，而 CPU 不再参与任何与数据搬运相关的事情，这样 CPU 就可以去处理别的事务</strong>。<strong>DMA控制器就类似于一个小的CPU, 有自己的寄存器（记录主存地址和取到的字的count等）</strong>。</p><p><img src="https://pic1.zhimg.com/80/v2-282ecfe51a18f00918f02f02bdf20950_1440w.jpg"></p><h2>用户态与内核态</h2><p>Intel x86系列的第一个CPU 8086<sup id="fnref:12"><a href="#fn:12" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Intel_8086 Intel 8086
">[12]</span></a></sup>可以寻址1MB的内存(对应着20根地址总线<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align:-.186ex" xmlns="http://www.w3.org/2000/svg" width="11.162ex" height="2.072ex" role="img" focusable="false" viewBox="0 -833.9 4933.7 915.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1567.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(2623.7,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(3123.7,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mi" transform="translate(4174.7,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container>)，由于CPU寄存器是16位的，所以8086使用段寄存器和指针寄存器分段<sup id="fnref:13"><a href="#fn:13" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/X86_memory_segmentation X86 memory segmentation
">[13]</span></a></sup>式访问内存，用户程序和操作系统没有很明确的界限，都可以访问整个内存；用户程序退出就会到操作系统；用户程序触发软中断就到操作系统，中断处理结束又回到用户程序；用户程序自己可以访问大部分的硬件设备；用户程序甚至可以随意修改属于操作系统的数据。<strong>用户程序的权限过大了，会导致五花八门的问题。</strong></p><p>Intel在80286<sup id="fnref:14"><a href="#fn:14" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Intel_80286 Intel 80286
">[14]</span></a></sup>地址总线变成了24根，可以寻址16MB，但是寄存器仍然是16位的，为了解决内存访问问题，Intel引入了保护模式<sup id="fnref:15"><a href="#fn:15" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Protected_mode Protected Mode
">[15]</span></a></sup>。<strong>保护模式下，内存使用分页方式访问</strong><sup id="fnref:16"><a href="#fn:16" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Memory_paging Memory Paging
">[16]</span></a></sup>，操作系统通过维护一张页表<sup id="fnref:17"><a href="#fn:17" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Page_table Page Table
">[17]</span></a></sup>来翻译用户真实的物理内存地址。这种方式能有效地防止用户程序的内存访问冲突，同时操作系统通过页面置换算法<sup id="fnref:18"><a href="#fn:18" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Page_replacement_algorithm Page replacement algorithm
">[18]</span></a></sup>将物理内存置换到磁盘等外部设备，页面置换算法能将内存分配给最需要的程序，而且对于所有程序来说它们都拥有一个超大的虚拟内存<sup id="fnref:19"><a href="#fn:19" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Virtual_memory Virtual Memory
">[19]</span></a></sup>。有了保护模式后为了兼容老的8086，将原来内存分段访问方式称为实模式（或者叫实地址模式）<sup id="fnref:20"><a href="#fn:20" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Real_mode Real Mode
">[20]</span></a></sup>，CPU由BIOS启动后默认进入实模式，引导程序<sup id="fnref:21"><a href="#fn:21" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Bootloader BootLoader
">[21]</span></a></sup>切换到实模式后开始加载操作系统。</p><p>操作系统上跑了应用程序，应用程序的访问权限应该受到限制，它不能任意访问计算机上的各种设备。但是<strong>CPU要怎么区分当前在执行指令的程序到底是操作系统还是用户程序呢</strong>？大多数CPU都提供了至少两种权限级别。</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Priv_rings.svg" alt="protected ring"></p><p>比如Intel的x86有这几种管理级别<sup id="fnref:23"><a href="#fn:23" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Protection_ring#IOPL Privilege level
">[23]</span></a></sup>：ring1权限是硬件虚拟化模式(<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/VT-x">VT-x</a> 和 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Secure_Virtual_Machine">SVM</a>)，ring2是系统管理模式<sup id="fnref:23"><a href="#fn:23" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Protection_ring#IOPL Privilege level
">[23]</span></a></sup>，ring3是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Intel_Management_Engine">Intel Management Engine</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/AMD_Platform_Security_Processor">AMD Platform Security Processor</a>。</p><p>用户的代码必须执行系统调用<sup id="fnref:24"><a href="#fn:24" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/System_call System Call
">[24]</span></a></sup>切换到内核模式，由操作系统的可信任代码执行I/O等一系列任务后将执行结果返回给用户空间。</p><p>简单点说，<strong>就是用户程序中的代码只能在用户模式下执行，要执行I/O等操作必须调用系统函数交由内核去执行，内核可以将CPU切换到更高权限的访问级别，访问完成结果由内核返回给用户程序</strong>。</p><h2>I/O读写的演进</h2><p>执行I/O很显然要调用操作系统的接口，而Linux上I/O接口已经经过了很多轮演进</p><h3>Buffer I/O</h3><p>最典型的就是以<code>read</code>/ <code>write</code>为代表的传统Buffer I/O。</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li><li class="tab">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">pread</span><span class="params">(<span class="type">int</span> d, <span class="type">void</span> *buf, <span class="type">size_t</span> nbyte, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fildes, <span class="type">void</span> *buf, <span class="type">size_t</span> nbyte)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">pwrite</span><span class="params">(<span class="type">int</span> fildes, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> nbyte, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fildes, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> nbyte)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recv</span><span class="params">(<span class="type">int</span> socket, <span class="type">void</span> *buffer, <span class="type">size_t</span> length, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvfrom</span><span class="params">(<span class="type">int</span> socket, <span class="type">void</span> *<span class="keyword">restrict</span> buffer, <span class="type">size_t</span> length, <span class="type">int</span> flags, <span class="keyword">struct</span> sockaddr *<span class="keyword">restrict</span> address, <span class="type">socklen_t</span> *<span class="keyword">restrict</span> address_len)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvmsg</span><span class="params">(<span class="type">int</span> socket, <span class="keyword">struct</span> msghdr *message, <span class="type">int</span> flags)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">send</span><span class="params">(<span class="type">int</span> socket, <span class="type">const</span> <span class="type">void</span> *buffer, <span class="type">size_t</span> length, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendmsg</span><span class="params">(<span class="type">int</span> socket, <span class="type">const</span> <span class="keyword">struct</span> msghdr *message, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendto</span><span class="params">(<span class="type">int</span> socket, <span class="type">const</span> <span class="type">void</span> *buffer, <span class="type">size_t</span> length, <span class="type">int</span> flags, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *dest_addr, <span class="type">socklen_t</span> dest_len)</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java" style="display:none"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java.io.InputStream.read0();</span><br><span class="line">java.io.OutputStream.writeBytes();</span><br><span class="line">java.net.SocketInputStream.socketRead0();</span><br><span class="line">java.net.SocketOutputStream.socketWrite0();</span><br><span class="line">java.net.PlainDatagramSocketImpl.send0();</span><br><span class="line">java.net.PlainDatagramSocketImpl.receive0();</span><br><span class="line">java.nio.FileChannel.read(ByteBuffer dst);</span><br><span class="line">java.nio.FileChannel.write(ByteBuffer src);</span><br></pre></td></tr></tbody></table></figure></div></figure><p>默认情况下这些接口读写I/O都会经过内核维护的缓冲区，比如对于文件读写内核维护一个Page Cache<sup id="fnref:25"><a href="#fn:25" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Page_cache Page Cache
">[25]</span></a></sup>，这个PageCache的目的主要是为了加快硬盘文件的读写。</p><p><img src="https://pic2.zhimg.com/v2-cadabc5672c37a84a83ee837de545be5_r.jpg"></p><h3>Vectored I/O</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vectored_I/O">Vectored I/O</a>也被称作<strong>scatter/gather I/O</strong>。就是一个调用读取多个缓冲区中写入文件，或者读取文件写入多个缓冲区。</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li><li class="tab">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">preadv</span><span class="params">(<span class="type">int</span> d, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">readv</span><span class="params">(<span class="type">int</span> d, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">writev</span><span class="params">(<span class="type">int</span> fildes, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">pwritev</span><span class="params">(<span class="type">int</span> fildes, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> {</span></span><br><span class="line">  <span class="type">char</span>   *iov_base;  <span class="comment">/* Base address. */</span></span><br><span class="line">  <span class="type">size_t</span> iov_len;    <span class="comment">/* Length. */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java" style="display:none"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FileChannel.read(ByteBuffer[] dsts);</span><br><span class="line">FileChannel.read(ByteBuffer[] dsts, <span class="type">int</span> offset, <span class="type">int</span> length);</span><br><span class="line">FileChannel.write(ByteBuffer[] srcs);</span><br><span class="line">FileChannel.write(ByteBuffer[] srcs, <span class="type">int</span> offset, <span class="type">int</span> length)</span><br></pre></td></tr></tbody></table></figure></div></figure><p>这几个API都是<a target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/readv.html">POSIX标准</a>定义的，主要目的有以下几个：</p><ul><li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Atomicity_(programming)">原子性</a>：如果特定的Vectored I/O 实现支持原子性，则进程可以在一组缓冲区中写入或读取文件，而不会存在另一个<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Thread_(computer_science)">线程</a>或<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_process">进程</a>可能对同一文件执行 I/O 的风险，损害输入的完整性</li><li>连接输出：想要在内存中写入非顺序放置数据的应用程序可以在一个Vectored I/O 操作中完成。例如，可以通过单个向量 I/O 操作将固定大小的标头及其关联的负载数据写入内存中，这些数据以非顺序方式放置在内存中，而无需先将标头和负载连接到另一个缓冲区。</li><li>效率：一个Vectored I/O读或写可以代替很多普通的读或写，从而节省<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Syscall">系统调用</a>的开销</li></ul><h3>mmap</h3><p>不管是普通的Buffer I/O还是Vectored I/O，都会经过内核的PageCache。复制一个文件，也就意味着有2次CPU拷贝和2次DMA拷贝以及4次用户态到内核态的切换。从PageCache拷贝到用户缓冲区的这次CPU拷贝其实是没必要的，所以Linux提供了mmap<sup id="fnref:26"><a href="#fn:26" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Mmap mmap
">[26]</span></a></sup>的方式，将内核缓冲区的PageCache直接映射到用户缓冲区。对于使用者来说访问硬盘就好像访问内存一样。mmap也是<a target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/mmap.html">POSIX标准</a>中定义的接口</p><p><img src="https://pic4.zhimg.com/v2-80018696eff24ce1e4b9e9b5e127416b_r.jpg"></p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li><li class="tab">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> len, <span class="type">int</span> prot, <span class="type">int</span> flags, <span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">munmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> len)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">msync</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> flags)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// how to use</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> str1[] = <span class="string">"string 1"</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> str2[<span class="number">10</span>] = {<span class="number">0</span>};</span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">"/dev/zero"</span>, O_RDWR, <span class="number">0</span>);</span><br><span class="line"><span class="type">char</span>* buf = (<span class="type">char</span>*)mmap(<span class="literal">NULL</span>, <span class="number">4096</span>, PROT_READ|PROT_WRITE, MAP_ANON|MAP_SHARED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(buf, str1); <span class="comment">// 可以直接往里面写</span></span><br><span class="line"><span class="built_in">strcpy</span>(str2, buf); <span class="comment">// 也可以直接从里面读</span></span><br><span class="line">munmap(buf, <span class="number">4096</span>); <span class="comment">// 断开映射，操作系统会把脏页写入硬盘，具体什么时候刷到硬盘根据操作系统不同实现而定。</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight java" style="display:none"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.nio.MappedByteBuffer java.nio.channels.FileChannel.map(MapMode mode, <span class="type">long</span> position, <span class="type">long</span> size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用mmap读取文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readFileAsString</span><span class="params">(String path, Charset charset)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">  <span class="keyword">if</span> (charset == <span class="literal">null</span>) charset = Charset.defaultCharset();</span><br><span class="line">  <span class="keyword">try</span> (<span class="type">FileChannel</span> <span class="variable">fc</span> <span class="operator">=</span> FileChannel.open(Paths.get(path))) {</span><br><span class="line">    <span class="type">MappedByteBuffer</span> <span class="variable">bb</span> <span class="operator">=</span> fc.map(FileChannel.MapMode.READ_ONLY, <span class="number">0</span>, fc.size());</span><br><span class="line">    <span class="keyword">return</span> charset.decode(bb).toString();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure><p><strong>优缺点</strong></p><p>使用 mmap 访问文件的好处很明显：</p><ol><li>读写文件不需要使用 read/write 系统调用。</li><li>可以减少用户空间和内核空间的内存拷贝。</li><li>如果有多个进程以只读的方式访问同一个文件的数据，这个时候所有的进程共享同一个内核空间的物理内存，可以节省大量空间。</li></ol><p>同时 mmap 也存在一些缺点：</p><ol><li>PageCache的页大小是固定的，对于特别小的文件，可能会导致空间浪费，比如对于4KB的Cache页，文件只有几十个字节，那将会浪费三千多个字节的空间。</li><li>对于大文件的拷贝，会导致PageCache缓存算法失效，加载进缓存意味着另一份缓存被替换出去，导致其他真正需要缓存机制的文件IO效率下降。</li></ol><h3>Direct I/O</h3><p>传统的读/写和 mmap 都涉及内核页缓存，并将内核的 I/O 延迟调度。 当应用程序希望自己调度 I/O（至于原因我们稍后将解释），它可以使用 Direct I/O。 这涉及使用 <strong>O_DIRECT 标志打开文件</strong><sup id="fnref:27"><a href="#fn:27" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://man7.org/linux/man-pages/man2/open.2.html open file
">[27]</span></a></sup>，<code>O_DIRECT</code>是Linux 2.4.10引入的，在FreeBSD<sup id="fnref:28"><a href="#fn:28" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://www.freebsd.org/cgi/man.cgi?query=open&sektion=2&format=html FreeBSD open flag O_DIRECT
">[28]</span></a></sup>等Unix操作系统上也有支持，但在MacOS和Windows上还没有得到支持。</p><p>简单的说Direct I/O就是<strong>在open文件的时候加上<code>O_RIRECT</code>标志可以直接跟DMA打交道，读数据时DMA直接从磁盘缓冲区<sup id="fnref:29"><a href="#fn:29" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Disk_buffer DIsk Buffer
">[29]</span></a></sup>拷贝到用户缓冲区，不需要经过内核PageCache缓冲</strong>。这个好处是读取大文件时避免对其他文件的PageCache的影响，因为基于PageCache缓存读写文件时，文件会竞争内存空间，会导致其他数据被挤出内存。所以<strong>对于那些具有高吞吐量的顺序I/O的文件读写可以用Direct I/O，对于那些需要频繁读写的文件可以用mmap有效加快读写速度</strong>。总之呢，在Direct I/O和mmap之间选择时，先权衡一下操作系统的PageCache是否对文件读写有显著提升。去看kafka和RocketMQ这些项目会发现像offset索引这类数据的存取用的都是mmap，因为这类数据对缓存友好，存在频繁读取。</p><p><img src="https://img-blog.csdnimg.cn/20190320001938378.png" rel="external noreferrer nofollow noopener" referrerpolicy="no-referrer"></p><blockquote><p>关于Direct I/O的讨论可以参考一下几片文章：</p><p><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/vi/aix/7.2?topic=tuning-direct-io">https://www.ibm.com/docs/vi/aix/7.2?topic=tuning-direct-io</a></p><p><a target="_blank" rel="noopener" href="https://www.flamingbytes.com/2021/03/09/buffered-direct-io/">https://www.flamingbytes.com/2021/03/09/buffered-direct-io/</a></p></blockquote><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li><li class="tab">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fd = open(<span class="string">"/path/to/file"</span>, O_RDONLY | O_DIRECT);</span><br><span class="line"><span class="type">char</span> *buf = <span class="built_in">malloc</span>(BUF_SIZE);</span><br><span class="line">read(disk, buf, BUF_SIZE);</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight java" style="display:none"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileChannel</span> <span class="variable">fc</span> <span class="operator">=</span> FileChannel.open(Paths.get(<span class="string">"/path/to/file"</span>),StandardOpenOption.READ,ExtendedOpenOption.DIRECT);</span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteBuffer</span>();</span><br><span class="line">fc.read(buff);</span><br></pre></td></tr></tbody></table></figure></div></figure><p>需要注意的是由于Direct I/O在有些操作系统上并没有实现，所以jdk中的<code>java.nio.file.StandardOpenOption</code>并没有这个选项，而是在<code>com.sun.nio.file.ExtendedOpenOption</code>中提供的。</p><blockquote><p><a target="_blank" rel="noopener" href="https://github.com/smacke/jaydio">github</a>上有一个库，实现了DirectIO，当然和sun提供的ExtendedOpenOption一样，兼容性并不好。</p></blockquote><h3>sendfile</h3><p>sendfile<sup id="fnref:30"><a href="#fn:30" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://man7.org/linux/man-pages/man2/sendfile.2.html sendfile
">[30]</span></a></sup>是在Linux 2.2中引入的，直接把拷贝任务交给操作系统。目的是为了减少mmap方式拷贝过程中的用户态与内核态的切换。</p><blockquote><p>有关内容可以参看<a target="_blank" rel="noopener" href="https://yarchive.net/comp/linux/sendfile.html">linux社区关于sendfile的讨论</a>。</p></blockquote><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li><li class="tab">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendfile</span><span class="params">(<span class="type">int</span> out_fd , <span class="type">int</span> in_fd , <span class="type">off_t</span> * offset , <span class="type">size_t</span> count )</span>;</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java" style="display:none"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FileChannel.transferTo(<span class="type">long</span> position, <span class="type">long</span> count, WritableByteChannel target);</span><br><span class="line"><span class="comment">// 注意java为了跨平台，会在transferTo的时候尝试不同的方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果内核支持sendfile，就用最直接的方式传输</span></span><br><span class="line"><span class="keyword">if</span> ((n = transferToDirectly(position, icount, target)) &gt;= <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 尝试mmap进行拷贝</span></span><br><span class="line"><span class="keyword">if</span> ((n = transferToTrustedChannel(position, icount, target)) &gt;= <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 否则用通用的Buffer I/O read/write方式拷贝</span></span><br><span class="line"><span class="keyword">return</span> transferToArbitraryChannel(position, icount, target);</span><br></pre></td></tr></tbody></table></figure></div></figure><p><img src="https://pic4.zhimg.com/80/v2-17ce86192cb8e4d88282aaf9a7c844a3_1440w.jpg"></p><p>需要注意sendfile不是POSIX标准接口，在<a target="_blank" rel="noopener" href="https://www.freebsd.org/cgi/man.cgi?query=sendfile&sektion=2">BSD系列的定义</a>是这样的：</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sendfile</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> s, <span class="type">off_t</span> offset, <span class="type">size_t</span> nbytes, <span class="keyword">struct</span>	sf_hdtr	*hdtr, <span class="type">off_t</span> *sbytes, <span class="type">int</span> flags)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sf_hdtr</span> {</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">headers</span>;</span>  <span class="comment">/* pointer to header iovecs */</span></span><br><span class="line">  <span class="type">int</span> hdr_cnt;            <span class="comment">/* number of header iovecs */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">trailers</span>;</span> <span class="comment">/* pointer to trailer iovecs */</span></span><br><span class="line">  <span class="type">int</span> trl_cnt;            <span class="comment">/* number of trailer iovecs */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure></div></figure><h3>sendfile+Scatter/Gather DMA</h3><p>sendfile方式仍然需要一次内核空间的数据拷贝，所以更甚者进入了Scatter/Gather DMA，将这次拷贝交由DMA控制器处理，CPU完全解放了。</p><p><img src="https://pic1.zhimg.com/80/v2-0d99113bd0d67e41d288b1f1034d4704_1440w.jpg"></p><p><code>sendfile()</code> + DMA Scatter/Gather 的零拷贝方案虽然高效，但是仍然有两个缺点：</p><ol><li>这种方案需要引入新的硬件支持；</li><li>虽然 <code>sendfile()</code> 的输出文件描述符在 Linux kernel 2.6.33 版本之后已经可以支持任意类型的文件描述符，但是输入文件描述符依然只能指向文件。</li></ol><p>参考链接:</p><ul><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/308054212">https://zhuanlan.zhihu.com/p/308054212</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/357820303">https://zhuanlan.zhihu.com/p/357820303</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/374626979">https://zhuanlan.zhihu.com/p/374626979</a></li><li><a target="_blank" rel="noopener" href="https://www.pianshen.com/article/3904354027/">https://www.pianshen.com/article/3904354027/</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaolincoding/p/13719610.html">https://www.cnblogs.com/xiaolincoding/p/13719610.html</a></li><li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903949359644680">https://juejin.cn/post/6844903949359644680</a></li><li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/History_of_Unix">https://en.wikipedia.org/wiki/History_of_Unix</a></li><li><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/standards.7.html">https://man7.org/linux/man-pages/man7/standards.7.html</a></li><li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/306127044/answer/555327651">https://www.zhihu.com/question/306127044/answer/555327651</a></li><li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#Low_002dLevel-I_002fO">https://www.gnu.org/software/libc/manual/html_mono/libc.html#Low_002dLevel-I_002fO</a></li></ul><h2>IO处理模式</h2><p>上面提到的是内核层面怎么处理与用户程序的I/O读写，但用户程序怎么处理I/O也有很多讲究。</p><h3>阻塞式IO</h3><p>传统的文件与socket I/O接口都是阻塞式的，读写文件会阻塞到数据读取完成</p><div class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" preserveAspectRatio="none" version="1.1" viewBox="0 0 410 208" zoomAndPan="magnify"><defs></defs><g><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="49" x2="49" y1="36.2969" y2="172.8281"></line><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="242.5" x2="242.5" y1="36.2969" y2="172.8281"></line><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="342.5" x2="342.5" y1="36.2969" y2="172.8281"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="89" x="5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="12" y="24.9951">Application</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="89" x="5" y="171.8281"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="12" y="191.8232">Application</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="58" x="213.5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="44" x="220.5" y="24.9951">Kernel</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="58" x="213.5" y="171.8281"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="44" x="220.5" y="191.8232">Kernel</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="123" x="281.5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109" x="288.5" y="24.9951">Disk or Network</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="123" x="281.5" y="171.8281"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109" x="288.5" y="191.8232">Disk or Network</text><polygon fill="#181818" points="230.5,63.4297,240.5,67.4297,230.5,71.4297,234.5,67.4297" style="stroke:#181818;stroke-width:1"></polygon><line style="stroke:#181818;stroke-width:1" x1="49.5" x2="236.5" y1="67.4297" y2="67.4297"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="56.5" y="62.3638">read()/write()/recv()/send()</text><polygon fill="#181818" points="331,92.5625,341,96.5625,331,100.5625,335,96.5625" style="stroke:#181818;stroke-width:1"></polygon><line style="stroke:#181818;stroke-width:1" x1="242.5" x2="337" y1="96.5625" y2="96.5625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="249.5" y="91.4966">io()</text><polygon fill="#181818" points="253.5,121.6953,243.5,125.6953,253.5,129.6953,249.5,125.6953" style="stroke:#181818;stroke-width:1"></polygon><line style="stroke:#181818;stroke-width:1" x1="247.5" x2="342" y1="125.6953" y2="125.6953"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="259.5" y="120.6294">ok</text><polygon fill="#181818" points="60.5,150.8281,50.5,154.8281,60.5,158.8281,56.5,154.8281" style="stroke:#181818;stroke-width:1"></polygon><line style="stroke:#181818;stroke-width:1" x1="54.5" x2="241.5" y1="154.8281" y2="154.8281"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39" x="66.5" y="149.7622">return</text></g></svg></div><p>对于磁盘I/O这个可能还能忍受，但是网络I/O速度非常不稳定，阻塞了意味着这个线程暂时不能干别的事儿了。所以不论是Windows、MacOS或者Web，在GUI开发中都会避免在UI线程中执行I/O操作，否则窗口页面刷新不流畅会给用户带来极差的体验。所以前端大多是另起一个线程负责处理IO，IO完成后回调给UI线程。</p><p>对于后端如果只是用一个线程，那意味着服务只能给一个人服务，要想同时服务多个人就需要起多个线程或者使用线程池处理。</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li><li class="tab">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">echo</span><span class="params">(<span class="type">int</span> client_fd)</span> {</span><br><span class="line">    <span class="type">char</span> buff[BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">do</span> {</span><br><span class="line">        <span class="type">int</span> read_bytes = recv(client_fd, buff, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (read_bytes &lt;= <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Failed to read client"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Read from client %d: %s \n"</span>, client_fd, buff);</span><br><span class="line">        <span class="keyword">if</span> (send(client_fd, buff, read_bytes, <span class="number">0</span>) &lt; <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Failed to write client"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        bzero(buff, read_bytes);</span><br><span class="line">    } <span class="keyword">while</span> (<span class="built_in">strncmp</span>(buff, <span class="string">"bye\r"</span>, <span class="number">4</span>) != <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Connection closed: %d\n"</span>, client_fd);</span><br><span class="line">    close(client_fd);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java" style="display:none"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoServer</span> {</span><br><span class="line">	<span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">int</span> port)</span> {</span><br><span class="line">		serverSocket = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>){</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">clientSocket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            echo(clientSocket);</span><br><span class="line">        }</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">echo</span><span class="params">(Socket clientSocket)</span> {</span><br><span class="line">		<span class="keyword">try</span>(<span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(clientSocket.getOutputStream(), <span class="literal">true</span>);</span><br><span class="line">		<span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(clientSocket.getInputStream()))){</span><br><span class="line">			String line;</span><br><span class="line">			<span class="keyword">while</span>(<span class="literal">null</span> != (line=in.readLine())){</span><br><span class="line">				out.println(line);</span><br><span class="line">			}</span><br><span class="line">		}<span class="keyword">catch</span>(Exception e){</span><br><span class="line">            System.error.println(<span class="string">"client closed"</span>);</span><br><span class="line">        }</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">		EchoServer server=<span class="keyword">new</span> <span class="title class_">EchoServer</span>();</span><br><span class="line">		server.start(<span class="number">6666</span>);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure><h3>非阻塞式IO</h3><p>Linux在打开文件描述中提供了一个<code>O_NONBLOCK</code>属性，这个属性与<code>O_DIRECT</code>类似。标记了<code>O_NONBLOCK</code>属性的文件描述符，调用read和write的时候，如果没有数据或缓冲区已满，将不会阻塞，而是返回-1并将全局变量<strong>errno</strong>设置为<code>EAGAIN</code>。这就是所谓的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Non-blocking_I/O_%28Java%29">非阻塞式IO</a>。</p><p>你可以在open方法的参数中带上<code>O_NONBLOCK</code>的flag，也可以调用<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/fcntl.2.html">fcntl接口</a>进行修改，在POSIX标准化之前的程序也有在用<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/ioctl.2.html">ioctl</a>来修改为非阻塞模式。</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li><li class="tab">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, ... <span class="comment">/* arg */</span> )</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> flags = fcntl(fd, F_GETFL);</span><br><span class="line"><span class="type">int</span> newflags = flags | O_NONBLOCK;</span><br><span class="line">fcntl(fd, F_SETFL, newflags)</span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ioctl</span><span class="params">(<span class="type">int</span> fd, <span class="type">unsigned</span> <span class="type">long</span> request, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> on = <span class="number">1</span>;</span><br><span class="line">ioctl(listen_sd, FIONBIO, (<span class="type">char</span> *)&amp;on);</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java" style="display:none"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.nio.channels.SelectableChannel.configureBlocking(blocking);</span><br></pre></td></tr></tbody></table></figure></div></figure><p>阻塞的问题解决了，但是每个连接都排一个线程去检查是否有数据，还是不太高效。<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Multiplexing">多路复用(Multiplex)</a>便是解决这个问题的。</p><h3>IO多路复用</h3><p>多路复用来是计算机网络中的词汇，指的是一个共享介质处理多个信道信息。而<strong>IO多路复用指的就是单个事件循环中处理多个I/O通道的事件。</strong></p><p><img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Telephony_multiplexer_system.gif" alt="时分多路复用原理图"></p><p>这就好比到餐厅吃饭，传统的阻塞式IO就是一个服务员服务一桌客人，从你进餐厅到结账全程一对一的VIP服务。对于餐厅老板来说这个成本太高了，1000桌就得聘请1000个服务员。而且服务员在为客人服务的过程中并不是一直都忙着，客人点完菜，上完菜，吃着的这段时间，服务员就闲下来了，可是这个服务员还是被这桌客人占用着，不能为别的客人服务。</p><p>IO多路复用让一个服务员作为前台专门负责收集客人的需求，登记下来，比如有客人进来了、客人点菜了，客人要结帐了，都先记录下来按顺序排好。每个服务员到这里领一个需求，比如点菜，就拿着菜单帮客人点菜去了。点好菜以后，服务员马上回来，领取下一个需求，继续为别人客人服务去了。这种方式服务质量就不如一对一的服务了，当客人数据很多的时候可能需要等待。但好处也很明显，由于在客人正吃饭着的时候服务员不用闲着了，服务员这个时间内可以为其他客人服务了，原来10个服务员最多同时为10桌客人服务，现在可能为50桌，60客人服务了。</p><blockquote><p>上面这个比喻引用自CSDN博主<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhouhl_cn/article/details/6568119">zhouhl_cn</a>的一篇文章</p></blockquote><p>IO多路复用机制尽可能满足：</p><ul><li><p><strong>协调者消耗最少的系统资源</strong>；</p></li><li><p><strong>最小化FD的等待时间</strong>（尽可能地缩短客户的等待时间）；</p></li><li><p><strong>最大化FD的数量</strong>（尽可能地服务更多的客户）；</p></li><li><p><strong>任务处理线程最少的空闲</strong>（尽可能地压榨服务员，能少雇一个服务员就少雇一个）；</p></li><li><p><strong>多快好省完成任务等</strong>。</p></li></ul><h4>poll与select</h4><p><a target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/poll.h.html">poll</a>和<a target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/sys_select.h.html">select</a>是最早的多路复用技术，select<sup id="fnref:31"><a href="#fn:31" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Select_%28Unix%29 Unix Select API
">[31]</span></a></sup>是1983年BSD Unix分支引入的，而poll是1986年SVR3 Unix分支引入的，分别代表着以伯克利大学为首的开源派和<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/UNIX_System_V">AT&amp;T的SystemV</a>为首的商业闭源两个Unix大分支。</p><blockquote><p>有兴趣的可以看wikipedia上<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/History_of_Unix">关于Unix的历史</a>。</p></blockquote><p>目前<a target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/pselect.html">select</a>和<a target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/poll.html">poll</a>接口都被定义在POSIX标准中。</p><p>两者提供的功能基本相同，只在一些细节上有略微差异：</p><p><strong>select</strong></p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> max_fd, fd_set *readset, fd_set *writeset, fd_set *exceptset, <span class="keyword">struct</span> timeval *timeout)</span></span><br><span class="line"><span class="title function_">FD_ZERO</span><span class="params">(<span class="type">int</span> fd, fd_set* fds)</span>   <span class="comment">//清空集合</span></span><br><span class="line"><span class="title function_">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set* fds)</span>    <span class="comment">//将给定的描述符加入集合</span></span><br><span class="line"><span class="title function_">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set* fds)</span>  <span class="comment">//判断指定描述符是否在集合中</span></span><br><span class="line"><span class="title function_">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set* fds)</span>    <span class="comment">//将给定的描述符从文件中删除</span></span><br></pre></td></tr></tbody></table></figure></div></figure><p>select用一个<code>fd_set</code>来存储新来的请求，<code>fd_set</code>是一个比特集合，如果4号文件描述符有请求过来，那第4个bit位置为1。程序轮训所有的文件描述符，用<code>FD_ISSET(fd,fds)</code>一个个对比过来，发现4号文件描述符有请求，那就开始接受数据开始处理。</p><p>这里<a target="_blank" rel="noopener" href="https://github.com/holmofy/echo-server/blob/master/tcp-non-blocking-select-echo-server.c">github</a>上有相关代码的实现示例。</p><p><strong>poll</strong></p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(<span class="keyword">struct</span> pollfd fds[], <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span>;</span><br></pre></td></tr></tbody></table></figure></div></figure><p>而poll则相对简洁，用了一个pollfd的结构体，分别存了文件描述符和对应事件</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> {</span></span><br><span class="line">  <span class="type">int</span>    fd;       <span class="comment">/* file descriptor */</span></span><br><span class="line">  <span class="type">short</span>  events;   <span class="comment">/* events to look for */</span></span><br><span class="line">  <span class="type">short</span>  revents;  <span class="comment">/* events returned */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure></div></figure><p>这里<a target="_blank" rel="noopener" href="https://github.com/holmofy/echo-server/blob/master/tcp-non-blocking-poll-echo-server.c">github</a>上有相关代码实现示例。</p><p><strong>select和poll的问题</strong></p><ul><li>它们都用线性方式扫描所有的文件描述符，文件描述符越多，速度就越慢。</li><li>select第一个参数是max_fd，这个值随着连接的客户端越来越多，只会不断的增大，关闭的文件描述符，仍然需要扫描；而poll相对较好的是pollfd数组决定能处理多少文件描述符，当有文件描述符关闭的时候，可以compact掉已关闭的文件描述符。</li><li>select由于使用bit mask实现的，占用空间小，而poll用结构体实现，每个<code>pollfd</code>就得64bit=8byte。</li><li>select的<code>FD_SETSIZE</code>默认值是1024，默认<code>fd_set</code>是32个int数组，也就是说最多能处理32*32=1024个文件描述符。</li></ul><p>不过select和poll兼容性都挺好，几乎所有操作系统都有实现。</p><p>参考链接：</p><ul><li><a target="_blank" rel="noopener" href="https://daniel.haxx.se/docs/poll-vs-select.html">https://daniel.haxx.se/docs/poll-vs-select.html</a></li></ul><blockquote><p>Windows支持<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-select">select API</a>，因为Windows最早支持tcp/ip的时候就用的是BSD系列的实现，可以看到<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/winsock/winsock-functions">WinSock</a> API中提供的以小写字母命名的函数和Unix是完全一样的。但是由于select的缺点，poll api又是商业公司的没有开源，所以Windows从Windows Vista版本开始还提供了类似于poll api的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsapoll">WSAPoll</a>接口，从命名可以看出是微软风格的函数接口。</p></blockquote><h4>epoll,kqueue和IOCP</h4><p>由于select和poll的种种问题，现在基本都被epoll<sup id="fnref:32"><a href="#fn:32" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Epoll Epoll
">[32]</span></a></sup>（Linux）、kqueue<sup id="fnref:33"><a href="#fn:33" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Kqueue Kqueue
">[33]</span></a></sup>（BSD Unix）、IOCP<sup id="fnref:34"><a href="#fn:34" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="https://en.wikipedia.org/wiki/Input/output_completion_port IOCP">[34]</span></a></sup>（Windows）取代了。</p><p><strong>Linux的epoll</strong></p><p><a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man7/epoll.7.html">epoll</a>是Linux 2.5.44中引入的，将原来<code>select</code>和<code>poll</code>那种需要遍历所有文件描述符的O(n)算法，改造成了从就绪列表中读取event的，时间复杂度降至O(1)。</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 让内核创建一个epoll相关的结构</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span>;</span><br><span class="line"><span class="comment">// 添加或删除fd</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span>;</span><br><span class="line"><span class="comment">// 阻塞等待内核返回一个可读写的事件</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event *events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">epoll_data</span> {</span></span><br><span class="line">  <span class="type">void</span>    *ptr;</span><br><span class="line">  <span class="type">int</span>      fd;</span><br><span class="line">  <span class="type">uint32_t</span> u32;</span><br><span class="line">  <span class="type">uint64_t</span> u64;</span><br><span class="line">} <span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> {</span></span><br><span class="line">  <span class="type">uint32_t</span>     events;    <span class="comment">/* Epoll events */</span></span><br><span class="line">  <span class="type">epoll_data_t</span> data;      <span class="comment">/* User data variable */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure></div></figure><p>以下我基于自己的认识画的原理图，有兴趣的可以自行阅读<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux">linux源码</a>。这里有<a target="_blank" rel="noopener" href="https://github.com/holmofy/echo-server/blob/master/tcp-non-blocking-epoll-echo-server.c">基于epoll实现的echo server</a>示例代码。</p><p><img src="https://p.pstatp.com/origin/pgc-image/1d2c575cf8af4f7288cd9c68e6fc6a9e" rel="external noreferrer nofollow noopener" referrerpolicy="no-referrer"></p><blockquote><p>有意思的是社区有一个基于Windows的IOCP的开发的<a target="_blank" rel="noopener" href="https://github.com/piscisaureus/wepoll">wepoll</a>能在Windows上提供兼容epoll的api，底层也是用红黑树和双向链表实现，不过由于是在用户层模拟的，所以提供了epoll_close接口释放资源。epoll也被jdk使用了。如果觉得Linux源码太多不太容易找到对应的代码，可以看看这个wepoll项目。项目很简单只有不到三千行代码。</p></blockquote><p><strong>BSD的kqueue</strong></p><p><a target="_blank" rel="noopener" href="https://www.freebsd.org/cgi/man.cgi?query=kqueue&sektion=2">kqueue</a>是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/FreeBSD">FreeBSD</a> 4.1引入的，kqueue与epoll基本类似，不过kqueue用两个api就能搞定。</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">c</li></ul></figcaption><div class="tabs-content"><figure class="highlight c" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建kqueue</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kqueue</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取或发送消息，发送消息主要是添加或删除文件描述符</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kevent</span><span class="params">(<span class="type">int</span> kq, <span class="type">const</span> <span class="keyword">struct</span> kevent *changelist, <span class="type">int</span> nchanges, <span class="keyword">struct</span> kevent *eventlist, <span class="type">int</span> nevents, <span class="type">const</span> <span class="keyword">struct</span> timespec *timeout)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">kevent64</span><span class="params">(<span class="type">int</span> kq, <span class="type">const</span> <span class="keyword">struct</span> kevent64_s *changelist, <span class="type">int</span> nchanges, <span class="keyword">struct</span> kevent64_s *eventlist, <span class="type">int</span> nevents, <span class="type">unsigned</span> <span class="type">int</span> flags, <span class="type">const</span> <span class="keyword">struct</span> timespec *timeout)</span>;</span><br><span class="line"><span class="comment">// MacOS的内核darwin添加的api</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kevent_qos</span><span class="params">(<span class="type">int</span> kq, <span class="type">const</span> <span class="keyword">struct</span> kevent_qos_s *changelist, <span class="type">int</span> nchanges, <span class="keyword">struct</span> kevent_qos_s *eventlist, <span class="type">int</span> nevents, <span class="type">void</span> *data_out, <span class="type">size_t</span> *data_available, <span class="type">unsigned</span> <span class="type">int</span> flags)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kevent</span> {</span></span><br><span class="line">  <span class="type">uintptr_t</span>       ident;          <span class="comment">/* identifier for this event */</span></span><br><span class="line">  <span class="type">int16_t</span>         filter;         <span class="comment">/* filter for event */</span></span><br><span class="line">  <span class="type">uint16_t</span>        flags;          <span class="comment">/* general flags */</span></span><br><span class="line">  <span class="type">uint32_t</span>        fflags;         <span class="comment">/* filter-specific flags */</span></span><br><span class="line">  <span class="type">intptr_t</span>        data;           <span class="comment">/* filter-specific data */</span></span><br><span class="line">  <span class="type">void</span>            *udata;         <span class="comment">/* opaque user data identifier */</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kevent64_s</span> {</span></span><br><span class="line">  <span class="type">uint64_t</span>        ident;          <span class="comment">/* identifier for this event */</span></span><br><span class="line">  <span class="type">int16_t</span>         filter;         <span class="comment">/* filter for event */</span></span><br><span class="line">  <span class="type">uint16_t</span>        flags;          <span class="comment">/* general flags */</span></span><br><span class="line">  <span class="type">uint32_t</span>        fflags;         <span class="comment">/* filter-specific flags */</span></span><br><span class="line">  <span class="type">int64_t</span>         data;           <span class="comment">/* filter-specific data */</span></span><br><span class="line">  <span class="type">uint64_t</span>        udata;          <span class="comment">/* opaque user data identifier */</span></span><br><span class="line">  <span class="type">uint64_t</span>        ext[<span class="number">2</span>];         <span class="comment">/* filter-specific extensions */</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kevent_qos_s</span> {</span></span><br><span class="line">  <span class="type">uint64_t</span>        ident;          <span class="comment">/* identifier for this event */</span></span><br><span class="line">  <span class="type">int16_t</span>         filter;         <span class="comment">/* filter for event */</span></span><br><span class="line">  <span class="type">uint16_t</span>        flags;          <span class="comment">/* general flags */</span></span><br><span class="line">  <span class="type">uint32_t</span>        qos;            <span class="comment">/* quality of service when servicing event */</span></span><br><span class="line">  <span class="type">uint64_t</span>        udata;          <span class="comment">/* opaque user data identifier */</span></span><br><span class="line">  <span class="type">uint32_t</span>        fflags;         <span class="comment">/* filter-specific flags */</span></span><br><span class="line">  <span class="type">uint32_t</span>        xflags;         <span class="comment">/* extra filter-specific flags */</span></span><br><span class="line">  <span class="type">int64_t</span>         data;           <span class="comment">/* filter-specific data */</span></span><br><span class="line">  <span class="type">uint64_t</span>        ext[<span class="number">4</span>];         <span class="comment">/* filter-specific extensions */</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 几个宏定义，来填充event结构体</span></span><br><span class="line">EV_SET(&amp;kev, ident, filter, flags, fflags, data, udata);</span><br><span class="line">EV_SET64(&amp;kev, ident, filter, flags, fflags, data, udata, ext[<span class="number">0</span>], ext[<span class="number">1</span>]);</span><br><span class="line">EV_SET_QOS(&amp;kev, ident, filter, flags, qos, udata, fflags, xflags, data, ext[<span class="number">0</span>], ext[<span class="number">1</span>], ext[<span class="number">2</span>], ext[<span class="number">3</span>]);</span><br></pre></td></tr></tbody></table></figure></div></figure><p>这里有基于<a target="_blank" rel="noopener" href="https://github.com/holmofy/echo-server/blob/master/tcp-non-blocking-kqueue-echo-server.c">kqueue的echo server实现代码</a>。</p><p><strong>Windows的IOCP</strong></p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/fileio/i-o-completion-ports">IOCP</a>是Windows上处理处理多个文件句柄的API，这里不去详细介绍，感兴趣的可以看看Windows官方给的<a target="_blank" rel="noopener" href="https://github.com/microsoft/Windows-classic-samples/blob/master/Samples/Win7Samples/netds/winsock/iocp/serverex/IocpServerex.Cpp">Demo</a>。</p><p>参考链接：</p><ul><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87843750">https://zhuanlan.zhihu.com/p/87843750</a></li></ul><h4>libevent,libev,libuv</h4><p>由于每个平台的接口都不一致，而且用原生接口编程真的非常繁琐（可以看看我用每个接口写的<a target="_blank" rel="noopener" href="https://github.com/holmofy/echo-server">示例</a>，循环调度需要自己写），所以就有了<a target="_blank" rel="noopener" href="https://github.com/libevent/libevent">libevent</a>和<a target="_blank" rel="noopener" href="https://github.com/libuv/libuv">libuv</a>、<a target="_blank" rel="noopener" href="https://github.com/enki/libev">libev</a>这样跨平台的库，以及用C++封装的<a target="_blank" rel="noopener" href="https://github.com/chriskohlhoff/asio">Boost.Asio</a>，<a target="_blank" rel="noopener" href="https://github.com/skypjack/uvw">uvw</a>（基于libuv封装）库。</p><ul><li><p>libevent :名气最大，应用最广泛，历史悠久的跨平台事件库，很多著名的项目都在使用这个库。支持 *<a target="_blank" rel="noopener" href="http://download.oracle.com/docs/cd/E19253-01/816-5177/6mbbc4g9n/index.html">/dev/poll</a><em>、 *<a target="_blank" rel="noopener" href="http://www.freebsd.org/cgi/man.cgi?query=kqueue&apropos=0&sektion=0&format=html">kqueue(2)</a>*、 *<a target="_blank" rel="noopener" href="http://developers.sun.com/solaris/articles/event_completion.html">event ports</a>*、 <a target="_blank" rel="noopener" href="http://manpages.debian.net/cgi-bin/man.cgi?query=select">POSIX <em>select(2)</em></a>、 <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/ms740141(v=vs.85).aspx">Windows <em>select()</em></a>、 <a target="_blank" rel="noopener" href="http://manpages.debian.net/cgi-bin/man.cgi?query=poll"><em>poll(2)</em></a>和</em><a target="_blank" rel="noopener" href="http://www.xmailserver.org/linux-patches/epoll.txt">epoll(4)</a>*，除此之外还提供了filters，限速，零拷贝文件传输，并实现了DNS、HTTP以及一个小型rpc框架。</p><blockquote><p>可以在<a target="_blank" rel="noopener" href="https://github.com/libevent/libevent/tree/master/sample">github</a>上看到官方提供的示例demo。</p></blockquote></li><li><p>libev: libevent简化版，设计更简练，性能更好（可以看官方提供的<a target="_blank" rel="noopener" href="http://libev.schmorp.de/bench.html">benchmark</a>），按照<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9433864/whats-the-difference-between-libev-and-libevent">stackoverflow</a>的一位大神的评价，符合Unix哲学，只做一件事儿，并尽可能做好。缺点是不支持Windows的IOCP。</p></li><li><p>libuv: 因为<a target="_blank" rel="noopener" href="https://nodejs.org/en/docs/meta/topics/dependencies/#libuv">node.js</a>一炮而红，node.js中所有的异步IO都是基于libuv实现。据传node.js最早是基于libev开发的，由于libev不支持Windows，所以就另外开发了libuv。</p><blockquote><p>这里有<a target="_blank" rel="noopener" href="https://github.com/delaemon/libuv-tutorial">libuv tutorial</a>及相关代码。</p></blockquote></li></ul><p><a target="_blank" rel="noopener" href="https://github.com/holmofy/echo-server">github</a>有使用这三者实现的echo-server示例代码。</p><p>参考链接：</p><ul><li><p>《<a target="_blank" rel="noopener" href="https://book.douban.com/subject/3235659/">Windows核心编程</a>》</p></li><li><p>《<a target="_blank" rel="noopener" href="https://book.douban.com/subject/25809330/">Linux/UNIX系统编程手册</a>》</p></li><li><p>《<a target="_blank" rel="noopener" href="https://book.douban.com/subject/25900403/">UNIX环境高级编程</a>》</p></li><li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/desktop/FileIO/i-o-concepts">https://docs.microsoft.com/zh-cn/windows/desktop/FileIO/i-o-concepts</a></p></li><li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/desktop/FileIO/synchronous-and-asynchronous-i-o">https://docs.microsoft.com/zh-cn/windows/desktop/FileIO/synchronous-and-asynchronous-i-o</a></p></li><li><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Asynchronous_I/O">https://en.wikipedia.org/wiki/Asynchronous_I/O</a></p></li><li><p><a target="_blank" rel="noopener" href="https://tinyclouds.org/iocp-links.html">https://tinyclouds.org/iocp-links.html</a></p></li></ul><h2>Java NIO</h2><p>Java在1.4中提供了<a target="_blank" rel="noopener" href="https://jcp.org/en/jsr/detail?id=51">JSR-51</a>要求的新版IO，也就是所谓的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Non-blocking_I/O_%28Java%29">Non-blocking I/O</a>。</p><h3>buffer</h3><p>NIO中提供了行为被限制的buffer：主要是为了让内存映射(mmap)的MappedByteBuffer和Java堆内存中的HeapByteBuffer行为统一。</p><div class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" preserveAspectRatio="none" version="1.1" viewBox="0 0 520 494" zoomAndPan="magnify"><defs></defs><g><g id="elem_Buffer"><rect codeLine="1" fill="#F1F1F1" height="48" id="Buffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="73" x="274.5" y="115"></rect><ellipse cx="289.5" cy="131" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M289.6094,126.3438 L288.4531,131.4219 L290.7813,131.4219 L289.6094,126.3438 Z M288.125,124.1094 L291.1094,124.1094 L294.4688,136.5 L292.0156,136.5 L291.25,133.4375 L287.9688,133.4375 L287.2188,136.5 L284.7813,136.5 L288.125,124.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="41" x="303.5" y="135.8467">Buffer</text><line style="stroke:#181818;stroke-width:.5" x1="275.5" x2="346.5" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="275.5" x2="346.5" y1="155" y2="155"></line></g><g id="elem_ByteBuffer"><rect codeLine="2" fill="#F1F1F1" height="48" id="ByteBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="104" x="127" y="223"></rect><ellipse cx="142" cy="239" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M142.1094,234.3438 L140.9531,239.4219 L143.2813,239.4219 L142.1094,234.3438 Z M140.625,232.1094 L143.6094,232.1094 L146.9688,244.5 L144.5156,244.5 L143.75,241.4375 L140.4688,241.4375 L139.7188,244.5 L137.2813,244.5 L140.625,232.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="72" x="156" y="243.8467">ByteBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="128" x2="230" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="128" x2="230" y1="263" y2="263"></line></g><g id="elem_MappedByteBuffer"><rect codeLine="3" fill="#F1F1F1" height="48" id="MappedByteBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="160" x="7" y="331"></rect><ellipse cx="22" cy="347" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M22.1094,342.3438 L20.9531,347.4219 L23.2813,347.4219 L22.1094,342.3438 Z M20.625,340.1094 L23.6094,340.1094 L26.9688,352.5 L24.5156,352.5 L23.75,349.4375 L20.4688,349.4375 L19.7188,352.5 L17.2813,352.5 L20.625,340.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="128" x="36" y="351.8467">MappedByteBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="8" x2="166" y1="363" y2="363"></line><line style="stroke:#181818;stroke-width:.5" x1="8" x2="166" y1="371" y2="371"></line></g><g id="elem_DirectByteBuffer"><rect codeLine="4" fill="#F1F1F1" height="48" id="DirectByteBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="145" x="14.5" y="439"></rect><ellipse cx="29.5" cy="455" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M29.6094,450.3438 L28.4531,455.4219 L30.7813,455.4219 L29.6094,450.3438 Z M28.125,448.1094 L31.1094,448.1094 L34.4688,460.5 L32.0156,460.5 L31.25,457.4375 L27.9688,457.4375 L27.2188,460.5 L24.7813,460.5 L28.125,448.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="113" x="43.5" y="459.8467">DirectByteBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="15.5" x2="158.5" y1="471" y2="471"></line><line style="stroke:#181818;stroke-width:.5" x1="15.5" x2="158.5" y1="479" y2="479"></line></g><g id="elem_HeapByteBuffer"><rect codeLine="5" fill="#F1F1F1" height="48" id="HeapByteBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="140" x="202" y="331"></rect><ellipse cx="217" cy="347" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M217.1094,342.3438 L215.9531,347.4219 L218.2813,347.4219 L217.1094,342.3438 Z M215.625,340.1094 L218.6094,340.1094 L221.9688,352.5 L219.5156,352.5 L218.75,349.4375 L215.4688,349.4375 L214.7188,352.5 L212.2813,352.5 L215.625,340.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="108" x="231" y="351.8467">HeapByteBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="203" x2="341" y1="363" y2="363"></line><line style="stroke:#181818;stroke-width:.5" x1="203" x2="341" y1="371" y2="371"></line></g><g id="elem_CharBuffer"><rect codeLine="7" fill="#F1F1F1" height="48" id="CharBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="105" x="258.5" y="7"></rect><ellipse cx="273.5" cy="23" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M273.6094,18.3438 L272.4531,23.4219 L274.7813,23.4219 L273.6094,18.3438 Z M272.125,16.1094 L275.1094,16.1094 L278.4688,28.5 L276.0156,28.5 L275.25,25.4375 L271.9688,25.4375 L271.2188,28.5 L268.7813,28.5 L272.125,16.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="73" x="287.5" y="27.8467">CharBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="259.5" x2="362.5" y1="39" y2="39"></line><line style="stroke:#181818;stroke-width:.5" x1="259.5" x2="362.5" y1="47" y2="47"></line></g><g id="elem_ShortBuffer"><rect codeLine="8" fill="#F1F1F1" height="48" id="ShortBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="110" x="129" y="115"></rect><ellipse cx="144" cy="131" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M144.1094,126.3438 L142.9531,131.4219 L145.2813,131.4219 L144.1094,126.3438 Z M142.625,124.1094 L145.6094,124.1094 L148.9688,136.5 L146.5156,136.5 L145.75,133.4375 L142.4688,133.4375 L141.7188,136.5 L139.2813,136.5 L142.625,124.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="78" x="158" y="135.8467">ShortBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="130" x2="238" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="130" x2="238" y1="155" y2="155"></line></g><g id="elem_IntBuffer"><rect codeLine="9" fill="#F1F1F1" height="48" id="IntBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="90" x="266" y="223"></rect><ellipse cx="281" cy="239" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M281.1094,234.3438 L279.9531,239.4219 L282.2813,239.4219 L281.1094,234.3438 Z M279.625,232.1094 L282.6094,232.1094 L285.9688,244.5 L283.5156,244.5 L282.75,241.4375 L279.4688,241.4375 L278.7188,244.5 L276.2813,244.5 L279.625,232.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="58" x="295" y="243.8467">IntBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="267" x2="355" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="267" x2="355" y1="263" y2="263"></line></g><g id="elem_FloatBuffer"><rect codeLine="10" fill="#F1F1F1" height="48" id="FloatBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="106" x="382" y="115"></rect><ellipse cx="397" cy="131" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M397.1094,126.3438 L395.9531,131.4219 L398.2813,131.4219 L397.1094,126.3438 Z M395.625,124.1094 L398.6094,124.1094 L401.9688,136.5 L399.5156,136.5 L398.75,133.4375 L395.4688,133.4375 L394.7188,136.5 L392.2813,136.5 L395.625,124.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="74" x="411" y="135.8467">FloatBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="383" x2="487" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="383" x2="487" y1="155" y2="155"></line></g><g id="elem_DoubleBuffer"><rect codeLine="11" fill="#F1F1F1" height="48" id="DoubleBuffer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="123" x="390.5" y="223"></rect><ellipse cx="405.5" cy="239" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M405.6094,234.3438 L404.4531,239.4219 L406.7813,239.4219 L405.6094,234.3438 Z M404.125,232.1094 L407.1094,232.1094 L410.4688,244.5 L408.0156,244.5 L407.25,241.4375 L403.9688,241.4375 L403.2188,244.5 L400.7813,244.5 L404.125,232.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="91" x="419.5" y="243.8467">DoubleBuffer</text><line style="stroke:#181818;stroke-width:.5" x1="391.5" x2="512.5" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="391.5" x2="512.5" y1="263" y2="263"></line></g><g id="link_CharBuffer_Buffer"><path codeLine="12" d="M311,55.26 C311,72.94 311,91.13 311,108.79 " fill="none" id="CharBuffer-to-Buffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="311,114.79,315,105.79,311,109.79,307,105.79,311,114.79" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_ShortBuffer_Buffer"><path codeLine="13" d="M239.07,139 C250.77,139 256.48,139 268.19,139 " fill="none" id="ShortBuffer-to-Buffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="274.19,139,265.19,135,269.19,139,265.19,143,274.19,139" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_Buffer_IntBuffer"><path codeLine="14" d="M311,169.26 C311,186.94 311,205.13 311,222.79 " fill="none" id="Buffer-backto-IntBuffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="311,163.26,307,172.26,311,168.26,315,172.26,311,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_Buffer_ByteBuffer"><path codeLine="15" d="M277.3523,167.0175 C255.3423,184.6975 229.89,205.13 207.9,222.79 " fill="none" id="Buffer-backto-ByteBuffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="282.03,163.26,272.5084,165.7777,278.1319,166.3912,277.5184,172.0147,282.03,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_Buffer_FloatBuffer"><path codeLine="16" d="M353.81,139 C365.05,139 370.29,139 381.53,139 " fill="none" id="Buffer-backto-FloatBuffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="347.81,139,356.81,143,352.81,139,356.81,135,347.81,139" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_Buffer_DoubleBuffer"><path codeLine="17" d="M346.7353,166.8662 C370.2453,184.5462 397.64,205.13 421.13,222.79 " fill="none" id="Buffer-backto-DoubleBuffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="341.94,163.26,346.7289,171.8662,345.9361,166.2652,351.5372,165.4724,341.94,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_ByteBuffer_MappedByteBuffer"><path codeLine="19" d="M154.8779,275.7919 C139.5379,293.4719 122.47,313.13 107.14,330.79 " fill="none" id="ByteBuffer-backto-MappedByteBuffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="158.81,271.26,149.8905,275.4365,155.5332,275.0366,155.9331,280.6793,158.81,271.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_MappedByteBuffer_DirectByteBuffer"><path codeLine="20" d="M87,385.26 C87,402.94 87,421.13 87,438.79 " fill="none" id="MappedByteBuffer-backto-DirectByteBuffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="87,379.26,83,388.26,87,384.26,91,388.26,87,379.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_ByteBuffer_HeapByteBuffer"><path codeLine="21" d="M203.3668,275.7704 C218.8768,293.4504 236.14,313.13 251.64,330.79 " fill="none" id="ByteBuffer-backto-HeapByteBuffer" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="199.41,271.26,202.3383,280.6635,202.7073,275.0187,208.3521,275.3877,199.41,271.26" style="stroke:#181818;stroke-width:1"></polygon></g></g></svg></div><h3>channel</h3><p>还有新的I/O抽象——Channel</p><div class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" preserveAspectRatio="none" version="1.1" viewBox="0 0 582 386" zoomAndPan="magnify"><defs></defs><g><g id="elem_Channel"><rect codeLine="1" fill="#F1F1F1" height="48" id="Channel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="89" x="246.5" y="7"></rect><ellipse cx="261.5" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M257.4219,18.7656 L257.4219,16.6094 L264.8125,16.6094 L264.8125,18.7656 L262.3438,18.7656 L262.3438,26.8438 L264.8125,26.8438 L264.8125,29 L257.4219,29 L257.4219,26.8438 L259.8906,26.8438 L259.8906,18.7656 L257.4219,18.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="57" x="275.5" y="27.8467">Channel</text><line style="stroke:#181818;stroke-width:.5" x1="247.5" x2="334.5" y1="39" y2="39"></line><line style="stroke:#181818;stroke-width:.5" x1="247.5" x2="334.5" y1="47" y2="47"></line></g><g id="elem_ReadableByteChannel"><rect codeLine="2" fill="#F1F1F1" height="48" id="ReadableByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="185" x="91.5" y="115"></rect><ellipse cx="106.5" cy="131" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M102.4219,126.7656 L102.4219,124.6094 L109.8125,124.6094 L109.8125,126.7656 L107.3438,126.7656 L107.3438,134.8438 L109.8125,134.8438 L109.8125,137 L102.4219,137 L102.4219,134.8438 L104.8906,134.8438 L104.8906,126.7656 L102.4219,126.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="153" x="120.5" y="135.8467">ReadableByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="92.5" x2="275.5" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="92.5" x2="275.5" y1="155" y2="155"></line></g><g id="elem_WritableByteChannel"><rect codeLine="3" fill="#F1F1F1" height="48" id="WritableByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="175" x="311.5" y="115"></rect><ellipse cx="326.5" cy="131" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M322.4219,126.7656 L322.4219,124.6094 L329.8125,124.6094 L329.8125,126.7656 L327.3438,126.7656 L327.3438,134.8438 L329.8125,134.8438 L329.8125,137 L322.4219,137 L322.4219,134.8438 L324.8906,134.8438 L324.8906,126.7656 L322.4219,126.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="143" x="340.5" y="135.8467">WritableByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="312.5" x2="485.5" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="312.5" x2="485.5" y1="155" y2="155"></line></g><g id="elem_ScatteringByteChannel"><rect codeLine="5" fill="#F1F1F1" height="48" id="ScatteringByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="190" x="7" y="223"></rect><ellipse cx="22" cy="239" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M17.9219,234.7656 L17.9219,232.6094 L25.3125,232.6094 L25.3125,234.7656 L22.8438,234.7656 L22.8438,242.8438 L25.3125,242.8438 L25.3125,245 L17.9219,245 L17.9219,242.8438 L20.3906,242.8438 L20.3906,234.7656 L17.9219,234.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="158" x="36" y="243.8467">ScatteringByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="8" x2="196" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="8" x2="196" y1="263" y2="263"></line></g><g id="elem_GatheringByteChannel"><rect codeLine="6" fill="#F1F1F1" height="48" id="GatheringByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="188" x="387" y="223"></rect><ellipse cx="402" cy="239" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M397.9219,234.7656 L397.9219,232.6094 L405.3125,232.6094 L405.3125,234.7656 L402.8438,234.7656 L402.8438,242.8438 L405.3125,242.8438 L405.3125,245 L397.9219,245 L397.9219,242.8438 L400.3906,242.8438 L400.3906,234.7656 L397.9219,234.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="156" x="416" y="243.8467">GatheringByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="388" x2="574" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="388" x2="574" y1="263" y2="263"></line></g><g id="elem_ByteChannel"><rect codeLine="8" fill="#F1F1F1" height="48" id="ByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="120" x="232" y="223"></rect><ellipse cx="247" cy="239" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M242.9219,234.7656 L242.9219,232.6094 L250.3125,232.6094 L250.3125,234.7656 L247.8438,234.7656 L247.8438,242.8438 L250.3125,242.8438 L250.3125,245 L242.9219,245 L242.9219,242.8438 L245.3906,242.8438 L245.3906,234.7656 L242.9219,234.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="88" x="261" y="243.8467">ByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="233" x2="351" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="233" x2="351" y1="263" y2="263"></line></g><g id="elem_SeekableByteChannel"><rect codeLine="9" fill="#F1F1F1" height="48" id="SeekableByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="184" x="200" y="331"></rect><ellipse cx="215" cy="347" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M210.9219,342.7656 L210.9219,340.6094 L218.3125,340.6094 L218.3125,342.7656 L215.8438,342.7656 L215.8438,350.8438 L218.3125,350.8438 L218.3125,353 L210.9219,353 L210.9219,350.8438 L213.3906,350.8438 L213.3906,342.7656 L210.9219,342.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="152" x="229" y="351.8467">SeekableByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="201" x2="383" y1="363" y2="363"></line><line style="stroke:#181818;stroke-width:.5" x1="201" x2="383" y1="371" y2="371"></line></g><g id="link_Channel_ReadableByteChannel"><path codeLine="11" d="M254.7349,67.9305 C236.8949,85.6105 225.25,97.13 207.43,114.79 " fill="none" id="Channel-backto-ReadableByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="267.52,55.26,250.5114,63.6688,258.9584,72.1922,267.52,55.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_Channel_WritableByteChannel"><path codeLine="12" d="M327.5451,67.8697 C345.5551,85.5497 357.36,97.13 375.35,114.79 " fill="none" id="Channel-backto-WritableByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="314.7,55.26,323.3418,72.1514,331.7483,63.588,314.7,55.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_ReadableByteChannel_ScatteringByteChannel"><path codeLine="14" d="M154.9898,177.4999 C141.3198,195.1799 133.61,205.13 119.95,222.79 " fill="none" id="ReadableByteChannel-backto-ScatteringByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="166,163.26,150.2432,173.8299,159.7365,181.17,166,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_WritableByteChannel_GatheringByteChannel"><path codeLine="15" d="M428.0102,177.4999 C441.6802,195.1799 449.39,205.13 463.05,222.79 " fill="none" id="WritableByteChannel-backto-GatheringByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="417,163.26,423.2635,181.17,432.7568,173.8299,417,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_ReadableByteChannel_ByteChannel"><path codeLine="17" d="M220.5451,175.8697 C238.5551,193.5497 250.36,205.13 268.35,222.79 " fill="none" id="ReadableByteChannel-backto-ByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="207.7,163.26,216.3418,180.1514,224.7483,171.588,207.7,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_WritableByteChannel_ByteChannel"><path codeLine="18" d="M362.7349,175.9305 C344.8949,193.6105 333.25,205.13 315.43,222.79 " fill="none" id="WritableByteChannel-backto-ByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="375.52,163.26,358.5114,171.6688,366.9584,180.1922,375.52,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_ByteChannel_SeekableByteChannel"><path codeLine="19" d="M292,289.26 C292,306.94 292,313.13 292,330.79 " fill="none" id="ByteChannel-backto-SeekableByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="292,271.26,286,289.26,298,289.26,292,271.26" style="stroke:#181818;stroke-width:1"></polygon></g></g></svg></div><p>新的文件FileChannel</p><div class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" preserveAspectRatio="none" version="1.1" viewBox="0 0 646 170" zoomAndPan="magnify"><defs></defs><g><g id="elem_ScatteringByteChannel"><rect codeLine="1" fill="#F1F1F1" height="48" id="ScatteringByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="190" x="7" y="115"></rect><ellipse cx="22" cy="131" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M17.9219,126.7656 L17.9219,124.6094 L25.3125,124.6094 L25.3125,126.7656 L22.8438,126.7656 L22.8438,134.8438 L25.3125,134.8438 L25.3125,137 L17.9219,137 L17.9219,134.8438 L20.3906,134.8438 L20.3906,126.7656 L17.9219,126.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="158" x="36" y="135.8467">ScatteringByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="8" x2="196" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="8" x2="196" y1="155" y2="155"></line></g><g id="elem_GatheringByteChannel"><rect codeLine="2" fill="#F1F1F1" height="48" id="GatheringByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="188" x="232" y="115"></rect><ellipse cx="247" cy="131" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M242.9219,126.7656 L242.9219,124.6094 L250.3125,124.6094 L250.3125,126.7656 L247.8438,126.7656 L247.8438,134.8438 L250.3125,134.8438 L250.3125,137 L242.9219,137 L242.9219,134.8438 L245.3906,134.8438 L245.3906,126.7656 L242.9219,126.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="156" x="261" y="135.8467">GatheringByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="233" x2="419" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="233" x2="419" y1="155" y2="155"></line></g><g id="elem_SeekableByteChannel"><rect codeLine="3" fill="#F1F1F1" height="48" id="SeekableByteChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="184" x="455" y="115"></rect><ellipse cx="470" cy="131" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M465.9219,126.7656 L465.9219,124.6094 L473.3125,124.6094 L473.3125,126.7656 L470.8438,126.7656 L470.8438,134.8438 L473.3125,134.8438 L473.3125,137 L465.9219,137 L465.9219,134.8438 L468.3906,134.8438 L468.3906,126.7656 L465.9219,126.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="152" x="484" y="135.8467">SeekableByteChannel</text><line style="stroke:#181818;stroke-width:.5" x1="456" x2="638" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="456" x2="638" y1="155" y2="155"></line></g><g id="elem_FileChannel"><rect codeLine="4" fill="#F1F1F1" height="48" id="FileChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="112" x="270" y="7"></rect><ellipse cx="285" cy="23" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M285.1094,18.3438 L283.9531,23.4219 L286.2813,23.4219 L285.1094,18.3438 Z M283.625,16.1094 L286.6094,16.1094 L289.9688,28.5 L287.5156,28.5 L286.75,25.4375 L283.4688,25.4375 L282.7188,28.5 L280.2813,28.5 L283.625,16.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="80" x="299" y="27.8467">FileChannel</text><line style="stroke:#181818;stroke-width:.5" x1="271" x2="381" y1="39" y2="39"></line><line style="stroke:#181818;stroke-width:.5" x1="271" x2="381" y1="47" y2="47"></line></g><g id="link_FileChannel_ScatteringByteChannel"><path codeLine="6" d="M276.56,55.39 C239.33,73.01 204.7792,89.3584 167.5792,106.9684 " fill="none" id="FileChannel-to-ScatteringByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="151.31,114.67,170.1464,112.3914,165.0119,101.5453,151.31,114.67" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_FileChannel_GatheringByteChannel"><path codeLine="7" d="M326,55.26 C326,72.94 326,79.13 326,96.79 " fill="none" id="FileChannel-to-GatheringByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="326,114.79,332,96.79,320,96.79,326,114.79" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_FileChannel_SeekableByteChannel"><path codeLine="8" d="M374.77,55.39 C411.51,73.01 445.4216,89.273 482.1216,106.883 " fill="none" id="FileChannel-to-SeekableByteChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="none" points="498.35,114.67,484.7172,101.4735,479.5259,112.2925,498.35,114.67" style="stroke:#181818;stroke-width:1"></polygon></g></g></svg></div><p>FileChannel中提供了各种基于操作系统接口的传输功能：</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight java" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于mmap的文件映射</span></span><br><span class="line">MappedByteBuffer FileChannel.map(MapMode mode, <span class="type">long</span> position, <span class="type">long</span> size)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于sendfile的文件发送</span></span><br><span class="line"><span class="keyword">try</span>(<span class="type">FileChannel</span> <span class="variable">in</span> <span class="operator">=</span> FileChannel.open(source, StandardOpenOption.READ);</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">out</span> <span class="operator">=</span> FileChannel.open(target, StandardOpenOption.WRITE) <span class="comment">// out也可以是SocketChannel</span></span><br><span class="line">){</span><br><span class="line">    <span class="comment">// 将根据操作系统的兼容性选择sendfile,mmap,read/write</span></span><br><span class="line">    in.transferTo(<span class="number">0</span>, in.size(), out);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure><p>与文件I/O接口统一的网络I/O：</p><div class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" preserveAspectRatio="none" version="1.1" viewBox="0 0 628 278" zoomAndPan="magnify"><defs></defs><g><g id="elem_Channel"><rect codeLine="1" fill="#F1F1F1" height="48" id="Channel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="89" x="319" y="7"></rect><ellipse cx="334" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M329.9219,18.7656 L329.9219,16.6094 L337.3125,16.6094 L337.3125,18.7656 L334.8438,18.7656 L334.8438,26.8438 L337.3125,26.8438 L337.3125,29 L329.9219,29 L329.9219,26.8438 L332.3906,26.8438 L332.3906,18.7656 L329.9219,18.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="57" x="348" y="27.8467">Channel</text><line style="stroke:#181818;stroke-width:.5" x1="320" x2="407" y1="39" y2="39"></line><line style="stroke:#181818;stroke-width:.5" x1="320" x2="407" y1="47" y2="47"></line></g><g id="elem_NetworkChannel"><rect codeLine="2" fill="#F1F1F1" height="48" id="NetworkChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="146" x="290.5" y="115"></rect><ellipse cx="305.5" cy="131" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M301.4219,126.7656 L301.4219,124.6094 L308.8125,124.6094 L308.8125,126.7656 L306.3438,126.7656 L306.3438,134.8438 L308.8125,134.8438 L308.8125,137 L301.4219,137 L301.4219,134.8438 L303.8906,134.8438 L303.8906,126.7656 L301.4219,126.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="114" x="319.5" y="135.8467">NetworkChannel</text><line style="stroke:#181818;stroke-width:.5" x1="291.5" x2="435.5" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="291.5" x2="435.5" y1="155" y2="155"></line></g><g id="elem_MulticastChannel"><rect codeLine="3" fill="#F1F1F1" height="48" id="MulticastChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="150" x="471.5" y="115"></rect><ellipse cx="486.5" cy="131" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M482.4219,126.7656 L482.4219,124.6094 L489.8125,124.6094 L489.8125,126.7656 L487.3438,126.7656 L487.3438,134.8438 L489.8125,134.8438 L489.8125,137 L482.4219,137 L482.4219,134.8438 L484.8906,134.8438 L484.8906,126.7656 L482.4219,126.7656 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="118" x="500.5" y="135.8467">MulticastChannel</text><line style="stroke:#181818;stroke-width:.5" x1="472.5" x2="620.5" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="472.5" x2="620.5" y1="155" y2="155"></line></g><g id="elem_SelectableChannel"><rect codeLine="4" fill="#F1F1F1" height="48" id="SelectableChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="161" x="94" y="115"></rect><ellipse cx="109" cy="131" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M109.1094,126.3438 L107.9531,131.4219 L110.2813,131.4219 L109.1094,126.3438 Z M107.625,124.1094 L110.6094,124.1094 L113.9688,136.5 L111.5156,136.5 L110.75,133.4375 L107.4688,133.4375 L106.7188,136.5 L104.2813,136.5 L107.625,124.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="129" x="123" y="135.8467">SelectableChannel</text><line style="stroke:#181818;stroke-width:.5" x1="95" x2="254" y1="147" y2="147"></line><line style="stroke:#181818;stroke-width:.5" x1="95" x2="254" y1="155" y2="155"></line></g><g id="elem_SocketChannel"><rect codeLine="5" fill="#F1F1F1" height="48" id="SocketChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="137" x="7" y="223"></rect><ellipse cx="22" cy="239" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M22.1094,234.3438 L20.9531,239.4219 L23.2813,239.4219 L22.1094,234.3438 Z M20.625,232.1094 L23.6094,232.1094 L26.9688,244.5 L24.5156,244.5 L23.75,241.4375 L20.4688,241.4375 L19.7188,244.5 L17.2813,244.5 L20.625,232.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="105" x="36" y="243.8467">SocketChannel</text><line style="stroke:#181818;stroke-width:.5" x1="8" x2="143" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="8" x2="143" y1="263" y2="263"></line></g><g id="elem_ServerSocketChannel"><rect codeLine="6" fill="#F1F1F1" height="48" id="ServerSocketChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="181" x="179" y="223"></rect><ellipse cx="194" cy="239" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M194.1094,234.3438 L192.9531,239.4219 L195.2813,239.4219 L194.1094,234.3438 Z M192.625,232.1094 L195.6094,232.1094 L198.9688,244.5 L196.5156,244.5 L195.75,241.4375 L192.4688,241.4375 L191.7188,244.5 L189.2813,244.5 L192.625,232.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="149" x="208" y="243.8467">ServerSocketChannel</text><line style="stroke:#181818;stroke-width:.5" x1="180" x2="359" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="180" x2="359" y1="263" y2="263"></line></g><g id="elem_DatagramChannel"><rect codeLine="7" fill="#F1F1F1" height="48" id="DatagramChannel" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="156" x="395.5" y="223"></rect><ellipse cx="410.5" cy="239" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1"></ellipse><path d="M410.6094,234.3438 L409.4531,239.4219 L411.7813,239.4219 L410.6094,234.3438 Z M409.125,232.1094 L412.1094,232.1094 L415.4688,244.5 L413.0156,244.5 L412.25,241.4375 L408.9688,241.4375 L408.2188,244.5 L405.7813,244.5 L409.125,232.1094 Z " fill="#000000"></path><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="124" x="424.5" y="243.8467">DatagramChannel</text><line style="stroke:#181818;stroke-width:.5" x1="396.5" x2="550.5" y1="255" y2="255"></line><line style="stroke:#181818;stroke-width:.5" x1="396.5" x2="550.5" y1="263" y2="263"></line></g><g id="link_Channel_NetworkChannel"><path codeLine="8" d="M363.5,61.26 C363.5,78.94 363.5,97.13 363.5,114.79 " fill="none" id="Channel-backto-NetworkChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="363.5,55.26,359.5,64.26,363.5,60.26,367.5,64.26,363.5,55.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_Channel_SelectableChannel"><path codeLine="9" d="M316.7868,58.1949 C285.3868,75.8049 247.67,96.97 216.21,114.61 " fill="none" id="Channel-backto-SelectableChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="322.02,55.26,312.2136,56.1736,317.659,57.7058,316.1268,63.1512,322.02,55.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_Channel_MulticastChannel"><path codeLine="10" d="M408.8522,58.2668 C439.2622,75.8768 475.66,96.97 506.12,114.61 " fill="none" id="Channel-backto-MulticastChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="403.66,55.26,409.4439,63.2316,407.9869,57.7656,413.4529,56.3086,403.66,55.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_SelectableChannel_SocketChannel"><path codeLine="11" d="M148.6763,167.6465 C132.1763,185.3265 113.67,205.13 97.18,222.79 " fill="none" id="SelectableChannel-backto-SocketChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="152.77,163.26,143.7051,167.1106,149.3586,166.9154,149.5537,172.5689,152.77,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_SelectableChannel_ServerSocketChannel"><path codeLine="12" d="M199.3537,167.7288 C215.1937,185.4088 232.87,205.13 248.7,222.79 " fill="none" id="SelectableChannel-backto-ServerSocketChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="195.35,163.26,198.3764,172.6324,198.6864,166.984,204.3348,167.2941,195.35,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_SelectableChannel_DatagramChannel"><path codeLine="13" d="M246.1451,165.3951 C295.7551,182.9851 357.79,204.98 407.42,222.57 " fill="none" id="SelectableChannel-backto-DatagramChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="240.49,163.39,247.6359,170.1677,245.2025,165.0609,250.3093,162.6276,240.49,163.39" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_NetworkChannel_SocketChannel"><path codeLine="14" d="M294.3093,165.4625 C246.4393,183.0825 186.73,205.06 138.9,222.67 " fill="none" id="NetworkChannel-backto-SocketChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="299.94,163.39,290.1123,162.745,295.2478,165.1171,292.8757,170.2526,299.94,163.39" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_NetworkChannel_ServerSocketChannel"><path codeLine="15" d="M338.8903,167.7502 C323.2203,185.4302 305.74,205.13 290.08,222.79 " fill="none" id="NetworkChannel-backto-ServerSocketChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="342.87,163.26,333.907,167.3422,339.5536,167.0018,339.8939,172.6484,342.87,163.26" style="stroke:#181818;stroke-width:1"></polygon></g><g id="link_NetworkChannel_DatagramChannel"><path codeLine="16" d="M391.9597,167.4242 C410.2997,185.1042 431.09,205.13 449.42,222.79 " fill="none" id="NetworkChannel-backto-DatagramChannel" style="stroke:#181818;stroke-width:1"></path><polygon fill="#181818" points="387.64,163.26,391.3433,172.3861,391.2397,166.7302,396.8956,166.6265,387.64,163.26" style="stroke:#181818;stroke-width:1"></polygon></g></g></svg></div><h3>selector</h3><p>基于I/O多路复用的Selector。SelectorProvider会根据不同的操作系统，选用epoll(linux)，kqueue(macOSx)，wepoll(windows)和兼容性更好的poll(unix/windows)。JDK的好处就是不用关心底层到底使用哪种实现，java程序猿真幸福😊。</p><figure class="codeblock codeblock--tabbed"><figcaption><ul class="tabs"><li class="tab active">java</li></ul></figcaption><div class="tabs-content"><figure class="highlight java" style="display:block"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoServer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">5454</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CLOSE_ACTION</span> <span class="operator">=</span> <span class="string">"close"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocket</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverSocket.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(PORT));</span><br><span class="line">        serverSocket.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        serverSocket.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        System.out.println(<span class="string">"server bind on "</span> + serverSocket.getLocalAddress());</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">256</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iter = selectedKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) {</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iter.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) {</span><br><span class="line">                    onAccept(key);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (key.isReadable()) {</span><br><span class="line">                    onRead(buffer, key);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> must remove</span></span><br><span class="line">                iter.remove();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">onAccept</span><span class="params">(SelectionKey key)</span> {</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">server</span> <span class="operator">=</span> (ServerSocketChannel) key.channel();</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> server.accept();</span><br><span class="line">        client.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        client.register(key.selector(), SelectionKey.OP_READ);</span><br><span class="line">        System.out.println(<span class="string">"accept new client from "</span> + client.getLocalAddress());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">onRead</span><span class="params">(ByteBuffer buffer, SelectionKey key)</span> {</span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">client</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">        client.read(buffer);</span><br><span class="line">        <span class="type">String</span> <span class="variable">receiveString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(buffer.array());</span><br><span class="line">        System.out.println(<span class="string">"Receive string: "</span> + receiveString);</span><br><span class="line">        <span class="keyword">if</span> (CLOSE_ACTION.equals(receiveString.trim())) {</span><br><span class="line">            client.close();</span><br><span class="line">            System.out.println(<span class="string">"Not accepting client messages anymore"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            buffer.flip();</span><br><span class="line">            client.write(buffer);</span><br><span class="line">            buffer.clear();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></figure><h2>Netty, Mina</h2><p>JDK的NIO并不是那么好用，JDK并没有基于NIO实现HTTP等各种协议，而是通过制定servlet api让<a target="_blank" rel="noopener" href="https://github.com/apache/tomcat">Tomcat</a>、<a target="_blank" rel="noopener" href="https://github.com/eclipse/jetty.project">Jetty</a>去实现HTTP协议，具体Servlet容器有没有用NIO去实现，Servlet也不管。因为NIO的一些问题，就有了<a target="_blank" rel="noopener" href="https://github.com/xnio/xnio">xnio</a>这样实现HTTP、SSL的项目，另一个比较有名的Servlet容器<a target="_blank" rel="noopener" href="https://github.com/undertow-io/undertow">undertow</a>就是基于xnio实现的，但是xnio文档真的很烂。而<a target="_blank" rel="noopener" href="https://github.com/apache/mina">Mina</a>和Netty是脱离Servlet标准自己实现的HTTP等协议，其中<a target="_blank" rel="noopener" href="https://github.com/netty/netty">Netty</a>甚至完全脱离JDK的NIO，基于Linux的epoll、BSD的kqueue通过JNI自行实现了一套IO-Multiplex。而且相对Mina来说Netty架构更加干净，模块划分更加清晰。</p><p><img src="https://netty.io/images/components.png"></p><p>有兴趣的可以看<a target="_blank" rel="noopener" href="https://github.com/eugenp/tutorials/blob/master/netty/README.md">netty 相关的教程</a></p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none;padding-left:0;margin-left:40px"><li id="fn:1"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">1.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://baike.baidu.com/item/%E5%8D%97%E5%8C%97%E6%A1%A5 南北桥<a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">2.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Northbridge_%28computing%29 Northbridge<a href="#fnref:2" rev="footnote"> ↩</a></span></li><li id="fn:3"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">3.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Northbridge_%28computing%29 Southbridge<a href="#fnref:3" rev="footnote"> ↩</a></span></li><li id="fn:4"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">4.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Platform_Controller_Hub Platform Controller Hub<a href="#fnref:4" rev="footnote"> ↩</a></span></li><li id="fn:5"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">5.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Programmed_input%E2%80%93output Programmed input–output<a href="#fnref:5" rev="footnote"> ↩</a></span></li><li id="fn:6"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">6.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Input/output_base_address Input/output base address<a href="#fnref:6" rev="footnote"> ↩</a></span></li><li id="fn:7"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">7.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Memory-mapped_I/O Memory-mapped I/O<a href="#fnref:7" rev="footnote"> ↩</a></span></li><li id="fn:8"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">8.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Interrupt Interrupt<a href="#fnref:8" rev="footnote"> ↩</a></span></li><li id="fn:9"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">9.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://c9x.me/x86/html/file_module_x86_id_139.html x86 in Instruction<a href="#fnref:9" rev="footnote"> ↩</a></span></li><li id="fn:10"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">10.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://c9x.me/x86/html/file_module_x86_id_222.html x86 out Instruction<a href="#fnref:10" rev="footnote"> ↩</a></span></li><li id="fn:11"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">11.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Direct_memory_access Direct memory access<a href="#fnref:11" rev="footnote"> ↩</a></span></li><li id="fn:12"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">12.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Intel_8086 Intel 8086<a href="#fnref:12" rev="footnote"> ↩</a></span></li><li id="fn:13"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">13.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/X86_memory_segmentation X86 memory segmentation<a href="#fnref:13" rev="footnote"> ↩</a></span></li><li id="fn:14"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">14.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Intel_80286 Intel 80286<a href="#fnref:14" rev="footnote"> ↩</a></span></li><li id="fn:15"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">15.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Protected_mode Protected Mode<a href="#fnref:15" rev="footnote"> ↩</a></span></li><li id="fn:16"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">16.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Memory_paging Memory Paging<a href="#fnref:16" rev="footnote"> ↩</a></span></li><li id="fn:17"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">17.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Page_table Page Table<a href="#fnref:17" rev="footnote"> ↩</a></span></li><li id="fn:18"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">18.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Page_replacement_algorithm Page replacement algorithm<a href="#fnref:18" rev="footnote"> ↩</a></span></li><li id="fn:19"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">19.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Virtual_memory Virtual Memory<a href="#fnref:19" rev="footnote"> ↩</a></span></li><li id="fn:20"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">20.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Real_mode Real Mode<a href="#fnref:20" rev="footnote"> ↩</a></span></li><li id="fn:21"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">21.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Bootloader BootLoader<a href="#fnref:21" rev="footnote"> ↩</a></span></li><li id="fn:22"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">22.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Protection_ring Protection ring<a href="#fnref:22" rev="footnote"> ↩</a></span></li><li id="fn:23"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">23.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Protection_ring#IOPL Privilege level<a href="#fnref:23" rev="footnote"> ↩</a></span></li><li id="fn:24"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">24.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/System_Management_Mode System Management Mode<a href="#fnref:24" rev="footnote"> ↩</a></span></li><li id="fn:24"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">24.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/System_call System Call<a href="#fnref:24" rev="footnote"> ↩</a></span></li><li id="fn:25"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">25.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Page_cache Page Cache<a href="#fnref:25" rev="footnote"> ↩</a></span></li><li id="fn:26"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">26.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Mmap mmap<a href="#fnref:26" rev="footnote"> ↩</a></span></li><li id="fn:27"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">27.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://man7.org/linux/man-pages/man2/open.2.html open file<a href="#fnref:27" rev="footnote"> ↩</a></span></li><li id="fn:28"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">28.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://www.freebsd.org/cgi/man.cgi?query=open&amp;sektion=2&amp;format=html FreeBSD open flag O_DIRECT<a href="#fnref:28" rev="footnote"> ↩</a></span></li><li id="fn:29"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">29.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Disk_buffer DIsk Buffer<a href="#fnref:29" rev="footnote"> ↩</a></span></li><li id="fn:30"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">30.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://man7.org/linux/man-pages/man2/sendfile.2.html sendfile<a href="#fnref:30" rev="footnote"> ↩</a></span></li><li id="fn:31"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">31.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Select_%28Unix%29 Unix Select API<a href="#fnref:31" rev="footnote"> ↩</a></span></li><li id="fn:32"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">32.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Epoll Epoll<a href="#fnref:32" rev="footnote"> ↩</a></span></li><li id="fn:33"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">33.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Kqueue Kqueue<a href="#fnref:33" rev="footnote"> ↩</a></span></li><li id="fn:34"><span style="display:inline-block;vertical-align:top;padding-right:10px;margin-left:-40px">34.</span><span style="display:inline-block;vertical-align:top;margin-left:10px">https://en.wikipedia.org/wiki/Input/output_completion_port IOCP<a href="#fnref:34" rev="footnote"> ↩</a></span></li></ol></div></div></div><div class="article-copyright"><p>本作品采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a> 进行许可。</p><p>转载时请注明<a href="https://blog.hufeifei.cn/2021/06/Java/nio/">原文链接</a>：https://blog.hufeifei.cn/2021/06/Java/nio/</p></div><footer class="article-footer"><div class="article-tag"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IO-Multiplex/" rel="tag">IO-Multiplex</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JAVA/" rel="tag">JAVA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NIO/" rel="tag">NIO</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kqueue/" rel="tag">kqueue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/libev/" rel="tag">libev</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/libevent/" rel="tag">libevent</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/libuv/" rel="tag">libuv</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/poll/" rel="tag">poll</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/select/" rel="tag">select</a></li></ul></div></footer></div><div id="article-reward"><i class="iconfont ic-money"></i><div>鼓励一下</div><table><thead><tr><th style="text-align:center">支付宝</th><th style="text-align:center">微信</th></tr></thead><tbody><tr><td style="text-align:center"><img width="150" src="https://www.hufeifei.cn/reward-img/alipay.jpg"></td><td style="text-align:center"><img width="135" src="https://www.hufeifei.cn/reward-img/wechat.jpg"></td></tr></tbody></table></div><nav id="article-nav"><a class="article-nav-link-wrap" href="/2021/06/economic/china_economic/" id="article-nav-newer"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">《解读中国经济》读后感</div></a><a class="article-nav-link-wrap" href="/2021/06/DB/how-datebases-work/" id="article-nav-older"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">【译】关系型数据库是如何工作的</div></a></nav></article><div id="waline-comments"></div><script type="module">import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';init({"el":"#waline-comments","pageview":true,"enable":true,"serverURL":"https://api.waline.blog.hufeifei.cn","avatar":"mp","pageSize":10,"lang":"zh-cn","placeholder":"Just go go","visitor":true,"recordIP":true,"requiredFields":["nick"]});</script></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">关注微信公众号</h3><div class="widget wechat"><img src="//www.hufeifei.cn/wechat-public-account.jpg"></div></div><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C&C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/J2EE/">J2EE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux%E8%BF%90%E7%BB%B4/">Linux运维</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/">Ruby</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Rust/">Rust</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E6%97%A5%E5%B8%B8/">代码日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%95%86%E4%B8%9A/">商业</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E6%B5%8E%E4%B8%8E%E9%87%91%E8%9E%8D/">经济与金融</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/">计算机组成</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/AVL/" style="font-size:11.11px">AVL</a> <a href="/tags/Alibaba/" style="font-size:14.44px">Alibaba</a> <a href="/tags/Android/" style="font-size:18.89px">Android</a> <a href="/tags/B-Tree/" style="font-size:12.22px">B-Tree</a> <a href="/tags/BKD-Tree/" style="font-size:10px">BKD-Tree</a> <a href="/tags/BST/" style="font-size:10px">BST</a> <a href="/tags/BigData/" style="font-size:11.11px">BigData</a> <a href="/tags/C/" style="font-size:14.44px">C</a> <a href="/tags/CGlib/" style="font-size:10px">CGlib</a> <a href="/tags/CS/" style="font-size:11.11px">CS</a> <a href="/tags/Canal/" style="font-size:10px">Canal</a> <a href="/tags/ClassLoader/" style="font-size:10px">ClassLoader</a> <a href="/tags/ClickHouse/" style="font-size:10px">ClickHouse</a> <a href="/tags/Config/" style="font-size:10px">Config</a> <a href="/tags/Cryptography/" style="font-size:10px">Cryptography</a> <a href="/tags/DB/" style="font-size:20px">DB</a> <a href="/tags/Dapper/" style="font-size:10px">Dapper</a> <a href="/tags/DataStructure/" style="font-size:14.44px">DataStructure</a> <a href="/tags/Debezium/" style="font-size:10px">Debezium</a> <a href="/tags/Diamond/" style="font-size:10px">Diamond</a> <a href="/tags/Distributed/" style="font-size:13.33px">Distributed</a> <a href="/tags/ElasticSearch/" style="font-size:10px">ElasticSearch</a> <a href="/tags/Encoding/" style="font-size:10px">Encoding</a> <a href="/tags/FastJson/" style="font-size:10px">FastJson</a> <a href="/tags/File/" style="font-size:10px">File</a> <a href="/tags/FlowMarketing/" style="font-size:10px">FlowMarketing</a> <a href="/tags/Grade/" style="font-size:10px">Grade</a> <a href="/tags/Gson/" style="font-size:10px">Gson</a> <a href="/tags/HTTP/" style="font-size:10px">HTTP</a> <a href="/tags/Handler/" style="font-size:10px">Handler</a> <a href="/tags/Hanlder/" style="font-size:10px">Hanlder</a> <a href="/tags/Hessian/" style="font-size:10px">Hessian</a> <a href="/tags/IO-Multiplex/" style="font-size:10px">IO-Multiplex</a> <a href="/tags/JAVA/" style="font-size:18.89px">JAVA</a> <a href="/tags/JVM/" style="font-size:10px">JVM</a> <a href="/tags/KD-Tree/" style="font-size:10px">KD-Tree</a> <a href="/tags/KDB-Tree/" style="font-size:10px">KDB-Tree</a> <a href="/tags/Kafka/" style="font-size:10px">Kafka</a> <a href="/tags/Kubernetes/" style="font-size:10px">Kubernetes</a> <a href="/tags/LSM-Tree/" style="font-size:11.11px">LSM-Tree</a> <a href="/tags/Linux/" style="font-size:17.78px">Linux</a> <a href="/tags/Lock/" style="font-size:11.11px">Lock</a> <a href="/tags/Lucene/" style="font-size:10px">Lucene</a> <a href="/tags/MQ/" style="font-size:10px">MQ</a> <a href="/tags/Macro/" style="font-size:10px">Macro</a> <a href="/tags/Magisk/" style="font-size:10px">Magisk</a> <a href="/tags/MultiDex/" style="font-size:10px">MultiDex</a> <a href="/tags/MySQL/" style="font-size:17.78px">MySQL</a> <a href="/tags/NIO/" style="font-size:10px">NIO</a> <a href="/tags/Nginx/" style="font-size:11.11px">Nginx</a> <a href="/tags/OGNL/" style="font-size:10px">OGNL</a> <a href="/tags/OpenResty/" style="font-size:10px">OpenResty</a> <a href="/tags/OpenTelemetry/" style="font-size:10px">OpenTelemetry</a> <a href="/tags/Oracle/" style="font-size:10px">Oracle</a> <a href="/tags/PostgreSQL/" style="font-size:10px">PostgreSQL</a> <a href="/tags/RB-Tree/" style="font-size:10px">RB-Tree</a> <a href="/tags/Redis/" style="font-size:10px">Redis</a> <a href="/tags/Rust/" style="font-size:10px">Rust</a> <a href="/tags/Sharding/" style="font-size:10px">Sharding</a> <a href="/tags/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size:10px">SpringCloud</a> <a href="/tags/SpringCloudConfig/" style="font-size:10px">SpringCloudConfig</a> <a href="/tags/Sqlite/" style="font-size:10px">Sqlite</a> <a href="/tags/SurfaceView/" style="font-size:10px">SurfaceView</a> <a href="/tags/VSCode/" style="font-size:11.11px">VSCode</a> <a href="/tags/WebFlux/" style="font-size:10px">WebFlux</a> <a href="/tags/WebPush/" style="font-size:10px">WebPush</a> <a href="/tags/Web%E6%8C%96%E6%8E%98/" style="font-size:11.11px">Web挖掘</a> <a href="/tags/awk/" style="font-size:10px">awk</a> <a href="/tags/bit-hack/" style="font-size:10px">bit-hack</a> <a href="/tags/cheat-sheet/" style="font-size:10px">cheat sheet</a> <a href="/tags/curl/" style="font-size:10px">curl</a> <a href="/tags/epoll/" style="font-size:10px">epoll</a> <a href="/tags/gRPC/" style="font-size:10px">gRPC</a> <a href="/tags/grep/" style="font-size:10px">grep</a> <a href="/tags/kqueue/" style="font-size:10px">kqueue</a> <a href="/tags/libev/" style="font-size:10px">libev</a> <a href="/tags/libevent/" style="font-size:10px">libevent</a> <a href="/tags/libuv/" style="font-size:10px">libuv</a> <a href="/tags/metaq/" style="font-size:10px">metaq</a> <a href="/tags/poll/" style="font-size:10px">poll</a> <a href="/tags/sed/" style="font-size:10px">sed</a> <a href="/tags/select/" style="font-size:10px">select</a> <a href="/tags/ssh/" style="font-size:10px">ssh</a> <a href="/tags/%E5%8E%86%E5%8F%B2/" style="font-size:10px">历史</a> <a href="/tags/%E5%95%86%E4%B8%9A/" style="font-size:10px">商业</a> <a href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size:10px">心理学</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size:11.11px">生活</a> <a href="/tags/%E7%A8%8E%E6%94%B6/" style="font-size:10px">税收</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:14.44px">算法</a> <a href="/tags/%E7%BB%8F%E6%B5%8E/" style="font-size:15.56px">经济</a> <a href="/tags/%E8%90%A5%E9%94%80/" style="font-size:10px">营销</a> <a href="/tags/%E8%B4%A7%E5%B8%81/" style="font-size:10px">货币</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size:16.67px">随笔</a></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/04/economic/value-added-tax/">增值税与贫富差距</a></li><li><a href="/2024/01/Net/x-forward-for/">“真”的IP真的是真的吗？</a></li><li><a href="/2024/01/paper/MarkupLM-web-extract/">【译】基于MarkupLM的web数据抽取</a></li><li><a href="/2023/09/economic/tax-reform/">直接税改革——王朝周期律的胜负手</a></li><li><a href="/2023/09/Rust/macro-rules-learning/">Rust中的宏</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">网站运营不易</h3><div class="ads-wrapper"><div class="google_ads"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7111912103882824" data-ad-slot="8429272980" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></aside></div><footer id="footer"><div class="outer"><div class="inner" id="footer-info"><p><a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备17009276号</a><i class="far fa-copyright"></i>2016 ~ 2024 胡飞飞</p><p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><i class="fas fa-angle-right"></i>Theme by <a target="_blank" rel="noopener" href="https://github.com/holmofy/hexo-theme-paper">paper</a></p></div></div></footer></div><nav id="mobile-nav"><a class="mobile-nav-link" href="//www.hufeifei.cn">主页</a><a class="mobile-nav-link" href="/">博客</a><a class="mobile-nav-link" href="/archives">归档</a><a class="mobile-nav-link" target="_blank" rel="noopener" href="//algo.hufeifei.cn">算法</a><a class="mobile-nav-link" href="/book">书籍</a><a class="mobile-nav-link" href="/github">Github</a></nav><script src="//cdnjs.loli.net/ajax/libs/jquery/3.0.0/jquery.min.js"></script><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/script.js"></script></div><script>
  $(document).ready(function() {
    $('figure.codeblock').find('.tab').click(function() {
        var $codeblock = $(this).parent().parent().parent();
        var $tab = $(this);
        // remove "active" css class on all tabs
        $tab.siblings().removeClass('active');
        // add "active" css class on the clicked tab
        $tab.addClass('active');
        // hide all tab contents
        $codeblock.find('.highlight').hide();
        // show only the right one
        $codeblock.find('.highlight.' + $tab.text()).show();
    });
  });
  </script><script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'BPJzNs1QEtbYa3Bn0gMAQHBAzX3Jm71llGUKHTkKEUs3D9xiDYZ0DWJ3S9sfCAAJHxXEoBkUANFyONjeIlgrJUo'' });</script></body></html>