<!doctype html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-H58NSPXYPF"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-H58NSPXYPF")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?b3392fb5f6d65fb10354f590338d1ee4",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(t,e,n,c,a,i){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/95vxjpui4h",(i=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,i)}(window,document,"clarity","script")</script><title>基于Binlog的实时同步功能——debezium、canel、databus技术选型 | holmofy</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="baidu_union_verify" content="b7d27ec946758934fcdf3c5c26386237"><meta description="大厂这段时间学到的最有价值的两个技术除了大数据，另一个就是基于CDC和消息队列的实时同步技术。 去年的一篇文章大致地讲了我对MQ的一些认识，事实上Kafka在内的现代MQ，功能远不止这些。后面整理好自己的思路，肯定会再写一篇文章来讲讲。这篇文章的主角就是与MQ息息相关的CDC技术。"><meta property="og:type" content="article"><meta property="og:title" content="基于Binlog的实时同步功能——debezium、canel、databus技术选型"><meta property="og:url" content="https://blog.hufeifei.cn/2021/03/DB/mysql-binlog-parser/index.html"><meta property="og:site_name" content="holmofy"><link rel="canonical" href="https://blog.hufeifei.cn/2021/03/DB/mysql-binlog-parser/index.html"><meta property="description" content="大厂这段时间学到的最有价值的两个技术除了大数据，另一个就是基于CDC和消息队列的实时同步技术。 去年的一篇文章大致地讲了我对MQ的一些认识，事实上Kafka在内的现代MQ，功能远不止这些。后面整理好自己的思路，肯定会再写一篇文章来讲讲。这篇文章的主角就是与MQ息息相关的CDC技术。"><meta name="description" content="大厂这段时间学到的最有价值的两个技术除了大数据，另一个就是基于CDC和消息队列的实时同步技术。 去年的一篇文章大致地讲了我对MQ的一些认识，事实上Kafka在内的现代MQ，功能远不止这些。后面整理好自己的思路，肯定会再写一篇文章来讲讲。这篇文章的主角就是与MQ息息相关的CDC技术。"><meta property="og:description" content="大厂这段时间学到的最有价值的两个技术除了大数据，另一个就是基于CDC和消息队列的实时同步技术。 去年的一篇文章大致地讲了我对MQ的一些认识，事实上Kafka在内的现代MQ，功能远不止这些。后面整理好自己的思路，肯定会再写一篇文章来讲讲。这篇文章的主角就是与MQ息息相关的CDC技术。"><meta property="article:published_time" content="2021-03-12T16:00:00.000Z"><meta property="article:modified_time" content="2024-05-03T05:17:06.687Z"><meta property="article:author" content="胡飞飞"><meta property="article:tag" content="Debezium"><meta property="article:tag" content="Canal"><meta property="article:tag" content="binlog同步"><meta property="keywords" content="Debezium,Canal,binlog同步"><meta property="twitter:card" content="summary"><script data-ad-client="ca-pub-7111912103882824" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7111912103882824" crossorigin="anonymous"></script><script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script><script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async defer></script><link rel="alternate" href="/atom.xml" title="holmofy" type="application/atom+xml"><link rel="icon" href="//www.hufeifei.cn/favicon.jpg"><link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"><link href="//unpkg.com/@waline/client@v3/dist/waline.css" rel="stylesheet" type="text/css"><link href="//at.alicdn.com/t/font_841402_efkj8jo1xld.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/font-awesome/5.15.3/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/style.css"><link rel="dns-prefetch" href="//static.zhimg.com"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdn.jsdelivr.net"><link rel="dns-prefetch" href="//img-blog.csdn.net"><link rel="dns-prefetch" href="//img-blog.csdnimg.cn"><meta name="generator" content="Hexo 6.3.0"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><style>
    figure.codeblock {
       margin: 0;
    }
    figure figcaption .tabs {
      display: flex;
      margin: 0;
    }
    figure figcaption .tabs .tab {
      cursor: pointer;
      list-style: none;
      padding: 5px 15px;
    }
    figure figcaption .tabs .tab.active {
      background: #2d2d2d;
      color: white;
    }
  </style></head><body><amp-auto-ads type="adsense" data-ad-client="ca-pub-7111912103882824"></amp-auto-ads><div id="container"><div id="wrap"><header id="header"><div class="outer" id="header-outer"><div class="inner" id="header-inner"><nav id="main-nav"><a class="nav-icon" id="main-nav-toggle"><i class="fas fa-bars"></i></a><a class="main-nav-link" href="//www.hufeifei.cn">主页</a><a class="main-nav-link" href="/">博客</a><a class="main-nav-link" href="/archives">归档</a><a class="main-nav-link" target="_blank" rel="noopener" href="//algo.hufeifei.cn">算法</a><a class="main-nav-link" href="/book">书籍</a><a class="main-nav-link" href="/github">Github</a></nav><nav id="sub-nav"><a class="nav-icon" id="nav-rss-link" href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a><a class="nav-icon" id="nav-search-btn" title="Search"><i class="fas fa-search"></i></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="fas fa-search"></i></button><input type="hidden" name="sitesearch" value="https://blog.hufeifei.cn"></form></div></div></div></header><div class="outer"><section id="main"><article class="article article-type-post" id="post-DB/mysql-binlog-parser" itemscope itemprop="blogPost"><div class="article-meta"><a class="article-date" href="/2021/03/DB/mysql-binlog-parser/"><time datetime="2021-03-12T16:00:00.000Z" itemprop="datePublished">2021-03-13</time></a><div class="article-category"><a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><div class="article-views leancloud_visitors" id="/2021/03/DB/mysql-binlog-parser/" data-flag-title="基于Binlog的实时同步功能——debezium、canel、databus技术选型" title="Views"><i class="fas fa-eye"></i><span class="waline-pageview-count" data-path="/2021/03/DB/mysql-binlog-parser/"></span></div></div><div class="article-inner"><header class="article-header" style="text-align:center"><h1 class="article-title" itemprop="name">基于Binlog的实时同步功能——debezium、canel、databus技术选型</h1></header><div class="article-entry" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>大厂这段时间学到的最有价值的两个技术除了大数据，另一个就是基于CDC和消息队列的实时同步技术。</p><p><a href="https://blog.hufeifei.cn/2020/04/25/Alibaba/MetaQ&Notify/">去年的一篇文章大致地讲了我对MQ的一些认识</a>，事实上Kafka在内的现代MQ，功能远不止这些。后面整理好自己的思路，肯定会再写一篇文章来讲讲。这篇文章的主角就是与MQ息息相关的CDC技术。</p><h2>1. CDC技术</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Change_data_capture">CDC</a>全称叫：change data capture，是一种基于数据库数据变更的事件型软件设计模式。</p><p>比如有一张订单表trade，订单每一次变更录入到一张trade_change的队列表。然后另外一个调度线程可以消费trade_change这张队列表来做一些数据统计，如每日的付款用户统计、每日的下单用户统计等。</p><p>这就是我毕业入职的第一家公司的报表统计逻辑。这个设计在订单量小的时候是看不出问题的，而一旦某一时刻订单量增多。基于MySQL的队列表由于B+树的写入吞吐量不够，导致MySQL CPU经常飙升。比如双十一，618这样的大促，程序员就得在颤颤巍巍中度过。</p><p>其次，从MySQL同步到ElaticSearch是根据<code>last_modify_time</code>时间扫索引增量同步的，这就要求表上必须创建<code>last_modify_time</code>索引，Scheduler一多也会无形地增加MySQL的读取负担。</p><blockquote><p>B+的写入性能肯定是不如直接顺序写文件的，B+树的本质就是牺牲写性能，换取磁盘上的随机读的查找结构，所以大部分数据库都会设计<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-buffer-pool.html">Buffer Pool</a>来管理B+树脏页，以避免频繁的随机IO。<br>同时为了防止Buffer数据丢失同时为了保证事务的ACID，所以就有了<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-redo-log.html">Redo-log</a>来进行崩溃恢复，<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.6/en/innodb-undo-logs.html">Undo-log</a>来做未提交事务的撤销。这些日志都是顺序写入，远比B+树的随机写性能高。</p></blockquote><p><img src="https://p.pstatp.com/origin/pgc-image/85c4945860ba4dd793acc42691226c8a" rel="external noreferrer nofollow noopener" referrerpolicy="no-referrer" alt="database architecture"></p><h2>2. 基于Binlog的CDC</h2><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/internals/en/binary-log.html">Binlog</a>是MySQL 3.23.14引进的，<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/binary-log.html">它包含所有的描述数据库修改的事件</a>——DML(增删改)、DDL(表结构定义与修改)操作。</p><p><img src="https://p.pstatp.com/origin/pgc-image/f20dc094cd6a4163829e616e02197acd" rel="external noreferrer nofollow noopener" referrerpolicy="no-referrer" alt="MySQL architecture"></p><p>与InnoDB中的<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-redo-log.html">redo-log</a>、<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-undo-logs.html">undo-log</a>不同，binlog和<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/slow-query-log.html">slow_query_log</a>一样是server层的日志，所以InnoDB和MyISAM等各种存储引擎的数据修改都会记录到这个日志中。</p><blockquote><p>MySQL拥有分层架构，支持可插拔的存储引擎，所以服务层的binlog与<a target="_blank" rel="noopener" href="https://mysqlserverteam.com/mysql-8-0-new-lock-free-scalable-wal-design/">InnoDB引擎的redo-log</a>是不同的两个事物，这也是为什么MySQL支持以<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/binary-log-setting.html"><code>STATEMENT</code>格式</a>直接将sql语句存入binlog。而像PostgreSQL这样的数据库，<a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/8.1/wal-intro.html">WAL日志</a>除了作为redo-log用于保证事务的持久性外，WAL日志在Replica过程中也扮演着与MySQL的binlog相同的角色, 但是需要用<a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/9.4/logicaldecoding-explanation.html">Logical Decoding</a>将WAL日志解析成数据流或SQL语句。</p></blockquote><p><img src="https://debezium.io/documentation/reference/1.4/_images/debezium-architecture.png" alt="CDC architecture"></p><p>对于CDC的架构设计，在大数据量的分布式场景下，我们都是使用binlog来做事件源。</p><p>一方面，将binlog复制到Kafka，再由Kafka下游的消费者处理这些事件不影响数据库的核心业务，可以降低系统的耦合度；</p><p>另一方面，binlog和Kafka都是基于日志的顺序写入，Kafka的吞吐量远比B+树高，系统的整体性能也能得到改善。</p><p>目前基于binlog的CDC技术已经很成熟了，在github上也有很多实现，通过<a target="_blank" rel="noopener" href="https://github.com/search?q=change+data+capture&s=stars">Change Data Capture</a>、<a target="_blank" rel="noopener" href="https://github.com/search?q=replication&s=stars">replication</a>、<a target="_blank" rel="noopener" href="https://github.com/search?q=binlog&s=stars">binlog</a>等关键词可以搜索到相关项目。在此列举一下：</p><table><thead><tr><th>Project</th><th>Language</th><th>Description</th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="https://github.com/alibaba/canal">alibaba/Canal</a><img src="https://img.shields.io/github/stars/alibaba/canal"></td><td>Java</td><td>阿里巴巴 MySQL binlog 增量订阅&amp;消费组件</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/debezium/debezium">debezium/debezium</a><img src="https://img.shields.io/github/stars/debezium/debezium"></td><td>Java</td><td>Debezium is an open source distributed platform for change data capture. Replicates from MySQL to Kafka. Uses mysql-binlog-connector-java. Kafka Connector. A funded project supported by Redhat with employees working on it full time.</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/linkedin/databus">linkedin/databus</a><img src="https://img.shields.io/github/stars/linkedin/databus"></td><td>Java</td><td>Precursor to Kafka. Reads from MySQL and Oracle, and replicates to its own log structure. In production use at LinkedIn. No Kafka integration. Uses Open Replicator.</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/zendesk/maxwell">zendesk/Maxwell</a><img src="https://img.shields.io/github/stars/zendesk/maxwell"></td><td>Java</td><td>Reads MySQL event stream, output events as JSON. Parses ALTER/CREATE TABLE/etc statements to keep schema in sync. Written in java. Well maintained.</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/noplay/python-mysql-replication">noplay/python-mysql-replication</a><img src="https://img.shields.io/github/stars/noplay/python-mysql-replication"></td><td>Python</td><td>Pure python library that parses MySQL binary logs and lets you process the replication events. Basically, the python equivalent of mysql-binlog-connector-java</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/shyiko/mysql-binlog-connector-java">shyiko/mysql-binlog-connector-java</a><img src="https://img.shields.io/github/stars/shyiko/mysql-binlog-connector-java"></td><td>Java</td><td>Library that parses MySQL binary logs and calls your code to process them. Fork/rewrite of Open Replicator. Has tests.</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/confluentinc/bottledwater-pg">confluentinc/bottledwater-pg</a><img src="https://img.shields.io/github/stars/confluentinc/bottledwater-pg"></td><td>C</td><td>Change data capture from PostgreSQL into Kafka</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/uber/storagetapper">uber/storagetapper</a><img src="https://img.shields.io/github/stars/uber/storagetapper"></td><td>Go</td><td>StorageTapper is a scalable realtime MySQL change data streaming, logical backup and logical replication service</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/moiot/gravity">moiot/gravity</a><img src="https://img.shields.io/github/stars/moiot/gravity"></td><td>Go</td><td>A Data Replication Center</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/whitesock/open-replicator">whitesock/open-replicator</a><img src="https://img.shields.io/github/stars/whitesock/open-replicator"></td><td>Java</td><td>Open Replicator is a high performance MySQL binlog parser written in Java. It unfolds the possibilities that you can parse, filter and broadcast the binlog events in a real time manner.</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/mardambey/mypipe">mardambey/mypipe</a><img src="https://img.shields.io/github/stars/mardambey/mypipe"></td><td>Scala</td><td>Reads MySQL event stream, and emits events corresponding to INSERTs, DELETEs, UPDATEs. Written in Scala. Emits Avro to Kafka.</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/Yelp/mysql_streamer">Yelp/mysql_streamer</a><img src="https://img.shields.io/github/stars/Yelp/mysql_streamer"></td><td>Python</td><td>MySQLStreamer is a database change data capture and publish system. It’s responsible for capturing each individual database change, enveloping them into messages and publishing to Kafka.</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/actiontech/dtle">actiontech/dtle</a><img src="https://img.shields.io/github/stars/actiontech/dtle"></td><td>Go</td><td>Distributed Data Transfer Service for MySQL</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/krowinski/php-mysql-replication">krowinski/php-mysql-replication</a><img src="https://img.shields.io/github/stars/krowinski/php-mysql-replication"></td><td>PHP</td><td>Pure PHP Implementation of MySQL replication protocol. This allow you to receive event like insert, update, delete with their data and raw SQL queries.</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/dianping/puma">dianping/puma</a><img src="https://img.shields.io/github/stars/dianping/puma"></td><td>Java</td><td>本系统还会实现数据库同步（同构和异构），以满足数据库冗余备份，数据迁移的需求。</td></tr><tr><td><a target="_blank" rel="noopener" href="https://github.com/JarvusInnovations/lapidus">JarvusInnovations/Lapidus</a><img src="https://img.shields.io/github/stars/JarvusInnovations/Lapidus"></td><td>Javascript</td><td>Streams data from MySQL, PostgreSQL and MongoDB as newline delimited JSON. Can be run as a daemon or included as a Node.js module.</td></tr></tbody></table><p>这里只讨论Java语言的几个实现。首先<a target="_blank" rel="noopener" href="https://github.com/whitesock/open-replicator">whitesock/open-replicator</a>和<a target="_blank" rel="noopener" href="https://github.com/shyiko/mysql-binlog-connector-java">shyiko/mysql-binlog-connector-java</a>是专门用来解析MySQL binlog的库，后者也是在前者的基础上重构的。<a target="_blank" rel="noopener" href="https://github.com/debezium/debezium">debezium/debezium</a>、<a target="_blank" rel="noopener" href="https://github.com/linkedin/databus">linkedin/databus</a>、<a target="_blank" rel="noopener" href="https://github.com/zendesk/maxwell">zendesk/Maxwell</a>三个中间件binlog解析都是基于这两个库。</p><h2>3. Canal vs. Debezium vs. databus vs. MaxWell</h2><p>1、<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal">alibaba/Canal</a><img src="https://img.shields.io/github/stars/alibaba/canal"></p><p>优点：</p><ul><li>阿里开源，有大厂实践背书</li><li>资料大都是中文的，方便学习</li></ul><p>缺点：</p><ul><li>定位于MySQL binlog解析，所以只能支持MySQL数据库的CDC</li><li>Github上项目活跃度很一般，issue堆积了太多，13、14年的问题都还没解决。</li></ul><p>2、<a target="_blank" rel="noopener" href="https://github.com/debezium/debezium">debezium/debezium</a> <img src="https://img.shields.io/github/stars/debezium/debezium"></p><p>优点：</p><ul><li>Rethat开源，专干开源的国际大厂背书</li><li>支持MySQL、PostgreSQL、Oracle、SqlServer、MongoDB主流数据库</li><li><a target="_blank" rel="noopener" href="https://debezium.io/documentation/">文档</a>详细，资料齐全</li><li>社区完善，在<a target="_blank" rel="noopener" href="https://gitter.im/debezium/user">Gitter</a>上有专门的问题讨论区。</li><li>与Kafka很好集成，可作为Kafka Connector插件使用，<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/development/engine.html">embed模式</a>支持嵌入自己的程序方便控制，也支持<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/operations/debezium-server.html">Server模式</a>单独运行。</li><li>支持SMT消息体转换，OpenTracing分布式链路追踪等集成功能</li></ul><p>缺点：</p><ul><li>文档大多数是英文的，得多花点耐心</li></ul><blockquote><p>有意思的是阿里开源的<a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/table/connectors/formats/debezium.html">Flink流处理</a>系统也是使用Debezium来做CDC，当然它还支持Canel、Maxwell</p><p>Kafka创始人创办的<a target="_blank" rel="noopener" href="https://github.com/confluentinc">confluentinc</a>刚开始开源了<a target="_blank" rel="noopener" href="https://github.com/confluentinc/bottledwater-pg">bottledwater-pg</a>，最后也投入了debezium的怀抱，有官方的认可。</p></blockquote><p>3、<a target="_blank" rel="noopener" href="https://github.com/linkedin/databus">linkedin/databus</a> <img src="https://img.shields.io/github/stars/linkedin/databus"></p><p>优点：</p><ul><li>国际大厂领英开源</li><li>支持MySQL和Oracle</li></ul><p>缺点：</p><ul><li>项目已经很久没有人维护了</li><li><a target="_blank" rel="noopener" href="https://github.com/linkedin/databus/wiki/_pages">文档</a>也很一般</li><li>暂时不支持Kafka集成，只能用<a target="_blank" rel="noopener" href="https://github.com/linkedin/databus/wiki/Databus-2.0-Client">Databus Client</a>消费binlog。</li></ul><blockquote><p>Kafka最早是<a target="_blank" rel="noopener" href="https://www.linkedin.com/in/jaykreps">Jay Kreps</a>在领英创建并开源的，可能是Jay Kreps觉得Kafka在大数据领域大有可图，所以就带着Linkedin的几个工程师一起创立了<a target="_blank" rel="noopener" href="https://www.confluent.io/about/">Confluent</a>​专注于Kafka生态的开发与维护。</p><p>在Kafka文档<a target="_blank" rel="noopener" href="https://kafka.apache.org/documentation/#compaction">Log-Compact一节</a>可以看到这段话：</p><p>This functionality is inspired by one of LinkedIn’s oldest and most successful pieces of infrastructure—a database changelog caching service called <a target="_blank" rel="noopener" href="https://github.com/linkedin/databus">Databus</a>. Unlike most log-structured storage systems Kafka is built for subscription and organizes data for fast linear reads and writes. Unlike Databus, Kafka acts as a source-of-truth store so it is useful even in situations where the upstream data source would not otherwise be replayable.</p><p>可以看出Databus是Linkedin非常老的一个基础服务，Kafka的Log Compact的一些设计也源自于Databus。</p></blockquote><p>4、<a target="_blank" rel="noopener" href="https://github.com/zendesk/maxwell">zendesk/maxwell</a><img src="https://img.shields.io/github/stars/zendesk/maxwell"></p><p>优点：</p><ul><li>相当简单，下载下来，简单进行配置就能运行</li><li><a target="_blank" rel="noopener" href="http://maxwells-daemon.io/quickstart/">文档</a>相对来说，还算齐全</li><li>支持Kafka、RabbitMQ、Redis等队列</li></ul><p>缺点：</p><ul><li><p>文档是英文的，不过好在maxwell相对简单。</p></li><li><p>没啥明显缺点。非要说个缺点，就是和前三者比身份不够显赫，zendesk这家美国公司没怎么听过。</p></li></ul><blockquote><p>综合下来，Debezium是最佳选择。</p></blockquote><h2>4. Debezimu-MySQL的配置</h2><p>要使用debezium需要<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#setting-up-mysql">预先对mysql服务进行配置</a>。</p><h3>4.1. MySQL配置</h3><p><strong>1）</strong>创建单独的用户，并授予debezium需要的权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, RELOAD, <span class="keyword">SHOW</span> DATABASES, REPLICATION SLAVE, REPLICATION CLIENT <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;user&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><blockquote><p>MySQL提供的权限：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html">https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html</a></p></blockquote><p>debezium需要几个权限的作用：</p><table><thead><tr><th align="left">Keyword</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>SELECT</code></td><td align="left"><code>SELECT</code>查询权限。只被用在初始化阶段。</td></tr><tr><td align="left"><code>RELOAD</code></td><td align="left">执行 <code>FLUSH</code> 语句清除重新加载内部缓存。只被用在初始化阶段。</td></tr><tr><td align="left"><code>SHOW DATABASES</code></td><td align="left">执行 <code>SHOW DATABASE</code> 语句。只被用在初始化阶段。</td></tr><tr><td align="left"><code>REPLICATION SLAVE</code></td><td align="left">读取MySQL binlog。</td></tr><tr><td align="left"><code>REPLICATION CLIENT</code></td><td align="left">执行<code>SHOW MASTER STATUS</code>、<code>SHOW SLAVE STATUS</code>、<code>SHOW BINARY LOGS</code>等语句。</td></tr></tbody></table><p><strong>2）</strong>开启MySQL服务的binlog功能</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server-id</span>         = <span class="string">223344</span></span><br><span class="line"><span class="attr">log_bin</span>           = <span class="string">mysql-bin</span></span><br><span class="line"><span class="attr">binlog_format</span>     = <span class="string">ROW</span></span><br><span class="line"><span class="attr">binlog_row_image</span>  = <span class="string">FULL</span></span><br><span class="line"><span class="attr">expire_logs_days</span>  = <span class="string">10</span></span><br></pre></td></tr></table></figure><p>各项配置的作用：</p><table><thead><tr><th align="left">Property</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>server-id</code></td><td align="left">在MySQL集群中每个server和replication的 <code>server-id</code> 必须是唯一的。Debezium是作为MySQL的replication，启动后也会分配一个<code>server-id</code>给debezium-connector。</td></tr><tr><td align="left"><code>log_bin</code></td><td align="left">binlog文件的前缀</td></tr><tr><td align="left"><code>binlog_format</code></td><td align="left"><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_binlog_format"><code>binlog-format</code></a> 必须设置成<code>ROW</code>模式。</td></tr><tr><td align="left"><code>binlog_row_image</code></td><td align="left"><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_binlog_row_image"><code>binlog_row_image</code> </a>必须设置成<code>FULL</code>。<code>ROW</code>模式下binlog需要记录所有的列。</td></tr><tr><td align="left"><code>expire_logs_days</code></td><td align="left">binlog的过期时间。默认位 <code>0</code>, 意味着不会自动删除。这个值可根据自己的环境需求进行设置。</td></tr></tbody></table><blockquote><p>mysql的<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/binary-log-formats.html">binlog有三种模式</a>：<br><code>STATEMENT</code>模式只记录SQL语句，从节点通过执行同步过来的sql在从库中再执行一遍。<code>STATEMENT</code>模式的问题是有些语句(比如<code>update t set num=num+1 limit 1</code>)可能会产生不一致性，而且<code>STATEMENT</code>模式下sql发给异构系统将会无法使用。<br><code>ROW</code>模式会直接复制修改的数据行，但是有可能会导致日志量过大，比如执行一条<code>update t set num=num+1</code>，修改了一万行就会有一万行日志，肯定没有<code>STATEMENT</code>模式来的快。<br><code>MIXED</code>模式，则将两者结合，默认情况下使用statement，某些情况会切换为基于行的复制。<br>具体可以参考<a target="_blank" rel="noopener" href="https://serverfault.com/questions/212549/which-binlog-format-to-use-for-mysql-replication/359889#359889">这个回答</a></p></blockquote><blockquote><p>还有几项可选配置项：</p><ul><li><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#enable-mysql-gtids">开启全局事务ID(GTIDs)</a>方便确认主从备份切换时之间的数据一致性。MySQL有主从切换就不能用binlog物理位置来标识binlog消费offset了，此时需要用<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/23485871/why-use-gtids-in-mysql-replication/23581370#23581370">全局的gtid</a>。</li><li><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-session-timeouts">配置MySQL会话超时时间</a>用于大表的快照读阶段。</li><li><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#enable-query-log-events">开启原始SQL语句的记录</a>用于查看每条binlog记录的原始SQL。</li></ul></blockquote><h3>4.2. 准备Kafka环境，在Kafka-connect中安装Debezium</h3><blockquote><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/">Kafka</a>需要依赖<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/">Zookeeper</a>管理集群，所以还需要准备zookeeper环境。</p></blockquote><p>1）下载Debezium：<a target="_blank" rel="noopener" href="https://debezium.io/releases/">https://debezium.io/releases/</a></p><p>2）配置Kafka-connect插件路径，并将Debezimu插件解压到该目录</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">plugin.path</span>=<span class="string">/kafka/connect</span></span><br></pre></td></tr></table></figure><p>3）启动Kafka-connect进程：</p><p>Kafka-connect可以用<a target="_blank" rel="noopener" href="https://docs.confluent.io/home/connect/userguide.html#standalone-vs-distributed-mode">单机版(<code>standalone</code>)和分布式版(<code>distributed</code>)</a>两种启动方式：</p><ul><li><code>standalone</code>模式下，启动时直接提供<code>properties</code>文件来创建Connector任务。</li><li><code>distributed</code>模式下，提供<a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/connect/references/restapi.html">REST接口</a>对Connector任务进行增删改查。</li></ul><h3>4.3. Debezium的基础配置</h3><p>在<code>distributed</code>模式下可以，调用<a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/connect/references/restapi.html#post--connectors"><code>POST /connectors</code></a>接口创建Debezium的Connector任务，任务的基本配置如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inventory-connector&quot;</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;connector.class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.debezium.connector.mysql.MySqlConnector&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.99.100&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3306&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debezium-user&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debezium-user-pw&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.server.id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;184054&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.server.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fullfillment&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.include.list&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inventory&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.history.kafka.bootstrap.servers&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kafka:9092&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;database.history.kafka.topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbhistory.fullfillment&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;include.schema.changes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span> </span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>这个配置主要是数据库的用户名密码，需要同步的数据库和相关数据表，以及kafka地址和数据库schema变更存储的topic。</p><p>Debezium-Connector的所有配置：<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-connector-properties">https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-connector-properties</a></p></blockquote><h2>5. binlog解析的难点与Debezium工作原理</h2><p>binlog的<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_binlog_format">ROW模式</a>下类似于csv是没有shema的，我们将<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_binlog_row_image">row_image</a>设置成full模式，不管update操作只涉及几列，都会把完整的行数据写入到binlog。</p><h3>5.1. 表结构随时都会修改，需要解析ddl并维护一份schema用于事件的生成</h3><p>数据库客户端查询数据库的时候，客户端拿到的都是数据库当前的schema。因为schema随时可以改变，这意味着主从备份的时候，debezium不能只使用当前的schema，因为debezium可能正在处理较旧的事件。</p><p>比如，有一张trade_info表，在某个时间点T添加了payment字段，在T之前的binlog是没有payment字段的，T之后的binlog才有payment。那Debezium生成事件也应该是在T之前有payment字段，T之后没有payment字段。</p><p>换句话说，消费binlog消息的时刻数据库的schema和消息生产时候的schema是不一致的，如果用消费时schema就会导致binlog消息解析失败，因此需要schema的快照。</p><blockquote><p>MySQL在binlog中不仅包含行级修改，还包括了数据库的DDL语句。当Debezium的Connector读取binlog并遇到这些DDL语句时，它会解析这些DDL并更新内存中每个表shema。Debezium使用这个shema就能标识每次增删改操作的结构从而生成事件。</p></blockquote><h3>5.2. 内存里的schema维护存在问题</h3><p>崩溃或正常重启后，怎么还原schema，如果使用数据库当前的schema会怎样呢：</p><ol><li>假如在T0~T1的时间内，表结构A发生过增加列的DDL操作，那在处理T0时间段A表的binlog时，拿到的表结构为T1的schema，就会出现列不匹配的情况. 比如之前的异常: column size is not match for table: xx , 12 vs 13</li><li>假如在T0~T1发生了增加 C1列、删除了C2列，此时拿到的列的总数还是和T0时保持一致，但是对应的列会错位</li><li>假如在T0~T1发生了drop table的DDL，此时拿表结构时会出现无法找到表的异常，一直阻塞整个binlog处理，比如not found [xx] in db</li></ol><p>很明显，不能直接查数据库当前的schema来为之前的binlog生成事件。Debezium和Canal都有自己的解决方案：</p><p>Debezium会把所有DDL语句以及DDL在binlog的位置单独存在一个<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.5/connectors/mysql.html#mysql-schema-history-topic">history的topic</a>中，这个topic可以用<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.5/connectors/mysql.html#mysql-property-database-history-kafka-topic">database.history.kafka.topic</a>进行配置。<br>当Debezium的Connector崩溃或正常停止重启后，Connector重新从原来的位置读取binlog。但是存在内存里的schema已经没有了，所以它会重新解析history中的DDL语句重建表结构。</p><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/canal">alibaba/canal</a>提供了<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/wiki/TableMetaTSDB">TableMetaTSDB</a>的功能可以存储表结构的时序数据。</p><h3>5.3. Kafka无法保证多个partition的消费顺序</h3><p>因为Debezium会重新解析history topic的DDL语句，我们希望DDL语句能按正常顺序解析，但是Kafka无法保证多个partition的消费顺序，所以history的topic的partition个数必须设置成1。</p><h3>5.4. 消费DDL</h3><p>Debezium不希望用户直接使用history topic。因为里面包含了binlog中的所有ddl语句。</p><p>如果用户想要消费自己关心的表的DDL语句，Debezium提供了<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-schema-change-topic">schema change topic</a>，这个topic名字被命名为<code>serverName</code>，这个serverName通过<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-property-database-server-name"><code>database.server.name</code></a>配置。</p><h2>6. Debezium踩坑记录</h2><p>debezium配置起来还是比较简单的，但是这么复杂的项目，坑还是比较多的。</p><h3>6.1. 关闭快照初始化</h3><p>Debezium的Connector第一次启动时，会给你的数据库执行一次<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-snapshots">快照初始化</a>。</p><p>因为对于老项目，早期的binlog肯定已经被删掉了，这个时候Debezium会帮你把数据库的所有数据都写到Kafka里，这次快照之后的增删改操作通过解析binlog写入kafka。这也是为什么Debezium需要获取数据库<code>SELECT</code>权限的原因。</p><p>但是快照读有这么几个问题：</p><ul><li>在执行快照初始化过程中，Connector重启或者Kafka-connect Rebalance，重启后Debezium会重新初始化快照。因为Debezium的快照是通过<a target="_blank" rel="noopener" href="https://github.com/debezium/debezium/blob/1.4/debezium-connector-mysql/src/main/java/io/debezium/connector/mysql/SnapshotReader.java#L650"><code>SELECT * FROM table</code></a>扫描全表实现的，没有记录进度，非常粗暴。</li><li>为了防止快照初始化过程中表的schema会变更，快照初始化前会获取全局读锁。</li></ul><blockquote><p>可以通过<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-property-snapshot-locking-mode"><code>snapshot.locking.mode</code></a>属性配置是否获取全局读锁，<code>snapshot.locking.mode=none</code>即可关闭。</p></blockquote><p>snapshot只适合在备份从库上执行，否则可能会影响正常用户的使用，通过<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-property-snapshot-mode"><code>snapshot.mode</code></a>可以对初始化进行配置，这个选项支持以下几个配置值：</p><p><code>initial</code> (default)- 只有当binlog的offset没有记录的时候才会执行一次快照初始化。</p><p><code>when_needed</code> - 有需要时就会执行，比如第一次offset没有记录，或者Connector停了很久早期的binlog被删掉了，当前的offset已经不可用了，或者GTID对不上的时候。</p><p><code>never</code> - 从不执行初始化。第一次启动Connector时就从binlog头部开始读取。需要注意，这种配置需要binlog包含所有的历史记录。</p><p><code>schema_only</code> - Connector初始化时只读取表的<code>schame</code>而不读取数据。如果你只需要Connector启动后的数据库变更，那这个配置很有用。</p><p><code>schema_only_recovery</code> - 用于恢复重启后丢失的schema，<a target="_blank" rel="noopener" href="https://debezium.io/blog/2018/03/16/note-on-database-history-topic-configuration/">但是这个只能用在自上次提交binlog-offset后</a>，schema没有发生任何变更。</p><p><code>initial_only</code> - 这个配置在文档里没有，<a target="_blank" rel="noopener" href="https://github.com/debezium/debezium/blob/1.5/debezium-connector-mysql/src/main/java/io/debezium/connector/mysql/MySqlConnectorConfig.java#L169">代码里</a>可以看到，这个是只用来执行快照的。</p><blockquote><p>用一句话总结一下：<code>initial</code>先全量后增量同步，<code>schema_only</code>和<code>never</code>是只增量同步，<code>initial_only</code>是只全量同步。</p></blockquote><h3>6.2. 修改topic</h3><p>Debezium默认的行为是将一张表上的<code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code>操作记录到一个topic。Topic命名规则是<code>&lt;serverName&gt;.&lt;databaseName&gt;.&lt;tableName&gt;</code></p><p>如果进行分库了，比如<code>server0</code>上有<code>db01</code>和<code>db02</code>两个逻辑库，<code>server1</code>上有<code>db11</code>和<code>db12</code>两个逻辑库，这四个逻辑库上都有一张<code>order</code>表。那此时就会有4个topic。</p><p>如果我们想把它们路由到同一个topic上，就需要用到<a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/connect/transforms/overview.html">Kafka-Connect提供的SMT功能</a>了：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">transforms</span>=<span class="string">route</span></span><br><span class="line"><span class="attr">transforms.route.type</span>=<span class="string">org.apache.kafka.connect.transforms.RegexRouter</span></span><br><span class="line"><span class="attr">transforms.route.regex</span>=<span class="string">([^.]+)\\.([^.]+)\\.([^.]+)</span></span><br><span class="line"><span class="attr">transforms.route.replacement</span>=<span class="string">$3</span></span><br></pre></td></tr></table></figure><p>Kafka-Connect提供了一个<a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/connect/transforms/regexrouter.html"><code>RegexRouter</code></a>、<a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/connect/transforms/timestamprouter.html"><code>TimestampRouter</code></a>、<a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/connect/transforms/messagetimestamprouter.html">MessageTimestampRouter</a>几个SMT让我们修改数据存入的topic。这里的RegexRouter，允许我们用正则表达式来对<code>Debezium</code>默认的topic进行修改。</p><h3>6.3. Decimal数据的处理</h3><p>对于MySQL中的<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/fixed-point-types.html"><code>decimal</code></a>类型的数据，Java里会转成<code>BigDecimal</code>，但是以json格式存入kafka的时候就会丢失精度。</p><blockquote><p>毕竟json出自JS，<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/35709595/why-would-you-use-a-string-in-json-to-represent-a-decimal-number">JS中只支持number数值类型</a>，对应到Java就是double类型。</p></blockquote><p>Debezium支持<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-property-decimal-handling-mode"><code>decimal.handling.mode</code></a>选项可以将decimal配置成<code>string</code>类型。</p><h3>6.4. 时间类型数据的处理</h3><p>Debezium底层的binlog解析用的是<a target="_blank" rel="noopener" href="https://github.com/shyiko/mysql-binlog-connector-java">shyiko/mysql-binlog-connector-java</a>。这中间做了很多转换：</p><table><thead><tr><th>mysql(Asia/Shanghai)</th><th>binlog-connector</th><th>debezium</th><th>debezium schema</th></tr></thead><tbody><tr><td>date (2021-01-28)</td><td>LocalDate (2021-01-28)</td><td>Integer (18655)</td><td>io.debezium.time.Date</td></tr><tr><td>time (17:29:04)</td><td>Duration (PT17H29M4S)</td><td>Long (62944000000)</td><td>io.debezium.time.MicroTime</td></tr><tr><td>timestamp (2021-01-28 17:29:04)</td><td>ZonedDateTime (2021-01-28T09:29:04Z)</td><td>String (2021-01-28T09:29:04Z)</td><td>io.debezium.time.ZonedTimestamp</td></tr><tr><td>datetime (2021-01-28 17:29:04)</td><td>LocalDateTime (2021-01-28T17:29:04)</td><td>Long (1611854944000)</td><td>io.debezium.time.Timestamp</td></tr></tbody></table><p><code>date</code>类型，最后在Debezium中会调用<code>LocalDate.toEpochDay</code>转成了基于1970年的天数。</p><p><code>time</code>类型，在binlog解析库中，被转成了Duration，在Debezium中最后被转成了毫秒值。</p><p><code>timestamp</code>类型，最后在Debezium中被转成了一个ISO格式的字符串，但是时区默认是UTC时区。</p><p><code>datetime</code>类型，最后在Debezium中被转成了一个long类型，时区是写死的UTC时区。</p><blockquote><p><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/connectors/mysql.html#mysql-temporal-types">文档里</a>有MySQL时间类型与存入Kafka类型的映射表</p></blockquote><p>总之，Debezium时间的处理混乱不堪。所以我为Debezium写了一个<a target="_blank" rel="noopener" href="https://github.com/holmofy/debezium-datetime-converter"><code>datetime-converter</code>的补丁</a>可以将这四种类型转成字符串。配置如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">converters</span>=<span class="string">datetime</span></span><br><span class="line"><span class="attr">datetime.type</span>=<span class="string">com.darcytech.debezium.converter.MySqlDateTimeConverter</span></span><br><span class="line"><span class="attr">datetime.format.date</span>=<span class="string">yyyy-MM-dd</span></span><br><span class="line"><span class="attr">datetime.format.time</span>=<span class="string">HH:mm:ss</span></span><br><span class="line"><span class="attr">datetime.format.datetime</span>=<span class="string">yyyy-MM-dd HH:mm:ss</span></span><br><span class="line"><span class="attr">datetime.format.timestamp</span>=<span class="string">yyyy-MM-dd HH:mm:ss</span></span><br><span class="line"><span class="attr">datetime.format.timestamp.zone</span>=<span class="string">UTC+8</span></span><br></pre></td></tr></table></figure><h3>6.5. 墓碑事件</h3><p>Debezium会生成5种事件：</p><ul><li><p><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-create-events"><em>create</em> events</a>：对应MySQL种的INSERT语句。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;ts_ms&quot;</span><span class="punctuation">:</span> <span class="number">1465491411815</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;after&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1004</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Anne&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kretchmar&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;annek@noanswer.org&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.4.2.Final&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;connector&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-server-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ts_ms&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;snapshot&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;db&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inventory&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customers&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;server_id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gtid&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-bin.000003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">154</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thread&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;INSERT INTO customers (first_name, last_name, email) VALUES (&#x27;Anne&#x27;, &#x27;Kretchmar&#x27;, &#x27;annek@noanswer.org&#x27;)&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>此时payload种的before字段为null，after字段为新增的记录值。</p></li><li><p><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-update-events"><em>update</em> events</a>：对应MySQL种的UPDATE语句。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1004</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Anne&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kretchmar&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;annek@noanswer.org&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;after&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1004</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Anne Marie&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kretchmar&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;annek@noanswer.org&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.4.2.Final&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-server-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;connector&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-server-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ts_ms&quot;</span><span class="punctuation">:</span> <span class="number">1465581029100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;snapshot&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;db&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inventory&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customers&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;server_id&quot;</span><span class="punctuation">:</span> <span class="number">223344</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gtid&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-bin.000003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">484</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thread&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UPDATE customers SET first_name=&#x27;Anne Marie&#x27; WHERE id=1004&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;u&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;ts_ms&quot;</span><span class="punctuation">:</span> <span class="number">1465581029523</span> </span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>此时payload中，before为更新前的数据，after为更新后的数据。</p></li><li><p><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-primary-key-updates">Primary key updates</a>：修改主键的操作，会生成一个<code>DELETE</code>事件和<code>CREATE</code>事件：</p><ul><li><code>DELETE</code> 事件会有 <code>__debezium.newkey</code> 的消息头。这个值是更新后的新主键。</li><li><code>CREATE</code> 事件会有 <code>__debezium.oldkey</code> 的消息头。这个值是更新前的老主键。</li></ul></li><li><p><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-delete-events"><em>delete</em> events</a>：对应MySQL的DELTE语句。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> ... <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;before&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1004</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Anne Marie&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kretchmar&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;annek@noanswer.org&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;after&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.5.0.Beta2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;connector&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-server-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ts_ms&quot;</span><span class="punctuation">:</span> <span class="number">1465581902300</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;snapshot&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;db&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inventory&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;table&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customers&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;server_id&quot;</span><span class="punctuation">:</span> <span class="number">223344</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gtid&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-bin.000003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pos&quot;</span><span class="punctuation">:</span> <span class="number">805</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;row&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thread&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DELETE FROM customers WHERE id=1004&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;d&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;ts_ms&quot;</span><span class="punctuation">:</span> <span class="number">1465581902461</span> </span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>此时payload中，before为删除前的数据，after为null。</p></li><li><p><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/connectors/mysql.html#mysql-tombstone-events">Tombstone events</a>：Debezium会为删除操作生成一条key与DELETE事件相同、value为null的空消息(墓碑事件)。</p><blockquote><p>墓碑事件主要用于<a target="_blank" rel="noopener" href="https://kafka.apache.org/documentation/#compaction">Kafka的compact</a>——Kafka会删除具有相同key的早期事件。但是要让Kafka删除所有具有相同key的消息，需要将消息指设置成null。</p></blockquote></li></ul><p>需要特别注意，墓碑事件的消息value为null，需要为这个事件做特殊处理。</p><h3>6.6. 禁用Kafka-Connect的Schema配置</h3><p>Kafka-Connect为了保证每条消息是可以自我描述的，所以都会带schema。如果我们使用了<a target="_blank" rel="noopener" href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained/"><code>JsonConverter</code></a>进行序列化，默认情况下，kafka中的消息格式是这样的：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;schema&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">/* ... */</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    	<span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;u&quot;</span><span class="punctuation">,</span></span><br><span class="line">    	<span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    		...</span><br><span class="line">    	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    	<span class="attr">&quot;ts_ms&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">    	<span class="attr">&quot;before&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    		<span class="attr">&quot;field1&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;oldvalue1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    		<span class="attr">&quot;field2&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;oldvalue2&quot;</span></span><br><span class="line">    	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    	<span class="attr">&quot;after&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    		<span class="attr">&quot;field1&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;newvalue1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    		<span class="attr">&quot;field2&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;newvalue2&quot;</span></span><br><span class="line">    	<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这里面的schema会包含下面payload里每个字段的类型解释，会导致Kafka中存储的消息非常臃肿。可以在Kafka-Connect中将Key和Value的schema禁用掉：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key.converter</span>=<span class="string">org.apache.kafka.connect.json.JsonConverter</span></span><br><span class="line"><span class="attr">value.converter</span>=<span class="string">org.apache.kafka.connect.json.JsonConverter</span></span><br><span class="line"><span class="attr">key.converter.schemas.enable</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">value.converter.schemas.enable</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure><p>更好的解决方案是使用中心化的Schema Registry。Debezium也推荐使用这种方式。</p><p><img src="https://docs.confluent.io/platform/current/_images/schema-registry-and-kafka.png" alt="schema registry"></p><p>在github搜索<a target="_blank" rel="noopener" href="https://github.com/search?q=Schema+registry"><code>schema registry</code></a>关键词查找相关项目。<a target="_blank" rel="noopener" href="https://debezium.io/documentation/faq/#avro-converter">Debezium在文档中</a>推荐<a target="_blank" rel="noopener" href="https://github.com/Apicurio/apicurio-registry">Apicurio API and Schema Registry</a> 和 <a target="_blank" rel="noopener" href="https://github.com/confluentinc/schema-registry">Confluent Schema Registry</a>这两种SchemaRegistry。</p><h3>6.7. 对Debezium生成的消息进行处理</h3><p>没有shema的时候，Debezium默认生成的数据格式是这样的：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;u&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		...</span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;ts_ms&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;before&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;field1&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;oldvalue1&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;field2&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;oldvalue2&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;after&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;field1&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;newvalue1&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;field2&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;newvalue2&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>消息体中<code>before</code>表示变更前的数据，<code>after</code>表示变更后的数据，<code>source</code>表示来源于哪个数据库、哪张表、哪个事务(GTID)。</p><p>为了方便与其他Connector集成，比如让<a target="_blank" rel="noopener" href="https://docs.confluent.io/kafka-connect-jdbc/current/index.html"><code>kafka-connect-jdbc</code></a>把消息都写到另一个数据库中。那这个时候我们只想要<code>after</code>里面的数据了。</p><p>Debezium提供了一个<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/configuration/event-flattening.html"><code>Event-Flat</code>的SMT</a>，我们只需要和上面的RegexRouter一样配置一下就可以了：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">transforms</span>=<span class="string">unwrap,...</span></span><br><span class="line"><span class="attr">transforms.unwrap.type</span>=<span class="string">io.debezium.transforms.ExtractNewRecordState</span></span><br></pre></td></tr></table></figure><p>那如果是删除操作呢，删除操作会生成两个事件，一个delete事件有before没有after，还有一个和delete事件key相同的墓碑事件消息体为null。ExtractNewRecordState可以配置怎么处理<code>delete</code>记录：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">transforms</span>=<span class="string">unwrap,...</span></span><br><span class="line"><span class="attr">transforms.unwrap.type</span>=<span class="string">io.debezium.transforms.ExtractNewRecordState</span></span><br><span class="line"><span class="attr">transforms.unwrap.drop.tombstones</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">transforms.unwrap.delete.handling.mode</span>=<span class="string">drop</span></span><br></pre></td></tr></table></figure><p><code>delete.handling.mode</code>指定delete记录的处理模式，默认为<code>drop</code>也就是delete记录将会被ExtractNewRecordState丢弃。<code>drop.tombstones</code>指定要不要丢弃墓碑事件。</p><p>更多配置可以参考<a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/configuration/event-flattening.html#configuration-options">官方文档</a></p><h3>6.8. kafka-connect的坑</h3><p>kafka broker本身有个配置<a target="_blank" rel="noopener" href="https://kafka.apache.org/documentation/#brokerconfigs_auto.create.topics.enable">auto.create.topics.enable</a>默认为true——当发送消息到一个不存在的topic时，kafka会自动创建这个topic，这些自动创建的topic会使用<a target="_blank" rel="noopener" href="http://kafka.apache.org/documentation.html#brokerconfigs_num.partitions">num.partitions</a>和<a target="_blank" rel="noopener" href="http://kafka.apache.org/documentation.html#brokerconfigs_default.replication.factor">default.replication.factor</a>指定的partition数和replicas数创建topic。生产环境一般是不建议使用kafka broker中的自动创建主题的，因为这可能会带来很大的维护成本，我们希望不同情况使用不同的主题配置。</p><p>另外，kafka-connect启动时默认会创建三个<a target="_blank" rel="noopener" href="https://docs.confluent.io/home/connect/userguide.html#kconnect-internal-topics">connect内部使用的topic</a>，这三个topic名字由<code>config.storage.topic</code>、<code>offset.storage.topic</code>、<code>status.storage.topic</code>三个配置指定，它们分别存储connector的配置和offset以及当前的状态。</p><p>如果想要对这三个自动创建的topic进行一些配置，可以参考<a target="_blank" rel="noopener" href="https://docs.confluent.io/home/connect/userguide.html#using-ak-broker-default-topic-settings">connect的文档</a></p><p>如果你是手动创建需要注意：</p><p><a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/connect/references/allconfigs.html#distributed-worker-configuration">config的partition必须为1</a>；</p><p>offset和kafka内建的<code>__consumer_offsets</code>类似，如果要支持更大的kafka-connect集群，可以把partition设大一点。</p><p>这三个topic的<code>cleanup.policy</code>都必须设置成compacted模式。</p><p>如果是source connector内部要自动创建topic，可以使用connector的一些配置，具体可以参考：</p><p><a target="_blank" rel="noopener" href="https://docs.confluent.io/home/connect/userguide.html#configuring-auto-topic-creation-for-source-connectors">Configuring Auto Topic Creation for Source Connectors</a></p><p><a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/configuration/topic-auto-create-config.html">Customization of Kafka Connect automatic topic creation</a></p><p>Refs:</p><p>^ Debezium Document: <a target="_blank" rel="noopener" href="https://debezium.io/documentation/reference/1.4/">https://debezium.io/documentation/reference/1.4/</a></p><p>^ Debezium FAQ: <a target="_blank" rel="noopener" href="https://debezium.io/documentation/faq/">https://debezium.io/documentation/faq/</a></p><p>^ Confluent Document: <a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/overview.html">https://docs.confluent.io/platform/current/overview.html</a></p><p>^ Aliyun DTS服务原理: <a target="_blank" rel="noopener" href="https://www.alibabacloud.com/help/zh/doc-detail/176085.htm">https://www.alibabacloud.com/help/zh/doc-detail/176085.htm</a></p><p>^ Aliyun DTS应用场景: <a target="_blank" rel="noopener" href="https://www.alibabacloud.com/help/zh/doc-detail/176086.htm">https://www.alibabacloud.com/help/zh/doc-detail/176086.htm</a></p></div><div class="article-copyright"><p>本作品采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a> 进行许可。</p><p>转载时请注明<a href="https://blog.hufeifei.cn/2021/03/DB/mysql-binlog-parser/">原文链接</a>：https://blog.hufeifei.cn/2021/03/DB/mysql-binlog-parser/</p></div><footer class="article-footer"><div class="article-tag"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Canal/" rel="tag">Canal</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DB/" rel="tag">DB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debezium/" rel="tag">Debezium</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul></div></footer></div><div id="article-reward"><i class="iconfont ic-money"></i><div>鼓励一下</div><table><thead><tr><th style="text-align:center">支付宝</th><th style="text-align:center">微信</th></tr></thead><tbody><tr><td style="text-align:center"><img width="150" src="https://www.hufeifei.cn/reward-img/alipay.jpg"></td><td style="text-align:center"><img width="135" src="https://www.hufeifei.cn/reward-img/wechat.jpg"></td></tr></tbody></table></div><nav id="article-nav"><a class="article-nav-link-wrap" href="/2021/04/DB/clickhouse-driver/" id="article-nav-newer"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">clickhouse-jdbc性能排查</div></a><a class="article-nav-link-wrap" href="/2021/03/Linux/curl/" id="article-nav-older"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">一个有意思的命令行工具,速查表tldr vs. cht</div></a></nav></article><div id="waline-comments"></div><script type="module">import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';init({"el":"#waline-comments","pageview":true,"enable":true,"serverURL":"https://api.waline.blog.hufeifei.cn","avatar":"mp","pageSize":10,"lang":"zh-cn","placeholder":"Just go go","visitor":true,"recordIP":true,"requiredFields":["nick"]});</script></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">关注微信公众号</h3><div class="widget wechat"><img src="//www.hufeifei.cn/wechat-public-account.jpg"></div></div><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C&C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/J2EE/">J2EE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux%E8%BF%90%E7%BB%B4/">Linux运维</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/">Ruby</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Rust/">Rust</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E6%97%A5%E5%B8%B8/">代码日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%95%86%E4%B8%9A/">商业</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E6%B5%8E%E4%B8%8E%E9%87%91%E8%9E%8D/">经济与金融</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/">计算机组成</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/AVL/" style="font-size:11.11px">AVL</a> <a href="/tags/Alibaba/" style="font-size:14.44px">Alibaba</a> <a href="/tags/Android/" style="font-size:18.89px">Android</a> <a href="/tags/B-Tree/" style="font-size:12.22px">B-Tree</a> <a href="/tags/BKD-Tree/" style="font-size:10px">BKD-Tree</a> <a href="/tags/BST/" style="font-size:10px">BST</a> <a href="/tags/BigData/" style="font-size:11.11px">BigData</a> <a href="/tags/C/" style="font-size:14.44px">C</a> <a href="/tags/CGlib/" style="font-size:10px">CGlib</a> <a href="/tags/CS/" style="font-size:11.11px">CS</a> <a href="/tags/Canal/" style="font-size:10px">Canal</a> <a href="/tags/ClassLoader/" style="font-size:10px">ClassLoader</a> <a href="/tags/ClickHouse/" style="font-size:10px">ClickHouse</a> <a href="/tags/Config/" style="font-size:10px">Config</a> <a href="/tags/Cryptography/" style="font-size:10px">Cryptography</a> <a href="/tags/DB/" style="font-size:20px">DB</a> <a href="/tags/Dapper/" style="font-size:10px">Dapper</a> <a href="/tags/DataStructure/" style="font-size:14.44px">DataStructure</a> <a href="/tags/Debezium/" style="font-size:10px">Debezium</a> <a href="/tags/Diamond/" style="font-size:10px">Diamond</a> <a href="/tags/Distributed/" style="font-size:13.33px">Distributed</a> <a href="/tags/ElasticSearch/" style="font-size:10px">ElasticSearch</a> <a href="/tags/Encoding/" style="font-size:10px">Encoding</a> <a href="/tags/FastJson/" style="font-size:10px">FastJson</a> <a href="/tags/File/" style="font-size:10px">File</a> <a href="/tags/FlowMarketing/" style="font-size:10px">FlowMarketing</a> <a href="/tags/Grade/" style="font-size:10px">Grade</a> <a href="/tags/Gson/" style="font-size:10px">Gson</a> <a href="/tags/HTTP/" style="font-size:10px">HTTP</a> <a href="/tags/Handler/" style="font-size:10px">Handler</a> <a href="/tags/Hanlder/" style="font-size:10px">Hanlder</a> <a href="/tags/Hessian/" style="font-size:10px">Hessian</a> <a href="/tags/IO-Multiplex/" style="font-size:10px">IO-Multiplex</a> <a href="/tags/JAVA/" style="font-size:18.89px">JAVA</a> <a href="/tags/JVM/" style="font-size:10px">JVM</a> <a href="/tags/KD-Tree/" style="font-size:10px">KD-Tree</a> <a href="/tags/KDB-Tree/" style="font-size:10px">KDB-Tree</a> <a href="/tags/Kafka/" style="font-size:10px">Kafka</a> <a href="/tags/Kubernetes/" style="font-size:10px">Kubernetes</a> <a href="/tags/LSM-Tree/" style="font-size:11.11px">LSM-Tree</a> <a href="/tags/Linux/" style="font-size:17.78px">Linux</a> <a href="/tags/Lock/" style="font-size:11.11px">Lock</a> <a href="/tags/Lucene/" style="font-size:10px">Lucene</a> <a href="/tags/MQ/" style="font-size:10px">MQ</a> <a href="/tags/Macro/" style="font-size:10px">Macro</a> <a href="/tags/Magisk/" style="font-size:10px">Magisk</a> <a href="/tags/MultiDex/" style="font-size:10px">MultiDex</a> <a href="/tags/MySQL/" style="font-size:17.78px">MySQL</a> <a href="/tags/NIO/" style="font-size:10px">NIO</a> <a href="/tags/Nginx/" style="font-size:11.11px">Nginx</a> <a href="/tags/OGNL/" style="font-size:10px">OGNL</a> <a href="/tags/OpenResty/" style="font-size:10px">OpenResty</a> <a href="/tags/OpenTelemetry/" style="font-size:10px">OpenTelemetry</a> <a href="/tags/Oracle/" style="font-size:10px">Oracle</a> <a href="/tags/PostgreSQL/" style="font-size:10px">PostgreSQL</a> <a href="/tags/RB-Tree/" style="font-size:10px">RB-Tree</a> <a href="/tags/Redis/" style="font-size:10px">Redis</a> <a href="/tags/Rust/" style="font-size:10px">Rust</a> <a href="/tags/Sharding/" style="font-size:10px">Sharding</a> <a href="/tags/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size:10px">SpringCloud</a> <a href="/tags/SpringCloudConfig/" style="font-size:10px">SpringCloudConfig</a> <a href="/tags/Sqlite/" style="font-size:10px">Sqlite</a> <a href="/tags/SurfaceView/" style="font-size:10px">SurfaceView</a> <a href="/tags/VSCode/" style="font-size:11.11px">VSCode</a> <a href="/tags/WebFlux/" style="font-size:10px">WebFlux</a> <a href="/tags/WebPush/" style="font-size:10px">WebPush</a> <a href="/tags/Web%E6%8C%96%E6%8E%98/" style="font-size:11.11px">Web挖掘</a> <a href="/tags/awk/" style="font-size:10px">awk</a> <a href="/tags/bit-hack/" style="font-size:10px">bit-hack</a> <a href="/tags/cheat-sheet/" style="font-size:10px">cheat sheet</a> <a href="/tags/curl/" style="font-size:10px">curl</a> <a href="/tags/epoll/" style="font-size:10px">epoll</a> <a href="/tags/gRPC/" style="font-size:10px">gRPC</a> <a href="/tags/grep/" style="font-size:10px">grep</a> <a href="/tags/kqueue/" style="font-size:10px">kqueue</a> <a href="/tags/libev/" style="font-size:10px">libev</a> <a href="/tags/libevent/" style="font-size:10px">libevent</a> <a href="/tags/libuv/" style="font-size:10px">libuv</a> <a href="/tags/metaq/" style="font-size:10px">metaq</a> <a href="/tags/poll/" style="font-size:10px">poll</a> <a href="/tags/sed/" style="font-size:10px">sed</a> <a href="/tags/select/" style="font-size:10px">select</a> <a href="/tags/ssh/" style="font-size:10px">ssh</a> <a href="/tags/%E5%8E%86%E5%8F%B2/" style="font-size:10px">历史</a> <a href="/tags/%E5%95%86%E4%B8%9A/" style="font-size:10px">商业</a> <a href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size:10px">心理学</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size:11.11px">生活</a> <a href="/tags/%E7%A8%8E%E6%94%B6/" style="font-size:10px">税收</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:14.44px">算法</a> <a href="/tags/%E7%BB%8F%E6%B5%8E/" style="font-size:15.56px">经济</a> <a href="/tags/%E8%90%A5%E9%94%80/" style="font-size:10px">营销</a> <a href="/tags/%E8%B4%A7%E5%B8%81/" style="font-size:10px">货币</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size:16.67px">随笔</a></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/04/economic/value-added-tax/">增值税与贫富差距</a></li><li><a href="/2024/01/Net/x-forward-for/">“真”的IP真的是真的吗？</a></li><li><a href="/2024/01/paper/MarkupLM-web-extract/">【译】基于MarkupLM的web数据抽取</a></li><li><a href="/2023/09/economic/tax-reform/">直接税改革——王朝周期律的胜负手</a></li><li><a href="/2023/09/Rust/macro-rules-learning/">Rust中的宏</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">网站运营不易</h3><div class="ads-wrapper"><div class="google_ads"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7111912103882824" data-ad-slot="8429272980" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></aside></div><footer id="footer"><div class="outer"><div class="inner" id="footer-info"><p><a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备17009276号</a><i class="far fa-copyright"></i>2016 ~ 2024 胡飞飞</p><p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><i class="fas fa-angle-right"></i>Theme by <a target="_blank" rel="noopener" href="https://github.com/holmofy/hexo-theme-paper">paper</a></p></div></div></footer></div><nav id="mobile-nav"><a class="mobile-nav-link" href="//www.hufeifei.cn">主页</a><a class="mobile-nav-link" href="/">博客</a><a class="mobile-nav-link" href="/archives">归档</a><a class="mobile-nav-link" target="_blank" rel="noopener" href="//algo.hufeifei.cn">算法</a><a class="mobile-nav-link" href="/book">书籍</a><a class="mobile-nav-link" href="/github">Github</a></nav><script src="//cdnjs.loli.net/ajax/libs/jquery/3.0.0/jquery.min.js"></script><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/script.js"></script></div><script>
  $(document).ready(function() {
    $('figure.codeblock').find('.tab').click(function() {
        var $codeblock = $(this).parent().parent().parent();
        var $tab = $(this);
        // remove "active" css class on all tabs
        $tab.siblings().removeClass('active');
        // add "active" css class on the clicked tab
        $tab.addClass('active');
        // hide all tab contents
        $codeblock.find('.highlight').hide();
        // show only the right one
        $codeblock.find('.highlight.' + $tab.text()).show();
    });
  });
  </script><script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'BPJzNs1QEtbYa3Bn0gMAQHBAzX3Jm71llGUKHTkKEUs3D9xiDYZ0DWJ3S9sfCAAJHxXEoBkUANFyONjeIlgrJUo'' });</script></body></html>