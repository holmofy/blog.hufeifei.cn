å› ä¸ºä¹‹å‰å…¬å¸æœ‰äººåˆ†äº«è¿‡G1å›æ”¶å™¨çš„å†…å®¹ï¼Œå¾ˆå¤šäººå¬çš„äº‘é‡Œé›¾é‡Œï¼ˆåŒ…æ‹¬æˆ‘ï¼‰ã€‚ç”šè‡³æœ‰äººé—®å­¦GCæœ‰ä»€ä¹ˆç”¨ï¼Œå¯¹å†™ä»£ç æœ‰å¸®åŠ©å—ã€‚æˆ‘æƒ³è¿™ä¸ªé—®é¢˜ä¸å¯ç½®å¦ã€‚

ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸€ä¹¦ä¸­æœ‰è¿™ä¹ˆä¸€å¥è¯ï¼šJavaä¸C++ä¹‹é—´æœ‰ä¸€å µç”±å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†æŠ€æœ¯æ‰€å›´æˆçš„â€œé«˜å¢™â€ï¼Œå¢™å¤–é¢çš„äººæƒ³è¿›å»ï¼Œå¢™é‡Œé¢çš„äººå´æƒ³å‡ºæ¥ã€‚

è¿™ç¯‡æ–‡ç« çš„ç›®çš„å°±æ˜¯ä¸ºäº†çªç ´è¿™åº§è—©ç¯±ï¼Œå°½é‡è®©æ›´å¤šçš„äººç†è§£JVMçš„åƒåœ¾å›æ”¶æœºåˆ¶ã€‚

# 1ã€GCä¹‹å‰

æ—©åœ¨1960å¹´ï¼Œ[Lispè¯­è¨€](https://en.wikipedia.org/wiki/Lisp_%28programming_language%29)ä¸­å°±æœ‰è‡ªåŠ¨åƒåœ¾æ”¶é›†çš„ç®—æ³•ï¼Œåªæ˜¯é‚£æ—¶å€™è¿˜æ²¡æœ‰å½¢æˆ[*Garbage Collection*](https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29)è¿™ä¸ªæ¦‚å¿µã€‚ç›´åˆ°1996å¹´ï¼ŒGCå› ä¸º[Java](https://en.wikipedia.org/wiki/Java_%28programming_language%29)çš„å‡ºç°è€Œä¸€ä¸¾æˆåã€‚

åœ¨GCè¢«å¹¿æ³›è¿ç”¨ä¹‹å‰ç¨‹åºå‘˜ä»¬æ‰‹åŠ¨ç®¡ç†å†…å­˜éƒ½ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

## 1.1ã€æ‚¬æŒ‚æŒ‡é’ˆ

[æ‚¬æŒ‚æŒ‡é’ˆ](https://en.wikipedia.org/wiki/Dangling_pointer)å°±æ˜¯æŒ‡é’ˆæŒ‡å‘äº†ä¸€æ®µå·²ç»è¢«å›æ”¶çš„å†…å­˜ã€‚è¢«å›æ”¶çš„å†…å­˜éšæ—¶å¯èƒ½è¢«å†æ¬¡åˆ†é…å‡ºå»ï¼Œä½¿ç”¨æ‚¬æŒ‚æŒ‡é’ˆä¼šå‡ºç°ä¸€äº›ä¸å¯é¢„æµ‹çš„ç»“æœã€‚

```c
void func(void)
{
   char *dp = NULL;
   ...
   {
       char c;
       dp = &c;
   }
    /* å˜é‡cè¶…å‡ºä½œç”¨èŒƒå›´ï¼Œæ ˆå†…å­˜å·²ç»è¢«å›æ”¶ */
    /* dpç°åœ¨æŒ‡å‘ä¸€æ®µè¢«å›æ”¶çš„å†…å­˜ï¼Œæ˜¯ä¸€ä¸ªæ‚¬æŒ‚æŒ‡é’ˆ */
   ...
}

int *func(void)
{
    int num = 1234;
    ...
    /* è¿”å›å‡½æ•°æ‰§è¡Œæ ˆä¸Šçš„ä¸€æ®µå†…å­˜ */
    /* å‡½æ•°æ‰§è¡Œå®Œåè¿™æ®µå†…å­˜å°±è¢«å›æ”¶äº† */
    return &num;
}

int *func(void)
{
    /* staticå˜é‡ä¸æ˜¯åˆ†é…åœ¨å‡½æ•°æ‰§è¡Œæ ˆä¸Šçš„ */
    /* å‡½æ•°è¿”å›ä¸ä¼šå›æ”¶è¿™æ®µå†…å­˜ */
    /* ä½†å¤šæ¬¡è°ƒç”¨è¿™ä¸ªå‡½æ•°è¿”å›çš„éƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ */
    /* æ“ä½œçš„å†…å­˜æ˜¯åŒä¸€æ®µå†…å­˜ï¼Œä¹Ÿå¯èƒ½ä¼šå½±å“ç¨‹åºçš„æ‰§è¡Œ */
    static int num = 1234;
    ...
    return &num;
}

#include <stdlib.h>
void func()
{
    ...
    char *dp = malloc(size);
    ...
    free(dp);
    /* dpå˜æˆäº†ä¸€ä¸ªæ‚¬æŒ‚æŒ‡é’ˆ */
    /* åç»­ä»£ç ç»§ç»­ä½¿ç”¨è¿™ä¸ªæŒ‡é’ˆï¼Œå°†ä¼šå‡ºç°ä¸å¯é¢„æµ‹çš„ç»“æœ */
    ...
    /* dpæŒ‡å‘çš„å†…å­˜å¯èƒ½å·²ç»åˆ†é…ç»™å…¶ä»–åœ°æ–¹ä½¿ç”¨ */
    /* äºŒæ¬¡é‡Šæ”¾ï¼Œä¼šå¯¼è‡´æ­£åœ¨ä½¿ç”¨çš„å†…å­˜è¢«é‡Šæ”¾(å›æ”¶äº†ä¸è¯¥å›æ”¶çš„å†…å­˜) */
    free(dp);
}

#include <stdlib.h>
void func()
{
    char *dp = malloc(size);
    ...
    free(dp);
    dp = NULL;
    /* å†…å­˜é‡Šæ”¾åç«‹å³æŠŠæŒ‡é’ˆç½®ä¸ºç©º,é¿å…å‡ºç°æŒ‡é’ˆæ‚¬æŒ‚ */
    ...
}

/* æ›¿æ¢freeå‡½æ•°ï¼Œé¿å…æ‚¬æŒ‚æŒ‡é’ˆ */
void safefree(void **pp)
{
    assert(pp);                     /* debugæ¨¡å¼ä¸‹ï¼Œppä¸ºNULLç›´æ¥abort */
    if (pp != NULL) {               /* å®‰å…¨æ£€æŸ¥ */
        free(*pp);                  /* é‡Šæ”¾å†…å­˜å— */
        *pp = NULL;                 /* å°†åŸæŒ‡é’ˆç½®ä¸ºNULL */
    }
}
```

> æ‚¬æŒ‚æŒ‡é’ˆ(Dangling pointer)ä¸é‡æŒ‡é’ˆ(Wild pointer)æ˜¯ä¸¤ç§ä¸åŒçš„æ¦‚å¿µã€‚é‡æŒ‡é’ˆæŒ‡çš„æ˜¯ï¼šæŒ‡é’ˆå€¼æ²¡æœ‰åˆå§‹åŒ–ã€‚æ²¡æœ‰åˆå§‹åŒ–çš„æŒ‡é’ˆæŒ‡å‘çš„å€¼æ˜¯ä¸ç¡®å®šçš„ï¼Œç›´æ¥ä½¿ç”¨é‡æŒ‡é’ˆä¹Ÿä¼šå¯¼è‡´ä¸å¯é¢„æµ‹çš„ç»“æœï¼Œæ‰€ä»¥åœ¨å£°æ˜ä¸€ä¸ªå€¼(ä¸ç®¡æ˜¯æŒ‡é’ˆå€¼è¿˜æ˜¯æ™®é€šå€¼ç±»å‹)çš„æ—¶å€™éƒ½å°½é‡ç»™ä¸€ä¸ªåˆå§‹å€¼ã€‚

## 1.2ã€å†…å­˜æ³„æ¼

[å†…å­˜æ³„æ¼](https://en.wikipedia.org/wiki/Memory_leak)æŒ‡çš„æ˜¯ä¸å†éœ€è¦çš„å†…å­˜æ²¡æœ‰å¾—åˆ°é‡Šæ”¾ã€‚

```c
void func(int n)
{
    int *p = malloc(sizeof(int) * n);
    ... // use pointer
    // æ²¡æœ‰é‡Šæ”¾å†…å­˜å°±è¿”å›äº†
}
int main(void)
{
    func(10);
    /* å‡½æ•°ä¸­çš„æŒ‡é’ˆpå·²ç»é‡Šæ”¾äº†ï¼Œä½†pæŒ‡å‘çš„å†…å­˜æ²¡æœ‰é‡Šæ”¾ */
}
```

åœ¨C++ä¸­å› ä¸ºæœ‰ææ„å‡½æ•°ï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨ææ„å‡½æ•°ä¸­é‡Šæ”¾å†…å­˜

```cpp
#include<vector>
void func(int n)
{
    // std::vectorå’ŒJavaçš„ArrayListç±»ä¼¼
    std::vector<int> arr(n);
    // use array
    // å‡½æ•°è¿”å›æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨æ ˆå¯¹è±¡çš„ææ„å‡½æ•°
    // å¯¹è±¡ææ„çš„æ—¶å€™å¯ä»¥é‡Šæ”¾å†…å­˜ã€‚
}
```

ä½†æ˜¯ä¸€æ–¹é¢æˆ‘ä»¬ä¸èƒ½è¿”å›åˆ†é…åœ¨æ ˆä¸Šçš„å¯¹è±¡(ä¼šå¯¼è‡´æ‚¬æŒ‚æŒ‡é’ˆ)ï¼Œå¦ä¸€æ–¹é¢æ ˆçš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œä¸èƒ½åœ¨æ ˆä¸Šåˆ†é…è¿‡å¤šçš„å†…å­˜ï¼Œå¦åˆ™ææ˜“StackOverflowã€‚

```cpp
void func() {
    // åœ¨æ ˆä¸Šåˆ†é…å¤§æ•°ç»„è‚¯å®šä¼šæ ˆæº¢å‡ºçš„
	int a[1024 * 1024]; //4Mæ ˆå†…å­˜
	printf("%p", a);
}

int main() {
	func();
}
```

> `ulimit -s`å¯ä»¥æŸ¥çœ‹ç±»Unixç³»ç»Ÿä¸‹æ ˆå®¹é‡çš„æœ€å¤§å€¼

æ‰€ä»¥ä¸€èˆ¬åœ¨æ ˆä¸Šåˆ†é…åŸºæœ¬ç±»å‹ã€æŒ‡é’ˆç±»å‹å’Œä¸€äº›å‡½æ•°ä½œç”¨åŸŸå†…çš„å°ç»“æ„ä½“ï¼Œéœ€è¦ä½œä¸ºè¿”å›å€¼çš„å¯¹è±¡ä»¥åŠå¤§ç»“æ„ä½“å¯¹è±¡éƒ½åœ¨å †ä¸Šåˆ†é…ã€‚

åœ¨å †ä¸Šåˆ†é…å¯¹è±¡é‚£å°±é¿å…ä¸äº†ä½¿ç”¨C++çš„`new`æ“ä½œç¬¦ã€‚ä¸`malloc`å’Œ`free`ä¸€æ ·`new`ä¹Ÿè¦å’Œ`delete`æˆå¯¹å‡ºç°ã€‚ä½†æ˜¯åœ¨ä¸€ä¸ªé€»è¾‘å¤æ‚çš„å‡½æ•°ä¸­éš¾å…ä¼šå‡ºç°å¿˜è®°é‡Šæ”¾å†…å­˜å°±è¿”å›äº†ï¼š

```cpp
void func()
{
    big_object* p = new big_object();
    ...
    // ææœ‰å¯èƒ½å› ä¸ºæŸäº›åŸå› æ²¡æœ‰é‡Šæ”¾å †ä¸­çš„å¯¹è±¡
    if(condition1) {
        throw std::runtime_error("error");
    }
    if(condition2){
        return;
    }
    ...
    // æœ€åçš„å†…å­˜é‡Šæ”¾
    delete p;
}
```

C++æœ‰[æ™ºèƒ½æŒ‡é’ˆ](https://en.wikipedia.org/wiki/Smart_pointer)è§£å†³è¿™äº›é—®é¢˜ã€‚

```cpp
void func() {
	big_object* p = new big_object(); // big_objectåœ¨å †ä¸Šåˆ†é…å†…å­˜
    // æ™ºèƒ½æŒ‡é’ˆåœ¨æ ˆä¸Š,æ ˆä¸Šçš„æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘å †ä¸­çš„å¯¹è±¡
	std::unique_ptr<big_object> smart_pointer = std::unique_ptr<big_object>(p);
	std::cout << smart_pointer->field << std::endl;
    // å‡½æ•°æ‰§è¡Œå®Œï¼Œä¼šè°ƒç”¨æ™ºèƒ½æŒ‡é’ˆçš„ææ„å‡½æ•°
    // ææ„å‡½æ•°ä¼šè‡ªåŠ¨deleteå†…éƒ¨æŒæœ‰çš„æŒ‡é’ˆå¯¹è±¡
}

// æ›´æ–¹ä¾¿çš„ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ
void func() {
    // std::make_uniqueä¼šè‡ªåŠ¨æ„é€ big_objectå¯¹è±¡å¹¶ä»¥æ™ºèƒ½æŒ‡é’ˆçš„å½¢å¼è¿”å›
	auto smart_pointer = std::make_unique<big_object>();
	std::cout << smart_pointer->field << std::endl;
}
```

> C++11æ ‡å‡†ä¸­é™¤äº†å¼•å…¥äº†ä¸å…±äº«å†…éƒ¨æŒæœ‰å¯¹è±¡çš„[std::unique_ptr](https://en.cppreference.com/w/cpp/memory/unique_ptr)ï¼Œè¿˜æä¾›äº†åŸºäºå¼•ç”¨è®¡æ•°ç®—æ³•çš„[std::shared_ptr](https://en.cppreference.com/w/cpp/memory/shared_ptr)

çœ‹åˆ°è¿™ï¼Œä½ åº”è¯¥ä¹Ÿæœ‰è¿™æ ·çš„ä½“ä¼šï¼šä¼Ÿå¤§çš„å…ˆè¾ˆä»¬ä¸ºå†…å­˜ç®¡ç†åšå‡ºäº†å·¨å¤§çš„ä»˜å‡ºã€‚

ä½†æ˜¯åº”ç”¨çš„å¼€å‘é€Ÿåº¦éšç€äº’è”ç½‘çš„è¿…çŒ›å‘å±•é€æ­¥æé«˜è¦æ±‚ã€‚ä¸èƒ½åœ¨æŒ‡é’ˆå¼•ç”¨ä¸ŠèŠ±è´¹å¤ªå¤šç²¾åŠ›ï¼Œä¹Ÿä¸èƒ½å› ä¸ºå†…å­˜æ³„æ¼å¯¼è‡´åº”ç”¨è·‘äº†ä¸ªæŠŠç¤¼æ‹œå°±å®•æœºäº†ã€‚

> GCæ‹¯æ•‘äº†ç¨‹åºå‘˜ï¼Œæ‹¯æ•‘äº†ç¨‹åºå‘˜çš„å¤´å‘:smile:

# 2ã€GCç®—æ³•

åƒåœ¾å›æ”¶ç®—æ³•çš„è®¾è®¡ä¸»è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1ã€å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯åƒåœ¾å¯¹è±¡

2ã€å¦‚ä½•å›æ”¶åƒåœ¾å¯¹è±¡

3ã€ä½•æ—¶å›æ”¶åƒåœ¾å¯¹è±¡

é¦–å…ˆåˆ¤æ–­[åƒåœ¾å¯¹è±¡](https://en.wikipedia.org/wiki/Garbage_%28computer_science%29)çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼š[å¼•ç”¨è®¡æ•°](https://en.wikipedia.org/wiki/Reference_counting)ã€[å¯è¾¾æ€§åˆ†æ](https://en.wikipedia.org/wiki/Unreachable_memory)

# 3ã€å¼•ç”¨è®¡æ•°

å¼•ç”¨è®¡æ•°å°±æ˜¯ä¸ºæ¯ä¸ªå¯¹è±¡æ·»åŠ ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨åˆ°å®ƒï¼Œè®¡æ•°å™¨å€¼åŠ 1ï¼Œå½“å¼•ç”¨é‡Šæ”¾æˆ–å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å€¼å‡1ï¼Œè®¡æ•°å™¨å€¼é™ä¸º0å¯¹è±¡å°±ä¼šè¢«å›æ”¶ã€‚

å› ä¸ºå¼•ç”¨è®¡æ•°å™¨é™ä¸º0æ—¶å°±ä¼šè¢«ç«‹å³å›æ”¶ï¼Œä¸éœ€è¦é¢å¤–çš„æ“ä½œï¼Œæ‰€ä»¥å¼•ç”¨è®¡æ•°æ—¶é—´æ•ˆç‡é«˜ã€‚

å¾®è½¯COMæŠ€æœ¯ä¸­å°±å®šä¹‰äº†[IUnknownæ¥å£](https://docs.microsoft.com/en-us/windows/desktop/api/unknwn/nn-unknwn-iunknown)ä½œä¸ºæ‰€æœ‰COMç»„ä»¶çš„åŸºç¡€æ¥å£ï¼Œè¯¥æ¥å£å°±å®šä¹‰äº†å¼•ç”¨çš„å¢åŠ ä¸é‡Šæ”¾çš„è¡Œä¸ºã€‚å‰é¢æåˆ°çš„æ ‡å‡†C++11ä¸­ä¹Ÿæä¾›äº†ä¸€ä¸ªåŸºäºå¼•ç”¨è®¡æ•°å®ç°çš„[`std::shared_ptr`](https://en.cppreference.com/w/cpp/memory/shared_ptr)æ™ºèƒ½æŒ‡é’ˆã€‚[Pythonä¹Ÿä½¿ç”¨å¼•ç”¨è®¡æ•°](https://docs.python.org/3/c-api/refcounting.html)è¿›è¡Œå†…å­˜ç®¡ç†ã€‚

å¼•ç”¨è®¡æ•°ä¹Ÿæœ‰å¾ˆå¤šç¼ºç‚¹ï¼Œæ¯”å¦‚éœ€è¦ä¸€ä¸ªè®¡æ•°å™¨å­—æ®µï¼Œå¦‚æœå¯¹è±¡éƒ½å¾ˆå°åªæœ‰ä¸€ä¸¤ä¸ªå­—æ®µï¼Œå¼•ç”¨è®¡æ•°æ–¹å¼çš„ç©ºé—´æ•ˆç‡å°±ä¸æ˜¯å¾ˆå¥½äº†ã€‚å¦å¤–æœ‰ä¸ªè‡´å‘½çš„ç¼ºç‚¹å°±æ˜¯å¼•ç”¨è®¡æ•°æ— æ³•æ£€æµ‹åˆ°å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œæ­£å› æ­¤ä¸»æµçš„JVMéƒ½æ²¡æœ‰ä½¿ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•ã€‚

> C++11ä¸­æä¾›äº†[`std::weak_ptr`](https://en.cppreference.com/w/cpp/memory/weak_ptr)å¯ä»¥ç”¨æ¥è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œ[pythonæœ‰ä¸ªåˆ†ä»£åƒåœ¾æ”¶é›†å™¨è¾…åŠ©å¼•ç”¨è®¡æ•°å›æ”¶åƒåœ¾](https://rushter.com/blog/python-garbage-collector/)ã€‚

![å¾ªç¯å¼•ç”¨é—®é¢˜](http://ww1.sinaimg.cn/large/bda5cd74ly1fww39kcsqxj20p00av3yi.jpg)

[é¥±å—è¯Ÿç—…çš„IE6,IE7](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management)ä¸­ä¹Ÿä½¿ç”¨å¼•ç”¨è®¡æ•°è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥ä¸‹é¢è¿™æ ·çš„ä»£ç å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œæµè§ˆå™¨ç›´æ¥å´©æºƒã€‚

```javascript
var div;
window.onload = function() {
  div = document.getElementById('myDivElement');
  div.circularReference = div;
  div.lotsOfData = new Array(10000).join('*');
};
```

> ç°åœ¨ä¸»æµçš„JSå¼•æ“æ—©å·²ä¸å†ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•äº†ï¼Œ[V8å’ŒHotspotä¸€æ ·ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•](https://github.com/thlorenz/v8-perf/blob/master/gc.md)ï¼Œå€¼å¾—ä¸€æçš„æ˜¯V8çš„æ ¸å¿ƒå¼€å‘æˆå‘˜[Lars_Bak](https://en.wikipedia.org/wiki/Lars_Bak_%28computer_programmer%29)ä¹Ÿæ˜¯Hotspotå›¢é˜Ÿçš„æŠ€æœ¯è´Ÿè´£äººã€‚

# 4ã€å¯è¾¾æ€§åˆ†æâ€”â€”å¼•ç”¨æ ‘éå†

å¼•ç”¨æ ‘éå†æ˜¯å¯è¾¾æ€§åˆ†ææœ€ä¸»è¦çš„æ‰‹æ®µã€‚

ä¸¥æ ¼åœ°è¯´ï¼Œå¼•ç”¨æ ‘æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæœ‰æ ¹çš„Graphç»“æ„ï¼Œè€Œä¸æ˜¯ç®€å•çš„æ ‘ç»“æ„ï¼Œå› ä¸ºå¯¹è±¡å¼•ç”¨æå¯èƒ½å½¢æˆç¯è·¯ã€‚

GCä»æ ¹å¼•ç”¨å¼€å§‹ï¼Œé¡ºç€å¼•ç”¨é“¾éå†ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡ï¼ŒåŒæ—¶æŠŠå®ƒä»¬**æ ‡è®°(Mark)**ä¸‹æ¥ï¼Œæœªæ ‡è®°çš„ä¸å¯è¾¾å¯¹è±¡å°±æ˜¯åƒåœ¾å¯¹è±¡ã€‚

![GC root](http://ww1.sinaimg.cn/large/bda5cd74ly1fww2bbjky3j20fc0bxgn1.jpg)

è¿™äº›æ ¹å¼•ç”¨è¢«ç§°ä¸º**GC Root**ï¼Œåœ¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å’Œä¸åŒçš„åœºæ™¯ä¸‹GC Rootçš„å®šä¹‰ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚

> 1ã€å¼•ç”¨æ ‘çš„éå†æ˜¯BFSè¿˜æ˜¯DFSï¼Ÿä»å†…å­˜çš„æ¶ˆè€—è§’åº¦è€ƒè™‘ï¼Œåº”è¯¥é€‰ç”¨DFSï¼Ÿ
>
> 2ã€æ ‡è®°ç­–ç•¥ï¼Œæ¯ä¸ªå¯¹è±¡å¤´éƒ¨åŠ ä¸ªæ ‡è®°ä½ï¼ŸCacheå‘½ä¸­ç‡ä½ï¼ŒBitmapæ ‡è®°ï¼Ÿ

# 5ã€Mark-Sweep

æ ‡è®°æ¸…é™¤ç®—æ³•æ˜¯åŸºäºå¯è¾¾æ€§åˆ†ææœ€ç®€å•çš„ä¸€ç§å›æ”¶ç­–ç•¥ã€‚

![å¼•ç”¨æ ‘éå†](http://ww1.sinaimg.cn/large/bda5cd74ly1fx8iwx1571g20bo08xtcf.gif)

Mark-Sweepç®—æ³•çš„æ¸…é™¤é˜¶æ®µå¾ˆç®€å•ï¼šéå†å †ä¸­çš„å¯¹è±¡ï¼ŒæŠŠæ²¡æ ‡è®°çš„åƒåœ¾å¯¹è±¡å†…å­˜å›æ”¶åˆ©ç”¨ã€‚è¿™äº›å›æ”¶çš„å†…å­˜ä¼šè¢«è®°å½•åœ¨ä¸€ä¸ª[ç©ºé—²åˆ—è¡¨(free list)](https://en.wikipedia.org/wiki/Free_list)ä¸­ï¼Œä¸‹æ¬¡åˆ›å»ºå¯¹è±¡ç”³è¯·å†…å­˜çš„æ—¶å€™å†ä»ç©ºé—²åˆ—è¡¨ä¸­æ‰¾åˆ°åˆé€‚å¤§å°çš„å†…å­˜å—è¿›è¡Œåˆ†é…ã€‚

![æ ‡è®°æ¸…é™¤](http://ww1.sinaimg.cn/large/bda5cd74ly1fww3xuvtzhj20k00ayjrm.jpg)

è¿™ç§æ–¹å¼çš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼š

1ã€ ä¼šé€ æˆå¤§é‡çš„å†…å­˜ç¢ç‰‡ã€‚è¿™äº›å°å—çš„å†…å­˜ä¼šå¯¼è‡´åˆ›å»ºå¤§å¯¹è±¡æ—¶æ‰¾ä¸åˆ°è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚

2ã€ åˆ›å»ºå¯¹è±¡æ—¶è¦ä»ç©ºé—²åˆ—è¡¨ä¸­æ‰¾åˆ°åŒ¹é…çš„å†…å­˜ç©ºé—´(First-Fit, Best-fit, Worst-fit)ï¼Œå½±å“å¯¹è±¡çš„å†…å­˜åˆ†é…æ—¶é—´ã€‚

# 7ã€Copying

GCæ‹·è´ç®—æ³•è§£å†³äº†Mark-Sweepç®—æ³•çš„å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚

å®ƒå°†å †å†…å­˜åˆ’åˆ†ä¸ºFromã€Toä¸¤ä¸ªå¤§å°ç›¸ç­‰çš„åŒºåŸŸï¼Œåˆ›å»ºå¯¹è±¡æ—¶åªåœ¨å…¶ä¸­ä¸€ä¸ªåŒºåŸŸå†…åˆ†é…å†…å­˜ï¼Œç­‰FromåŒºå†…å­˜ç”¨å®Œäº†ï¼ŒæŠŠæ ‡è®°å­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ°ToåŒºï¼Œåç»­çš„å¯¹è±¡å†…å­˜å°±åœ¨ToåŒºåˆ†é…(Fromï¼ŒToè½¬å˜èº«ä»½)ï¼Œä¸‹æ¬¡å†…å­˜ç”¨å®Œå†è¿›è¡Œä¸€æ¬¡è¿™æ ·çš„è¿‡ç¨‹ã€‚

![æ‹·è´ç®—æ³•](http://ww1.sinaimg.cn/large/bda5cd74ly1fxewv4et6hj20ks0as0tt.jpg)

æ‹·è´ç®—æ³•ä¸­å†…å­˜å—çš„çŠ¶æ€æ˜¯è¿™æ ·å˜åŒ–çš„ï¼š

![Copying](http://ww1.sinaimg.cn/large/bda5cd74ly1fww4eyhhd5j20k00b0wf1.jpg)

è¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯ä¸å†æœ‰å†…å­˜ç¢ç‰‡ï¼Œç¼ºç‚¹ä¹Ÿæ˜¾è€Œæ˜“è§ï¼šå¯¹è±¡ç§»åŠ¨åï¼Œéœ€è¦æ›´æ–°å¯¹è±¡çš„å¼•ç”¨ï¼›å†…å­˜ä½¿ç”¨ç‡ä¸é«˜ï¼Œä¸€åŠçš„å†…å­˜ä¼šç©ºé—²ï¼›å¯¹è±¡å­˜æ´»ç‡è¾ƒé«˜æ—¶ï¼Œå°±ä¼šæœ‰å¤§é‡çš„æ‹·è´æ“ä½œã€‚

# 6ã€Mark-Compact

[æ ‡è®°æ•´ç†ç®—æ³•](https://en.wikipedia.org/wiki/Mark-compact_algorithm)å¯ä»¥çœ‹ä½œæ˜¯æ ‡è®°æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ç®—æ³•çš„ç»„åˆã€‚

> ä¹Ÿæœ‰äººæŠŠcompactç¿»è¯‘æˆå‹ç¼©

æ ‡è®°æ•´ç†ä¸æ‹·è´ç®—æ³•éƒ½è§£å†³äº†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼ŒåŒºåˆ«åœ¨äºCopyingå±äºå¼‚åœ°æ•´ç†ï¼ŒMark-Compactå±äºåŸåœ°æ•´ç†ã€‚

Mark-CompactæŠŠæ ‡è®°å­˜æ´»çš„å¯¹è±¡å¾€å†…å­˜çš„ä¸€ä¸ªæ–¹å‘é æ‹¢ï¼Œè¾¹ç•Œç«¯åç»­çš„å†…å­˜å°±å…¨éƒ¨è®°ä½œç©ºé—²å†…å­˜ã€‚

![Mark-Compact](http://ww1.sinaimg.cn/large/bda5cd74ly1fww488wqoyj20w00h8aaw.jpg)

è¿™ä¸ªç®—æ³•ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼šå‰é¢æœ‰ä¸€å—å†…å­˜æ˜¯åƒåœ¾å¯¹è±¡ï¼Œåç»­çš„å¯¹è±¡éƒ½éœ€è¦ç§»åŠ¨ï¼Œå­˜æ´»å¯¹è±¡è¾ƒå¤šæ—¶ï¼Œç§»åŠ¨è€—æ—¶åŸºæœ¬ä¸å†…å­˜å¤§å°æˆæ­£æ¯”ã€‚

# 8ã€åˆ†ä»£GC

> äº‹å®ä¸Šï¼Œç›®å‰ä¸ºæ­¢éƒ½æ²¡æœ‰ä¸€ä¸ªèƒ½â€œä¸€ç»Ÿå¤©ä¸‹â€çš„GCå›æ”¶ç­–ç•¥ï¼Œæ¯ç§å›æ”¶ç­–ç•¥éƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚

å¾ˆå¤šç¨‹åºçŒ¿ç ”ç©¶å‘ç°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œå¤§å¤šæ•°ç”Ÿç‰©æœ‰ç‚¹ç±»ä¼¼ï¼šæ–°ç”Ÿçš„å¯¹è±¡è¶Šå®¹æ˜“â€œå¤­æŠ˜â€ï¼Œå­˜æ´»è¶Šä¹…çš„å¯¹è±¡è¶Šâ€œé¡½å¼ºâ€ã€‚

åŸºäºè¿™ä¸ªè®¤è¯†ï¼Œ[åˆ†ä»£GC(Generational GC)](https://en.wikipedia.org/wiki/Tracing_garbage_collection#Generational_GC_%28ephemeral_GC%29)ä¸ºå¯¹è±¡å¼•å…¥â€œå¹´é¾„â€çš„æ¦‚å¿µï¼ŒæŒ‰ç…§å¹´é¾„æ®µè¿›è¡Œåˆ†ä»£ï¼Œä¸åŒåˆ†ä»£çš„å¯¹è±¡ä½¿ç”¨ä¸åŒçš„GCå›æ”¶ç­–ç•¥ï¼š

* å¯¹æ–°ç”Ÿä»£(Young Generation)æ‰§è¡Œçš„GCç§°ä¸ºæ–°ç”Ÿä»£GC(Minor GC)ï¼›

* å¯¹è€å¹´ä»£(Old Generation)æ‰§è¡Œçš„GCç§°ä¸ºè€å¹´ä»£GC(Major GC)ï¼›

* å½“æ–°ç”Ÿä»£å¯¹è±¡è¾¾åˆ°ä¸€å®šå¹´é¾„è¦æ±‚åä¼šè¿ç§»åˆ°è€å¹´ä»£ï¼Œè¿™ä¸ªâ€œæˆå¹´ç¤¼â€ç§°ä¸ºæ™‹å‡(Promotion)æˆ–è€åŒ–(Tenuring)ï¼›

* å¯¹æ•´ä¸ªå †å†…å­˜(æ–°ç”Ÿä»£å’Œè€å¹´ä»£)æ‰§è¡Œçš„GCç§°ä¸ºFull GCã€‚

# 9ã€Ungaråˆ†ä»£

åˆ†ä»£GCè¿™ä¸ªæ¦‚å¿µæœ€æ—©ç”±[David Ungar](https://en.wikipedia.org/wiki/David_Ungar)äº1984å¹´åœ¨[è®ºæ–‡](https://people.cs.umass.edu/~emery/classes/cmpsci691s-fall2004/papers/p157-ungar.pdf)ä¸­æå‡ºçš„ï¼Œä»–å°†å †å†…å­˜åˆ†ä¸º4ä¸ªç©ºé—´ï¼šEdenã€ä¸¤ä¸ªSurvivorã€OldGenï¼Œå…¶ä¸­Edenå’Œä¸¤ä¸ªSurvivoråˆç§°ä¸ºæ–°ç”Ÿä»£ç©ºé—´ã€‚

> æ³¨ï¼šè®ºæ–‡ä¸­å„ç©ºé—´åå­—å¹¶éå¦‚æ­¤ï¼Œè¿™æ ·å†™åªæ˜¯ä¸ºäº†è´´åˆHotspot VM

![David Ungaråˆ†ä»£](http://ww1.sinaimg.cn/large/bda5cd74ly1fxb8p2gs6lj20ke06qaa4.jpg)

> Edenæ˜¯ä¼Šç”¸å›­çš„æ„æ€ï¼Œå¯¹è±¡åˆç”Ÿçš„åœ°æ–¹â€”â€”èµ·è¿™ä¸ªåå­—çš„è‚¯å®šæ˜¯è€¶ç¨£çš„è™”è¯šä¿¡å¾’ğŸ˜‚ã€‚

æ–°åˆ›å»ºçš„å¯¹è±¡å°†åœ¨Edenä¸Šåˆ†é…ç©ºé—´ï¼ŒEdenåŒºæ»¡äº†ï¼Œæ–°ç”Ÿä»£GCå°†ä¼šè¢«è§¦å‘ï¼Œå­˜æ´»çš„å¯¹è±¡å°†è¢«å¤åˆ¶è¿›Survivor-ToåŒºï¼Œä¸Šæ¬¡GCå­˜æ´»å¯¹è±¡å­˜å‚¨åœ¨Survivor-FromåŒºï¼Œå¦‚æœå¯¹è±¡ä»å­˜æ´»ä¹Ÿä¼šè¢«å¤åˆ¶è¿›Survivor-ToåŒºã€‚ç»å†ä¸€æ¬¡GCåï¼Œå¯¹è±¡çš„å¹´é¾„å°†ä¼šå¢å¤§ä¸€å²ã€‚

![David Ungar](http://ww1.sinaimg.cn/large/bda5cd74ly1fxb7nmi8lwj20cl0ghwem.jpg)

å½“æ–°ç”Ÿä»£å¯¹è±¡å¹´é¾„å¢é•¿åˆ°ä¸€ä¸ªæŒ‡å®šçš„å€¼åï¼Œå¯¹è±¡å°†ä¼šæ™‹å‡åˆ°è€å¹´ä»£ã€‚å½“è€å¹´ä»£æ»¡äº†å°±ä¼šè§¦å‘è€å¹´ä»£GCï¼ŒUngaråœ¨è®ºæ–‡ä¸­ä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•å›æ”¶è€å¹´ä»£å¯¹è±¡ã€‚åœ¨æ–°ç”Ÿä»£æ™‹å‡çš„å¯¹è±¡æŠŠè€å¹´ä»£å¡«æ»¡ä¹‹å‰ï¼Œè€å¹´ä»£GCéƒ½ä¸ä¼šè§¦å‘ï¼Œæ‰€ä»¥è€å¹´ä»£GCæ‰§è¡Œé¢‘ç‡æ¯”æ–°ç”Ÿä»£ä½ã€‚

**ä¼˜ç‚¹ï¼š**

ç”±äºæ–°ç”Ÿä»£å¯¹è±¡æœç”Ÿå¤•æ­»ï¼Œå­˜æ´»çš„å¯¹è±¡æ•°ä¸å¤šï¼Œä½¿ç”¨å¤åˆ¶ç®—æ³•æ—¶å¤åˆ¶æ“ä½œä¸ä¼šç‰¹åˆ«æŸè€—æ€§èƒ½ã€‚åŒæ—¶EdenåŒºç©ºé—´é€šå¸¸å¤§äºSuvivoråŒºï¼Œè€Œä¸”Minor GCåï¼Œå¤§çš„EdenåŒºä»ä½œä¸ºå¯¹è±¡åˆ†é…çš„åœ°æ–¹ï¼Œæ‰€ä»¥ä¸åƒä¼ ç»Ÿå¤åˆ¶ç®—æ³•é‚£æ ·æµªè´¹ä¸€åŠçš„ç©ºé—´ã€‚

**ç¼ºç‚¹ï¼š**

â€œå¾ˆå¤šå¯¹è±¡å¹´çºªè½»è½»å°±ä¼šæ­»â€è¿™ä¸ªè®¤çŸ¥åªé€‚åˆäºå¤§å¤šæ•°æƒ…å†µï¼Œå¹¶ä¸é€‚ç”¨äºæ‰€æœ‰ç¨‹åºã€‚å¯¹äºç‰¹æ®Šçš„åº”ç”¨ç¨‹åºï¼Œä¼šäº§ç”Ÿä¸¤ä¸ªé—®é¢˜ï¼šæ–°ç”Ÿä»£GCèŠ±è´¹æ—¶é—´å¢å¤šï¼›è€å¹´ä»£GCé¢‘ç¹è¿è¡Œã€‚

> æ–°ç”Ÿä»£çš„å¯¹è±¡è¢«è€å¹´ä»£å¼•ç”¨ï¼Œè¿™ä¸ªå¯¹è±¡å±äºæ–°ç”Ÿä»£è¿˜æ˜¯è€å¹´ä»£ï¼Ÿå¾€è€å¹´ä»£å¤åˆ¶ï¼Œæå‰æˆå¹´ï¼Ÿ
>
> æ–°ç”Ÿä»£GC Rootæ˜¯å¦éœ€è¦åŒ…æ‹¬è€å¹´ä»£ï¼Ÿ
>
> å¹¸å­˜è€…åŒºæ»¡äº†æ€ä¹ˆåŠï¼Ÿ

# 10ã€JVMè§„èŒƒä¸å†…å­˜ç»“æ„

ç›®å‰Oracle JDKå’ŒOpen JDKä½¿ç”¨çš„[JVM](https://en.wikipedia.org/wiki/Java_virtual_machine)éƒ½æ˜¯Hotspot VMï¼Œå¸‚åœºä¸Šä¹Ÿæœ‰ä¸€äº›[å…¶ä»–è™šæ‹Ÿæœº](https://en.wikipedia.org/wiki/Comparison_of_Java_virtual_machines)ï¼Œå®ƒä»¬å¤§å¤šéµå¾ª[JVMè§„èŒƒ](https://docs.oracle.com/javase/specs/index.html)ã€‚

Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰äº†ç¨‹åºæ‰§è¡ŒæœŸé—´ä½¿ç”¨çš„å„ç§è¿è¡Œæ—¶æ•°æ®åŒºã€‚å…¶ä¸­ä¸€äº›æ•°æ®åŒºåŸŸæ˜¯è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œåªåœ¨è™šæ‹Ÿæœºé€€å‡ºæ—¶é”€æ¯ã€‚å…¶ä»–çš„æ•°æ®åŒºåŸŸå½’å±äºç‰¹å®šçº¿ç¨‹ï¼Œçº¿ç¨‹æ•°æ®åŒºåŸŸæ˜¯çº¿ç¨‹åˆ›å»ºæ—¶åˆ›å»ºé€€å‡ºæ—¶é”€æ¯ã€‚

![HotSpot JVM Architecture](http://ww1.sinaimg.cn/large/bda5cd74ly1fxpcdwwmmij20qo0k0wf3.jpg)

## 10.1ã€pcå¯„å­˜å™¨

JVMå¯ä»¥æ”¯æŒå¤šçº¿ç¨‹ï¼Œæ¯ä¸ªè™šæ‹Ÿæœºçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„pc(program counter)å¯„å­˜å™¨ã€‚åœ¨ä»»ä½•æ—¶å€™ï¼Œçº¿ç¨‹çš„å½“å‰æ–¹æ³•å¦‚æœä¸æ˜¯nativeï¼Œåˆ™pcå¯„å­˜å™¨å­˜å‚¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„JVMæŒ‡ä»¤åœ°å€ã€‚

## 10.2ã€è™šæ‹Ÿæœºå †æ ˆ

æ¯ä¸ªJVMçº¿ç¨‹åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç§æœ‰å †æ ˆï¼ŒJVMå †æ ˆç±»ä¼¼äºä¼ ç»ŸCè¯­è¨€çš„å †æ ˆï¼šä¿å­˜äº†å±€éƒ¨å˜é‡å’Œå‡½æ•°çš„å…¥å‚ï¼Œè¿™äº›æ•°æ®åœ¨å‡½æ•°è¿”å›æ—¶ä¼šéšç€æ ˆå¸§å¼¹å‡ºè€Œå›æ”¶ã€‚è§„èŒƒä¸­å…è®¸JVMå †æ ˆå…·æœ‰å›ºå®šå¤§å°æˆ–åŠ¨æ€ä¼¸ç¼©ã€‚

- å¦‚æœçº¿ç¨‹è¿è¡Œæ—¶å †æ ˆè¶…å‡ºé¢„å®šå¤§å°ï¼ŒJVMä¼šæŠ›å‡ºä¸€ä¸ª`StackOverflowError`ã€‚
- å¦‚æœå¯ä»¥åŠ¨æ€æ‰©å±•JVMå †æ ˆï¼Œå¹¶ä¸”å°è¯•è¿›è¡Œæ‰©å±•ä½†å†…å­˜ä¸è¶³ï¼Œæˆ–è€…å†…å­˜ä¸è¶³ä»¥ä¸ºæ–°çº¿ç¨‹åˆ›å»ºåˆå§‹JVMå †æ ˆï¼ŒJVMä¼šæŠ›å‡ºä¸€ä¸ª`OutOfMemoryError`ã€‚

> åœ¨Hotspotä¸­çº¿ç¨‹å †æ ˆå¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿé»˜è®¤å€¼ä¸ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡-Xss(-XX:ThreadStackSize)å‚æ•°è¿›è¡Œè°ƒèŠ‚ã€‚

## 10.3ã€Javaå †

Javaå †æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜ï¼Œæ‰€æœ‰çš„ç±»å®ä¾‹å’Œæ•°ç»„éƒ½åœ¨æ­¤åˆ†é…ã€‚Javaå †åœ¨JVMå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ç”±åƒåœ¾å›æ”¶å™¨ç®¡ç†ã€‚

JVMè§„èŒƒé‡Œå¹¶æ²¡æœ‰è§„å®šJavaå †çš„ç®¡ç†æ–¹å¼ï¼Œæ‰€ä»¥ä¸åŒçš„è™šæ‹Ÿæœºå®ç°å¯¹äºJavaå †çš„ç®¡ç†æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚ç”šè‡³äºHotspotä¸­çš„ä¸åŒåƒåœ¾å›æ”¶å™¨å¯¹Javaå †çš„ç®¡ç†æ–¹å¼ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚

æ¯”å¦‚è¯´åœ¨Oracleçš„JRockitè™šæ‹Ÿæœºä¸­ï¼ŒJavaå †æ˜¯è¿™æ ·åˆ’åˆ†çš„ï¼š

![JRockit](http://ww1.sinaimg.cn/large/bda5cd74ly1fxo4pda6wqj20kt05c3yh.jpg)

IBMçš„J9è™šæ‹Ÿæœºå †ç»“æ„å¦‚ä¸‹ï¼š

![IBM J9](http://ww1.sinaimg.cn/large/bda5cd74ly1fxo4z0khvdj20jm056q2v.jpg)

Hotspotå †ç»“æ„ï¼š

![HotSpot](http://ww1.sinaimg.cn/large/bda5cd74ly1fxo51thjgxj20k80500sq.jpg)

å› ä¸ºCMSç­‰åƒåœ¾å›æ”¶å™¨çš„GCæ—¶é—´ä¸Javaå †å¤§å°æˆæ­£æ¯”ï¼Œä¸ºäº†è§£å†³å¤§å†…å­˜çš„GCè€—æ—¶é—®é¢˜ï¼ŒJDK7å¼€å§‹Hotspotå¼•å…¥äº†æ–°åƒåœ¾å›æ”¶å™¨â€”â€”Garbage Firstï¼ˆG1ï¼‰ã€‚G1çš„å †ç»“æ„å¦‚ä¸‹ï¼š

![Hotspot G1](http://ww1.sinaimg.cn/large/bda5cd74ly1fxo5auekqmj20mj05dt8q.jpg)

> æ”¶è´­Sunå…¬å¸åï¼Œ[Oracleè‡´åŠ›äºå°†JRockitçš„åŠŸèƒ½å¼•å…¥Hotspot](https://stackoverflow.com/questions/8068717/jrockit-jvm-versus-hotspot-jvm)ã€‚
>
> ä¸‹é¢ä¼šé‡ç‚¹ä»‹ç»Hotspotå †çš„ç»†èŠ‚

## 10.4ã€æ–¹æ³•åŒº

[æ–¹æ³•åŒº](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4)ä¹Ÿæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜ã€‚æ–¹æ³•åŒºä¸­åŒ…æ‹¬æ¯ä¸ªç±»çš„ç»“æ„ï¼šè¿è¡Œæ—¶å¸¸é‡æ± ï¼Œç±»çš„å­—æ®µå’Œæ–¹æ³•ç­‰ä¿¡æ¯ï¼Œæ–¹æ³•ã€æ„é€ å™¨å’Œä»£ç å—çš„JVMæŒ‡ä»¤ã€‚æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å †çš„ä¸€éƒ¨åˆ†ï¼Œä½†è§„èŒƒä¸è¦æ±‚å¯¹æ–¹æ³•åŒºè¿›è¡Œåƒåœ¾å›æ”¶ï¼ˆåªæ˜¯Hotspotç­‰å•†ç”¨è™šæ‹Ÿæœºéƒ½å®ç°äº†è¯¥åŒºåŸŸçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼‰ï¼Œæ–¹æ³•åŒºçš„å†…å­˜ä¸è¦æ±‚è¿ç»­ï¼Œå¯ä»¥å›ºå®šå¤§å°ä¹Ÿå¯ä»¥åŠ¨æ€ä¼¸ç¼©ã€‚

## 10.5ã€è¿è¡Œæ—¶å¸¸é‡æ± 

`.class`æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ª[`constant_pool`è¡¨](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4)ï¼Œå®ƒåŒ…å«äº†å‡ ç§å¸¸é‡ï¼šç¼–è¯‘æ—¶å·²çŸ¥çš„å­—é¢é‡ï¼Œè¿è¡Œæ—¶è§£æçš„æ–¹æ³•å¼•ç”¨å’Œå­—æ®µå¼•ç”¨ã€‚

æ¯”å¦‚ä¸‹é¢çš„è¿™æ®µJavaä»£ç ï¼š

```java
public class ConstantPoolTest {
    public void print() {
        System.out.println("Hello Java");
    }
}
```

`.class`æ–‡ä»¶çš„ç»“æ„ï¼š

```java
public class ConstantPoolTest
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #6.#17   // java/lang/Object."<init>":()V
   #2 = Fieldref           #18.#19  // java/lang/System.out:Ljava/io/PrintStream;
   #3 = String             #20      // Hello Java
   #4 = Methodref          #21.#22  // java/io/PrintStream.println:(Ljava/lang/String;)V
   ...
   #18 = Class              #25     // java/lang/System
   #19 = NameAndType        #26:#27 // out:Ljava/io/PrintStream;
   #20 = Utf8               Hello Java
   #21 = Class              #28     // java/io/PrintStream
   #22 = NameAndType        #29:#30 // println:(Ljava/lang/String;)V
   #23 = Utf8               ConstantPoolTest
   #24 = Utf8               java/lang/Object
   #25 = Utf8               java/lang/System
   #26 = Utf8               out
   #27 = Utf8               Ljava/io/PrintStream;
   #28 = Utf8               java/io/PrintStream
   #29 = Utf8               println
   #30 = Utf8               (Ljava/lang/String;)V
{
   ...
  public void print();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #2    // Systemç±»çš„é™æ€å­—æ®µå¼•ç”¨
         3: ldc           #3    // å­—ç¬¦ä¸²å¸¸é‡
         5: invokevirtual #4    // è°ƒç”¨#4æ–¹æ³•
         8: return
      LineNumberTable:
        line 7: 0
        line 8: 8
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       9     0  this   LConstantPoolTest;
}
```

è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚[å½“ç±»æˆ–æ¥å£è¢«åˆ›å»º](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html#jvms-5.3)æ—¶å¸¸é‡æ± ä¼šè¢«ä¸€èµ·åˆ›å»ºã€‚

## 10.6ã€æœ¬åœ°æ–¹æ³•æ ˆ

JVMå¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„Cå †æ ˆä»¥æ”¯æŒnativeæ–¹æ³•çš„æ‰§è¡Œï¼Œå¦å¤–æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šè¢«Cè¯­è¨€å®ç°çš„JavaæŒ‡ä»¤è§£é‡Šå™¨(Hotspotä¸­çš„JIT)ä½¿ç”¨ã€‚

# 11ã€Hotspot

> å£°æ˜ï¼šåç»­çš„Hotspotå‚æ•°åœ¨ä¸åŒçš„JDKç‰ˆæœ¬ä¸­ä¼šæœ‰äº›è®¸å·®å¼‚ã€‚

[Hotspot](https://en.wikipedia.org/wiki/HotSpot)è™šæ‹Ÿæœºä¸­æœ€å…³é”®çš„ä¸‰ä¸ªç»„ä»¶æ˜¯ï¼šJavaå †ã€JITå³æ—¶ç¼–è¯‘å™¨ã€åƒåœ¾å›æ”¶å™¨ã€‚

![Heapspot key Component](http://ww1.sinaimg.cn/large/bda5cd74ly1fxpcf1jowfj20qo0k074w.jpg)

## 11.1ã€JITç¼–è¯‘å™¨

JITåŠæ—¶ç¼–è¯‘å™¨æ”¯æŒä¸‰ç§æ¨¡å¼ï¼š`interpreted-only`ã€`compilation `ã€`mixed`ï¼Œåˆ†åˆ«å¯ä»¥ç”¨`-Xint`ã€`-Xcomp`ã€`-Xmixed`é€‰é¡¹å¼€å¯ã€‚

åœ¨`interpreted-only`æ¨¡å¼ä¸‹ï¼ŒJVMä¸ä¼šç¼–è¯‘å­—èŠ‚ç ï¼Œæ‰€æœ‰çš„å­—èŠ‚ç ç”±è§£é‡Šå™¨ä¸´æ—¶è§£é‡Šæ‰§è¡Œã€‚JITçš„æ€§èƒ½ä¼˜åŠ¿åœ¨è¿™ç§æ¨¡å¼ä¸‹å°±æ— æ³•å¾—åˆ°ä½“ç°ã€‚

åœ¨`compilation `æ¨¡å¼ä¸‹ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ–¹æ³•æ—¶JVMä¼šå¼ºåˆ¶å°†æ–¹æ³•ç¼–è¯‘æˆæœºå™¨ç ï¼Œè¿™äº›ç¼–è¯‘è¿‡çš„ä»£ç å°†ä¼šè¢«ç¼“å­˜èµ·æ¥ï¼Œä¸‹æ¬¡è°ƒç”¨å°†ç›´æ¥æ‰§è¡Œæœºå™¨ç ã€‚Hotspotæä¾›äº†`-Xmaxjitcodesize`(`-XX:ReservedCodeCacheSize`)é€‰é¡¹è®¾ç½®JITç¼–è¯‘ä»£ç çš„ç¼“å­˜å¤§å°ï¼ˆé»˜è®¤240Mï¼‰ã€‚

åœ¨`mixed`æ¨¡å¼ä¸‹ï¼Œåªä¼šæŠŠçƒ­ç‚¹æ–¹æ³•ç¼–è¯‘æˆæœºå™¨ç ï¼Œé™¤æ­¤ä¹‹å¤–æ‰€æœ‰å­—èŠ‚ç ç”±è§£é‡Šå™¨ä¸´æ—¶è§£é‡Šæ‰§è¡Œã€‚

Hotspoté»˜è®¤ä½¿ç”¨æ··åˆæ¨¡å¼ï¼š

![JVM](http://ww1.sinaimg.cn/large/bda5cd74ly1fxv3yl9hx3j20fi0290sm.jpg)

å¯¹æ¯”è§£é‡Šæ‰§è¡Œï¼Œç¼–è¯‘çš„å¥½å¤„æ˜¯ä¼šå¯¹æ–¹æ³•ä¸­çš„ä»£ç è¿›è¡Œä¼˜åŒ–ï¼šæ¶ˆé™¤ä¸å¿…è¦çš„å˜é‡ã€å¾ªç¯å¤–æã€åˆ é™¤æ— ç”¨èµ‹å€¼ç­‰ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šè¿›è¡ŒæŒ‡ä»¤é‡æ’ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹èƒ½ä¿è¯åŸæœ‰è¯­ä¹‰ï¼Œä½†æ˜¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå½±å“ç¨‹åºçš„æ­£å¸¸é€»è¾‘ã€‚

é™¤äº†ç¼–è¯‘ä¸Šçš„ä¼˜åŒ–ï¼ŒJITè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ä¼˜åŒ–ç­–ç•¥ã€‚æ¯”å¦‚ï¼š

* é€šè¿‡[é€ƒé€¸åˆ†æ](https://en.wikipedia.org/wiki/Escape_analysis)å°†åŸæœ¬éœ€è¦åœ¨å †ä¸Šåˆ†é…çš„å¯¹è±¡è½¬æ¢ä¸ºæ ˆåˆ†é…ï¼Œæ ˆä¸Šåˆ†é…å¯¹è±¡çš„å¥½å¤„æ˜¯éšç€å‡½æ•°è¿”å›ï¼Œå¯¹è±¡å†…å­˜ä¼šè‡ªåŠ¨å›æ”¶ï¼Œè€Œä¸éœ€è¦é€šè¿‡GCå›æ”¶ï¼Œé—´æ¥åœ°å‡å°‘äº†GCçš„è¿è¡Œé¢‘ç‡ã€‚

* å°†è°ƒç”¨é¢‘ç‡é«˜ä¸”ä½“é‡å°çš„æ–¹æ³•è¿›è¡Œå†…è”ï¼Œè¿™å’ŒC++çš„å†…è”å‡½æ•°ä½œç”¨ä¸€æ ·ã€‚å‡å°‘å‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥å‡å°‘å› å…¥æ ˆæ¶ˆè€—çš„æ—¶é—´ã€‚



JITçš„å†…å®¹ä¸æ˜¯æœ¬æ–‡çš„æ ¸å¿ƒï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡Œè°·æ­Œæˆ–[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://docs.oracle.com/javase/8/embedded/develop-apps-platforms/codecache.htm)ã€‚

ä¸‹é¢ä¸»è¦è®²å¾—æ˜¯Hotspotä¸­çš„Javaå †ä»¥åŠç®¡ç†Javaå †çš„åƒåœ¾å›æ”¶å™¨ã€‚

## 11.2ã€Hotspotåˆ†ä»£

Hotspotä½¿ç”¨Ungaråˆ†ä»£ç­–ç•¥ç®¡ç†Javaå †ï¼Œå¹¶æä¾›äº†ç›¸åº”çš„å‚æ•°è®¾ç½®å„ä¸ªåˆ†ä»£çš„å¤§å°ï¼š

![JVMåˆ†ä»£](http://ww1.sinaimg.cn/large/bda5cd74ly1fxo5teibzaj20nb0c7wfs.jpg)

ä¸Šå›¾ä¸­`reserved`æ˜¯æ“ä½œç³»ç»Ÿä¿ç•™çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œåœ¨è™šæ‹Ÿæœºåˆšè¿è¡Œæ—¶åªä¼šåˆ†é…`-Xms`å¤§å°çš„ç‰©ç†å†…å­˜ï¼Œè€Œä¸”Javaå †ä¼šé€šè¿‡ä»¥ä¸‹ç­–ç•¥å°½å¯èƒ½çš„å‡å°‘ç‰©ç†å†…å­˜çš„æ¶ˆè€—ã€‚

| å‚æ•°                         | è¯´æ˜                                     | é»˜è®¤å€¼               |
| ---------------------------- | ---------------------------------------- | -------------------- |
| `-XX:MinHeapFreeRatio`       | ç»è¿‡ä¸€æ¬¡GCäº‹ä»¶åå…è®¸çš„æœ€å°å †å†…å­˜ç©ºé—²æ¯”ä¾‹ | 70%                  |
| `-XX:MaxHeapFreeRatio`       | ç»è¿‡ä¸€æ¬¡GCäº‹ä»¶åå…è®¸çš„æœ€å¤§å †å†…å­˜ç©ºé—²æ¯”ä¾‹ | 40%                  |
| `-Xms`/`-XX:InitialHeapSize` | Javaå †çš„åˆå§‹å®¹é‡                         | æ ¹æ®ç³»ç»Ÿé…ç½®åŠ¨æ€é€‰æ‹© |
| `-Xmx`/`-XX:MaxHeapSize`     | Javaå †çš„æœ€å¤§å®¹é‡                         | Linux 2000M          |

å¦‚æœç»è¿‡GCåç©ºé—²å†…å­˜æ¯”ä¾‹å°äº40%ï¼Œåˆ†ä»£å°†ä¼šæ‰©å®¹è‡³40%çš„ç©ºé—²å†…å­˜å æ¯”ï¼Œç›´åˆ°åˆ†ä»£å…è®¸çš„æœ€å¤§å†…å­˜å®¹é‡ã€‚

å¦‚æœç»è¿‡GCåç©ºé—²å†…å­˜æ¯”ä¾‹å¤§äº70%ï¼Œåˆ†ä»£å°†ä¼šæ”¶ç¼©è‡³70%çš„ç©ºé—²å†…å­˜å æ¯”ï¼Œç›´åˆ°åˆ†ä»£å…è®¸çš„æœ€å°å†…å­˜å®¹é‡ã€‚

ä½†æ˜¯ä»»ä½•ä¸€ä¸ªåˆ†ä»£çš„Resizeéƒ½ä¼šå¯¼è‡´Full GCï¼Œè®¾ç½®`-Xms=-Xmx`å¯ä»¥é˜²æ­¢ç”±`-Xms`åˆ°`-Xmx`å¢é•¿è¿‡ç¨‹ä¸­Resizeæ“ä½œå¯¼è‡´çš„Full GCã€‚

é™¤äº†ä»¥ä¸Šå‡ ä¸ªé‡è¦çš„å‚æ•°ä»¥å¤–ï¼ŒHotspotè¿˜æä¾›äº†å¾ˆå¤šå…¶ä»–å‚æ•°é…ç½®ã€‚

æ¯”å¦‚è¯´ï¼š

`-XX:SurvivorRatio`å¯ä»¥è®¾ç½®æ–°ç”Ÿä»£ä¸­EdenåŒºåŸŸSurvivoråŒºçš„æ¯”ä¾‹ï¼ˆé»˜è®¤8ï¼‰ã€‚

![survivorRatio](http://ww1.sinaimg.cn/large/bda5cd74ly1fxpdrde1vvj20vz06v75f.jpg)

`-XX:MaxTenuringThreshold`å¯ä»¥è®¾ç½®æ–°ç”Ÿä»£åˆ°è€å¹´ä»£çš„è€åŒ–å¹´é¾„ï¼ˆæœ€å¤§å€¼æ˜¯15ï¼Œå¹¶è¡Œæ”¶é›†å™¨é»˜è®¤15ï¼ŒCMSé»˜è®¤6ï¼‰ã€‚

![å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ](http://ww1.sinaimg.cn/large/bda5cd74ly1fxo88x0s41g20qa0d5wg3.gif)

> æ›´å¤šçš„JVMå‚æ•°ä»¥åŠå‚æ•°çš„é»˜è®¤å€¼å¯ä»¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html)ã€‚

## 11.3ã€PermGenä¸Metaspace

æ°¸ä¹…ä»£ï¼ˆPermGenï¼‰ä¸­ä¸»è¦å­˜å‚¨ï¼šç±»å…ƒæ•°æ®ç­‰é™æ€æ•°æ®ã€‚ä¹Ÿå°±æ˜¯JVMè§„èŒƒä¸­çš„æ–¹æ³•åŒºæ‰€å­˜å‚¨çš„åŒºåŸŸã€‚

æ°¸ä¹…ä»£åœ¨[32ä½JVMä¸Šé»˜è®¤æœ€å¤§å†…å­˜ä¸º64Mï¼Œåœ¨64ä½JVMä¸Šé»˜è®¤æœ€å¤§å†…å­˜ä¸º82M](https://www.baeldung.com/java-permgen-metaspace)ã€‚

è™½ç„¶æ°¸ä¹…ä»£å¯ä»¥é€šè¿‡`-XX:PermSize`å’Œ`-XX:MaxPermSize`è¿›è¡Œè°ƒèŠ‚ï¼Œä½†ç”±äºæ°¸ä¹…ä»£æ²¡æœ‰å¾ˆå¥½çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå¯¹äºå¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€å­—èŠ‚ç æ¡†æ¶çš„åº”ç”¨ç»å¸¸ä¼šç”±äº**PermGen**å†…å­˜ä¸è¶³å¯¼è‡´OutOfMemoryErrorã€‚

æ‰€ä»¥Java8ä¸­ç”¨Metaspaceå–ä»£äº†PermGenã€‚

![Metaspace](http://ww1.sinaimg.cn/large/bda5cd74ly1fxo9oiczhbj20e908cwep.jpg)

## 11.4ã€å¯é€‰çš„åƒåœ¾å›æ”¶å™¨

Hotspot VMåŒ…æ‹¬ä¸‰ç§ä¸åŒç±»å‹çš„åƒåœ¾æ”¶é›†å™¨ï¼Œæ¯ç§æ”¶é›†å™¨å…·æœ‰ä¸åŒçš„æ€§èƒ½ç‰¹å¾ä¸ä¸åŒçš„é€‚ç”¨åœºæ™¯ã€‚

### 11.4.1ã€ä¸²è¡Œæ”¶é›†å™¨

ä¸²è¡Œæ”¶é›†å™¨ä½¿ç”¨å•ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ‰€æœ‰åƒåœ¾æ”¶é›†å·¥ä½œã€‚å› ä¸ºçº¿ç¨‹ä¹‹é—´æ²¡æœ‰é€šä¿¡å¼€é”€ï¼Œæ‰€ä»¥å›æ”¶æ•ˆç‡è¾ƒé«˜ã€‚å®ƒæœ€é€‚åˆå•å¤„ç†å™¨æœºå™¨ï¼Œå› ä¸ºå®ƒæ— æ³•åˆ©ç”¨å¤šå¤„ç†å™¨ç¡¬ä»¶ã€‚å®ƒå¯¹äºå…·æœ‰å°æ•°æ®é›†ï¼ˆæœ€å¤§çº¦100 MBï¼‰çš„å¤šå¤„ç†å™¨åº”ç”¨ç¨‹åºä¹Ÿéå¸¸æœ‰æ•ˆã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒJVMä¼šæ ¹æ®ç¡¬ä»¶ã€æ“ä½œç³»ç»Ÿä»¥åŠJVMé…ç½®(-client)é€‰ç”¨ä¸²è¡Œæ”¶é›†å™¨ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨`-XX:+UseSerialGC`é€‰é¡¹æ˜¾å¼å¯ç”¨ä¸²è¡Œæ”¶é›†å™¨ã€‚

![ä¸²è¡ŒGC](http://ww1.sinaimg.cn/large/bda5cd74ly1fxrar3t3u9j20ev04hglm.jpg)

> ä¸²è¡Œæ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£ä½¿ç”¨å‹ç¼©æ•´ç†ç®—æ³•ã€‚

### 11.4.2ã€å¹¶è¡Œæ”¶é›†å™¨

å¹¶è¡Œæ”¶é›†å™¨ï¼ˆä¹Ÿç§°ä¸º[ååé‡](https://translate.google.cn/#view=home&op=translate&sl=en&tl=zh-CN&text=throughput)æ”¶é›†å™¨ï¼‰å¹¶è¡Œæ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œè¿™å¯ä»¥æ˜¾ç€å‡å°‘åƒåœ¾æ”¶é›†å¼€é”€ã€‚å®ƒé€‚ç”¨äºåœ¨å¤šå¤„ç†å™¨ç¡¬ä»¶ä¸Šè¿è¡Œçš„å…·æœ‰ä¸­å‹åˆ°å¤§å‹æ•°æ®é›†çš„åº”ç”¨ç¨‹åºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒJVMä¼šæ ¹æ®ç¡¬ä»¶ã€æ“ä½œç³»ç»Ÿä»¥åŠJVMé…ç½®(-server)é€‰ç”¨ä¸²è¡Œæ”¶é›†å™¨ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨`-XX:+UseParallelGC`é€‰é¡¹æ˜¾å¼å¯ç”¨å¹¶è¡Œæ”¶é›†å™¨ã€‚

![ParallelGC](http://ww1.sinaimg.cn/large/bda5cd74ly1fxrbbp2cdxj20hj04kaa4.jpg)



[åœ¨Java8ä¹‹å‰`-XX:+UseParallelGC`é»˜è®¤ä¸ä¼šå¯ç”¨è€å¹´ä»£çš„å¹¶è¡ŒGC](https://blogs.oracle.com/jonthecollector/our-collectors)ï¼Œè€å¹´ä»£ä»ç„¶ä½¿ç”¨ä¸²è¡ŒGCï¼Œéœ€è¦ä½¿ç”¨`-XX:+UseParallelOldGC`å¼€å¯è€å¹´ä»£å¹¶è¡ŒGCã€‚

åœ¨Java8ä¸­`-XX:+UseParallelGC`é»˜è®¤ä¼šå¯ç”¨è€å¹´ä»£å¹¶è¡ŒGCï¼Œå¯ä»¥ä½¿ç”¨`-XX:-UseParallelOldGC`é€‰é¡¹å…³é—­è€å¹´ä»£å¹¶è¡ŒGCã€‚

æ–°ç”Ÿä»£å¹¶è¡ŒGCé»˜è®¤ä½¿ç”¨**Parallel Scavenge**æ”¶é›†å™¨ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ª**ParNewGC**å›æ”¶å™¨ã€‚

ParNewGCä¸»è¦é…åˆCMSæ”¶é›†å™¨ä½¿ç”¨ï¼Œå› ä¸ºParNewGCæœ‰CMSå¹¶å‘é˜¶æ®µæ‰€éœ€è¦çš„ä¸€äº›åŒæ­¥æ“ä½œã€‚`-XX:+UseParNewGC`é€‰é¡¹å¯ä»¥å¼€å¯æ–°ç”Ÿä»£çš„ParNewGCï¼Œæ­¤æ—¶è€å¹´ä»£ä½¿ç”¨Serial Oldã€‚ParNewGCä¸èƒ½å’ŒParallelOldGCä¸€èµ·ä½¿ç”¨ï¼ˆåŸå› [åœ¨è¿™](https://blogs.oracle.com/jonthecollector/our-collectors)ï¼Œæˆ‘ä¹Ÿæ²¡æ€ä¹ˆçœ‹æ˜ç™½)ã€‚åœ¨Java8ä¸­UseParNewGCåªèƒ½å’ŒCMSé…åˆä½¿ç”¨ã€‚

### 11.4.3ã€å¹¶å‘æ”¶é›†å™¨

å‰é¢çš„æ”¶é›†å™¨åœ¨æ”¶é›†è¿‡ç¨‹ä¸­ç”¨æˆ·çº¿ç¨‹ä¼šå®Œå…¨æš‚åœ(ä¹Ÿå«Stop The World)ï¼Œæ”¶é›†å®Œæˆåç”¨æˆ·çº¿ç¨‹æ‰ä¼šç»§ç»­è¿è¡Œã€‚è¿™ä¸ªæš‚åœæ—¶é—´å¯èƒ½ä¼šæŒç»­ä¸€ç§’ä»¥ä¸Šï¼Œå¯¹å“åº”é€Ÿåº¦æœ‰è¦æ±‚çš„åº”ç”¨å¯èƒ½ä¼šæœ‰ä¸å¥½çš„ä½“éªŒï¼Œæ‰€ä»¥Hotspotè¿˜æä¾›äº†å¹¶å‘æ”¶é›†å™¨ã€‚

**å¹¶å‘æ”¶é›†å™¨å…è®¸åº”ç”¨çº¿ç¨‹ä¸GCçº¿ç¨‹å¹¶å‘æ‰§è¡Œ**ã€‚è¿™ä¹Ÿæ„å‘³ç€å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¼šå­˜åœ¨GCçº¿ç¨‹å’Œåº”ç”¨çº¿ç¨‹åˆ‡æ¢CPUçš„æŸè€—ã€‚å®ƒé€‚ç”¨äºå…·æœ‰ä¸­å‹åˆ°å¤§å‹æ•°æ®é›†ï¼Œå¹¶ä¸”å“åº”æ—¶é—´æ¯”ååé‡æ›´é‡è¦çš„åº”ç”¨ç¨‹åºã€‚

![Concurrent GC](http://ww1.sinaimg.cn/large/bda5cd74ly1fxtz1cj37vj20m105cab2.jpg)

Java HotSpot VMæä¾›ä¸¤ä¸ªå¹¶å‘åƒåœ¾å›æ”¶å™¨ï¼šCMSå’ŒG1ã€‚

ä½¿ç”¨`-XX:+UseConcMarkSweepGC`é€‰é¡¹å¯ä»¥å¯ç”¨CMSæ”¶é›†å™¨ã€‚

ä½¿ç”¨`-XX:+UseG1GC`é€‰é¡¹å¯ä»¥å¯ç”¨G1æ”¶é›†å™¨ã€‚

**CMSä¼˜ç¼ºç‚¹ï¼š**

CMSæ•´ä¸ªè¿‡ç¨‹ä¸­åªæœ‰åˆå§‹æ ‡è®°å’Œé‡æ–°æ ‡è®°é˜¶æ®µéœ€è¦StopTheWorldï¼Œç›¸å¯¹ParallelOldGCåœé¡¿æ—¶é—´è¾ƒçŸ­ã€‚

ä½†ç”±äºCMSä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿå¤§é‡å†…å­˜ç¢ç‰‡ï¼Œå½“æ— æ³•æ‰¾åˆ°è¿ç»­çš„å†…å­˜ç©ºé—´åˆ†é…æ—¶ï¼Œä¸å¾—ä¸æå‰è§¦å‘ä¸€æ¬¡FullGCã€‚é’ˆå¯¹è¿™ç‚¹CMSæä¾›äº†`-XX:+UseCMSCompactAtFullCollection`é€‰é¡¹(é»˜è®¤å¼€å¯ï¼ŒJava8ä¸­å·²å¼ƒç”¨)ï¼Œå½“å†…å­˜åˆ†é…å¤±è´¥æ—¶ä½¿ç”¨Serial Oldå¯¹å†…å­˜è¿›è¡Œæ•´ç†ã€‚è¿™æ ·è§£å†³äº†å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œä½†ç›¸åº”åœ°STWæ—¶é—´å˜å¾—æ›´é•¿ã€‚

å¦å¤–CMSæ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾(Floating Garbageï¼Œæ¸…é™¤é˜¶æ®µæ–°äº§ç”Ÿçš„åƒåœ¾)ï¼Œå¯èƒ½å‡ºç°æµ®åŠ¨åƒåœ¾åœ¨å®Œæˆæ¸…é™¤ä¹‹å‰åˆæŠŠè€å¹´ä»£å¡æ»¡äº†ï¼Œå¯¼è‡´â€œConcurrent Mode Failureâ€ä»è€Œè§¦å‘å¦ä¸€æ¬¡Full GCã€‚

å¾ˆæ˜æ˜¾CMSéœ€è¦åœ¨å¯¹è±¡å¡«æ»¡è€å¹´ä»£ä¹‹å‰å°±å¼€å§‹åˆå§‹æ ‡è®°ï¼ŒCMSæä¾›äº†`-XX:CMSInitiatingOccupancyFraction`å’Œ`-XX:CMSTriggerRatio`é€‰é¡¹æ¥æŒ‡å®šè¿™ä¸ªé˜ˆå€¼ã€‚

> æ‰€ä»¥Oracleåœ¨æ–‡æ¡£ä¸Šä¹Ÿæ˜ç¡®æŒ‡å‡ºï¼šåœ¨å¹¶è¡ŒGCæ— æ³•æ»¡è¶³åº”ç”¨å»¶æ—¶è¦æ±‚æ—¶æ‰ä½¿ç”¨CMSæ”¶é›†å™¨ã€‚
>
> G1æ”¶é›†å™¨æœ€åˆçš„å¼€å‘ç›®çš„å°±æ˜¯ä¸ºäº†æ›¿ä»£CMSã€‚G1ä½¿ç”¨åˆ†åŒºæ–¹å¼ç®¡ç†å†…å­˜ï¼Œæ‰€ä»¥G1ä¼šåŒæ—¶ç®¡ç†å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚
>
> Hotspotå›¢é˜Ÿå¯¹[G1](https://www.youtube.com/watch?v=6JcV7T9Z8SY)è¿›è¡Œäº†è®¸å¤šæ€§èƒ½ä¸Šçš„ä¼˜åŒ–ï¼Œ[G1å·²ç»æˆä¸ºJava9é»˜è®¤çš„åƒåœ¾å›æ”¶å™¨](http://blog.mgm-tp.com/2018/01/g1-mature-in-java9/)ã€‚

ä¸‹å›¾æ˜¯Hotspotå¯ç”¨æ”¶é›†å™¨çš„ç»„åˆï¼Œå…¶ä¸­è¿çº¿ä¸Šçš„é€‰é¡¹å‚æ•°æ˜¯é’ˆå¯¹Java7ï¼ŒJava8å‚æ•°æœ‰éƒ¨åˆ†æ”¹åŠ¨ï¼Œè¯¦è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html)ã€‚

![Valid GC combinations](http://ww1.sinaimg.cn/large/bda5cd74ly1fxrakmsv9vj20ko0fnjtq.jpg)

## 11.5ã€é€‰æ‹©åƒåœ¾å›æ”¶å™¨

é™¤éåº”ç”¨ç¨‹åºå…·æœ‰ç›¸å½“ä¸¥æ ¼çš„æš‚åœæ—¶é—´è¦æ±‚ï¼Œå¦åˆ™åº”è¯¥è®©JVMè‡ªè¡Œé€‰æ‹©åƒåœ¾å›æ”¶å™¨ã€‚å¦‚æœ‰å¿…è¦ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´å †å¤§å°ä»¥æé«˜æ€§èƒ½ã€‚å¦‚æœæ€§èƒ½ä»ä¸ç¬¦åˆç›®æ ‡ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æŒ‡å—ä½œä¸ºé€‰æ‹©æ”¶é›†å™¨çš„èµ·ç‚¹ã€‚

- å¦‚æœåº”ç”¨ç¨‹åºå…·æœ‰è¾ƒå°çš„æ•°æ®é›†ï¼ˆæœ€å¤§çº¦100 MBï¼‰ï¼Œé‚£ä¹ˆé€‰é¡¹é€‰æ‹©ä¸²è¡Œæ”¶é›†å™¨`-XX:+UseSerialGC`ã€‚è¿™ç§åº”ç”¨ç¨‹åºä¸€èˆ¬æ˜¯å®¢æˆ·ç«¯ç¨‹åºï¼ŒæœåŠ¡å™¨åº”ç”¨è‚¯å®šä¸é€‚ç”¨ã€‚
- å¦‚æœåº”ç”¨ç¨‹åºæ€§èƒ½æ˜¯ç¬¬ä¸€ä¼˜å…ˆçº§å¹¶ä¸”æ²¡æœ‰æš‚åœæ—¶é—´è¦æ±‚æˆ–ä¸€ç§’ä»¥ä¸Šçš„æš‚åœæ˜¯å¯æ¥å—çš„ï¼Œé‚£åº”è¯¥é€‰æ‹©å¹¶è¡Œæ”¶é›†å™¨`-XX:+UseParallelGC`ã€‚
- å¦‚æœå“åº”æ—¶é—´æ¯”æ€»ååé‡æ›´é‡è¦ï¼Œå¹¶ä¸”åƒåœ¾æ”¶é›†æš‚åœå¿…é¡»ä¿æŒçŸ­äºå¤§çº¦1ç§’ï¼Œåˆ™ä½¿ç”¨`-XX:+UseConcMarkSweepGC`æˆ–`-XX:+UseG1GC`å¹¶å‘æ”¶é›†å™¨ã€‚



å‚è€ƒï¼š

[ã€Šåƒåœ¾å›æ”¶ç®—æ³•æ‰‹å†Œï¼šè‡ªåŠ¨å†…å­˜ç®¡ç†çš„è‰ºæœ¯ã€‹Richard Jones / Eliot Moss / Antony Hoskingè‘—](https://book.douban.com/subject/26740958/)

[ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹å‘¨å¿—æ˜ è‘—](https://book.douban.com/subject/24722612/)

[ã€Šåƒåœ¾å›æ”¶çš„ç®—æ³•ä¸å®ç°ã€‹ä¸­æ‘æˆæ´‹ / ç›¸å·å…‰ è‘—](https://book.douban.com/subject/26821357/)

Javaè™šæ‹Ÿæœºè§„èŒƒï¼šhttps://docs.oracle.com/javase/specs/jvms/se8/html/index.html

GCè°ƒä¼˜æŒ‡å—ï¼šhttps://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/index.html

Java8è™šæ‹Ÿæœºå‚æ•°ï¼šhttps://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html

Java7è™šæ‹Ÿæœºå‚æ•°ï¼šhttps://docs.oracle.com/javase/7/docs/technotes/tools/solaris/java.html

GCåŸºç¡€æ•™ç¨‹ï¼šhttps://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html

G1æ”¶é›†å™¨å…¥é—¨ï¼šhttps://www.oracle.com/technetwork/tutorials/tutorials-1876574.html

G1æ”¶é›†å™¨è°ƒä¼˜ï¼šhttps://www.oracle.com/technetwork/articles/java/g1gc-1984535.html

Java6è™šæ‹ŸæœºGCè°ƒä¼˜ï¼šhttps://www.oracle.com/technetwork/java/javase/gc-tuning-6-140523.html

https://www.oracle.com/technetwork/java/javase/tech/index-jsp-136373.html

https://docs.oracle.com/javase/8/embedded/develop-apps-platforms/codecache.htm

https://blogs.oracle.com/jonthecollector/our-collectors

https://www.oracle.com/technetwork/cn/community/developer-day/2-jvm-tuning-1866448-zhs.pdf

http://www.micheltriana.com/blog/2010/12/29/garbage-collection-pt-3-generations

https://www.stechies.com/difference-between-permgen-metaspace/

https://www.sczyh30.com/posts/Java/jvm-gc-hotspot-implements/

https://en.wikipedia.org/wiki/Garbage-first_collector

https://en.wikipedia.org/wiki/Mark-compact_algorithm

https://www.baeldung.com/java-permgen-metaspace

https://en.wikipedia.org/wiki/Concurrent_mark_sweep_collector