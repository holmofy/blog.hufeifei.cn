<!doctype html><html lang="en"><head><meta charset="utf-8"><script async src="https://www.googletagmanager.com/gtag/js?id=G-H58NSPXYPF"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-H58NSPXYPF")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?b3392fb5f6d65fb10354f590338d1ee4",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(t,e,n,c,a,i){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/95vxjpui4h",(i=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,i)}(window,document,"clarity","script")</script><title>AE在WebPush技术中的探索之路 | holmofy</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="baidu_union_verify" content="b7d27ec946758934fcdf3c5c26386237"><meta description="之前几个月在做的WebPush项目，最早接入Firebase的方案，看了一下官方的demo觉得这个需求应该还是很简单的，直到做的过程中遇到fcm token失效的各种坑，以及AE多语言站点的问题，可以说是一路坎坷。 由于国内连不上谷歌服务，而谷歌的Chrome市场占有率又是最大的，所以国内基本上很少看到有做WebPush的网站，也正因此关于WebPush的中文资料寥寥无几，可以借鉴的网站都是国外的"><meta property="og:type" content="article"><meta property="og:title" content="AE在WebPush技术中的探索之路"><meta property="og:url" content="https://blog.hufeifei.cn/2020/10/Alibaba/WebPush/index.html"><meta property="og:site_name" content="holmofy"><link rel="canonical" href="https://blog.hufeifei.cn/2020/10/Alibaba/WebPush/index.html"><meta property="description" content="之前几个月在做的WebPush项目，最早接入Firebase的方案，看了一下官方的demo觉得这个需求应该还是很简单的，直到做的过程中遇到fcm token失效的各种坑，以及AE多语言站点的问题，可以说是一路坎坷。 由于国内连不上谷歌服务，而谷歌的Chrome市场占有率又是最大的，所以国内基本上很少看到有做WebPush的网站，也正因此关于WebPush的中文资料寥寥无几，可以借鉴的网站都是国外的"><meta name="description" content="之前几个月在做的WebPush项目，最早接入Firebase的方案，看了一下官方的demo觉得这个需求应该还是很简单的，直到做的过程中遇到fcm token失效的各种坑，以及AE多语言站点的问题，可以说是一路坎坷。 由于国内连不上谷歌服务，而谷歌的Chrome市场占有率又是最大的，所以国内基本上很少看到有做WebPush的网站，也正因此关于WebPush的中文资料寥寥无几，可以借鉴的网站都是国外的"><meta property="og:description" content="之前几个月在做的WebPush项目，最早接入Firebase的方案，看了一下官方的demo觉得这个需求应该还是很简单的，直到做的过程中遇到fcm token失效的各种坑，以及AE多语言站点的问题，可以说是一路坎坷。 由于国内连不上谷歌服务，而谷歌的Chrome市场占有率又是最大的，所以国内基本上很少看到有做WebPush的网站，也正因此关于WebPush的中文资料寥寥无几，可以借鉴的网站都是国外的"><meta property="article:published_time" content="2020-10-14T16:00:00.000Z"><meta property="article:modified_time" content="2024-05-03T05:17:06.687Z"><meta property="article:author" content="胡飞飞"><meta property="article:tag" content="WebPush"><meta property="keywords" content="WebPush"><meta property="twitter:card" content="summary"><script data-ad-client="ca-pub-7111912103882824" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7111912103882824" crossorigin="anonymous"></script><script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script><script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js" async defer></script><link rel="alternate" href="/atom.xml" title="holmofy" type="application/atom+xml"><link rel="icon" href="//www.hufeifei.cn/favicon.jpg"><link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"><link href="//unpkg.com/@waline/client@v3/dist/waline.css" rel="stylesheet" type="text/css"><link href="//at.alicdn.com/t/font_841402_efkj8jo1xld.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/font-awesome/5.15.3/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/style.css"><link rel="dns-prefetch" href="//static.zhimg.com"><link rel="dns-prefetch" href="//at.alicdn.com"><link rel="dns-prefetch" href="//cdn.jsdelivr.net"><link rel="dns-prefetch" href="//img-blog.csdn.net"><link rel="dns-prefetch" href="//img-blog.csdnimg.cn"><meta name="generator" content="Hexo 6.3.0"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><style>
    figure.codeblock {
       margin: 0;
    }
    figure figcaption .tabs {
      display: flex;
      margin: 0;
    }
    figure figcaption .tabs .tab {
      cursor: pointer;
      list-style: none;
      padding: 5px 15px;
    }
    figure figcaption .tabs .tab.active {
      background: #2d2d2d;
      color: white;
    }
  </style></head><body><amp-auto-ads type="adsense" data-ad-client="ca-pub-7111912103882824"></amp-auto-ads><div id="container"><div id="wrap"><header id="header"><div class="outer" id="header-outer"><div class="inner" id="header-inner"><nav id="main-nav"><a class="nav-icon" id="main-nav-toggle"><i class="fas fa-bars"></i></a><a class="main-nav-link" href="//www.hufeifei.cn">主页</a><a class="main-nav-link" href="/">博客</a><a class="main-nav-link" href="/archives">归档</a><a class="main-nav-link" target="_blank" rel="noopener" href="//algo.hufeifei.cn">算法</a><a class="main-nav-link" href="/book">书籍</a><a class="main-nav-link" href="/github">Github</a></nav><nav id="sub-nav"><a class="nav-icon" id="nav-rss-link" href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a><a class="nav-icon" id="nav-search-btn" title="Search"><i class="fas fa-search"></i></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="fas fa-search"></i></button><input type="hidden" name="sitesearch" value="https://blog.hufeifei.cn"></form></div></div></div></header><div class="outer"><section id="main"><article class="article article-type-post" id="post-Alibaba/WebPush" itemscope itemprop="blogPost"><div class="article-meta"><a class="article-date" href="/2020/10/Alibaba/WebPush/"><time datetime="2020-10-14T16:00:00.000Z" itemprop="datePublished">2020-10-15</time></a><div class="article-category"><a class="article-category-link" href="/categories/JAVA/">JAVA</a></div><div class="article-views leancloud_visitors" id="/2020/10/Alibaba/WebPush/" data-flag-title="AE在WebPush技术中的探索之路" title="Views"><i class="fas fa-eye"></i><span class="waline-pageview-count" data-path="/2020/10/Alibaba/WebPush/"></span></div></div><div class="article-inner"><header class="article-header" style="text-align:center"><h1 class="article-title" itemprop="name">AE在WebPush技术中的探索之路</h1></header><div class="article-entry" itemprop="articleBody"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>之前几个月在做的WebPush项目，最早接入Firebase的方案，看了一下官方的demo觉得这个需求应该还是很简单的，直到做的过程中遇到<a target="_blank" rel="noopener" href="https://github.com/firebase/quickstart-js/issues/101">fcm token失效</a>的各种坑，以及AE多语言站点的问题，可以说是一路坎坷。</p><p>由于国内连不上谷歌服务，而谷歌的Chrome市场占有率又是最大的，所以国内基本上很少看到有做WebPush的网站，也正因此关于WebPush的中文资料寥寥无几，可以借鉴的网站都是国外的。我们前端接了Firebase的SDK由于体积太大了，移动端也被迫下线，真是屋漏偏逢连夜雨。</p><p>在ATA上搜了一下WebPush相关技术，看到在16年就有<a target="_blank" rel="noopener" href="https://www.atatech.org/articles/64523?spm=ata.13269325.0.0.276449faRcTLzm">AE的同学做过WebPush</a>，从ODPS上的一张表看出18年波哥也基于Firebase做过WebPush，最后应该都无疾而终了，顿时觉得WebPush远比想象的复杂。</p><p>所以国庆回家几天，研究了一下WebPush的规范，以期能从Firebase的泥沼中得到解脱。</p><h2>1、浅谈Push消息</h2><p>Push消息是移动互联网的产物。作为移动端两大操作系统，iOS和Android有各自的消息推送服务，苹果有APNs(Apple Push Notification service)，谷歌有GCM(Google Cloud Messaging)和FCM(Firebase Cloud Messaging)，FCM是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Firebase">Firebase被Google收购</a>后与GCM结合的产物，移动互联网竞争失败者微软也有自己的MPNs。</p><p>APNs和GCM都是系统级的推送能力，以APNs为例，<a target="_blank" rel="noopener" href="https://support.apple.com/en-us/HT203609">iOS系统会有一个5223端口专门用于连接APNs服务</a>。而安卓方面，由于政策原因以及它的开源生态，导致GCM在国内几乎无法使用。一般方案都是开发者自己在App的<a target="_blank" rel="noopener" href="https://developer.android.com/guide/components/services">后台进程</a>中与自己的服务端建立通信。但这样方案缺点是进程被kill后，push就收不到了，所以大家都利用App的进程拉活来保证后台进程活跃，这也导致了前几年<a target="_blank" rel="noopener" href="http://push.baidu.com/">Baidu Push</a>、<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/cps">AliPush</a>、腾讯的<a target="_blank" href="https://xg.qq.com/" rel="external noreferrer nofollow noopener noopener" referrerpolicy="no-referrer">信鸽</a>、<a target="_blank" rel="noopener" href="https://www.umeng.com/push">友盟</a>、<a target="_blank" rel="noopener" href="https://www.getui.com/">个推</a>、<a target="_blank" rel="noopener" href="https://www.jiguang.cn/">极光</a>等各种推送联盟繁盛。</p><p>各种自建通道需要维持长连接<a target="_blank" rel="noopener" href="https://www.sohu.com/a/197188420_99928473">耗电耗内存耗流量</a>，导致Android用户体验极差，这也促使<a target="_blank" rel="noopener" href="https://www.sohu.com/a/207836945_114760">工信部牵头建设统一推送联盟</a>。由于利益关系，各大厂商都想主导这个系统，导致进展缓慢，于是国内各手机厂商都在建立<a target="_blank" rel="noopener" href="https://docs.growingio.com/mp/developers/push-channel/">自己系统的Push通道</a>。但是各家厂商又都有自己的小算盘，毕竟有较大的人力物力投入，所以通道被商业化，比如下发速度等上面做一些文章，这也就与原始Push通道体验问题慢慢变味。另一方面，如果App要有非常好的推送体验，必须集成多家厂商的推送SDK，还有三方的推送SDK，这不仅有很大的开发压力还对自身App的体积是不小的考验。</p><p><img src="https://img.alicdn.com/tfs/TB1Q8.LYYY1gK0jSZTEXXXDQVXa-808-797.png" alt="Push消息"></p><h2>2、从AppPush到WebPush</h2><p>在任何操作系统上浏览器都是使用最频繁的App，随着浏览器的性能提升，很多应用都没有独立的App，而是建立在Web上。WebApp的兴起也激发了WebPush的需求。</p><p><img src="https://www.datocms-assets.com/6307/1565096354-web-push-notification-history.png" alt="WebPush"></p><p>谷歌除了Android操作系统拥有市场最大占比，Chrome也在浏览器市场独占鳌头。苹果和谷歌一样都有自己的操作系统和浏览器，所以苹果的<a target="_blank" rel="noopener" href="https://developer.apple.com/notifications/safari-push-notifications/">APNs</a>和谷歌的FCM也最早支持了WebPush消息。</p><p>PC操作系统上，苹果的APNs在MacOS与iOS上建立了统一的推送服务。微软从Win8开始就借鉴了苹果的很多设计思路，建立了应用商店和<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/uwp/design/shell/tiles-and-notifications/windows-push-notification-services--wns--overview">WNS(Windows Push Notification Services)</a>，WNS就是想统一Windows和WinPhone的消息推送，无奈WP在移动端竞争失败，而PC上Win32传统应用已经根深蒂固，<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Microsoft_Store_(digital)">商店应用</a>难以推广。不可不提的是Windows自家的Edge浏览器的推送服务就是基于WNS的。</p><p><img src="https://img.alicdn.com/tfs/TB193eAiNvbeK8jSZPfXXariXXa-1683-974.png" alt="WebPush"></p><p>Mozilla的Firefox仿佛是独立于三界之外的产物，但是却推动了整个<a target="_blank" rel="noopener" href="https://tools.ietf.org/wg/webpush/">WebPush规范</a>的制定，Mozilla的云服务(<a target="_blank" rel="noopener" href="https://blog.mozilla.org/services/">MCS</a>)也提供了规范中的Push Service的实现——<a target="_blank" rel="noopener" href="https://github.com/mozilla-services/autopush">autopush</a>。目前<a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2016/07/web-push-interop-wins">FCM已经支持了Push规范</a>，<a target="_blank" rel="noopener" href="https://blogs.windows.com/msedgedev/2018/05/22/get-started-web-push-notifications-tutorial-demo/">Edge浏览器也在2018年4月支持了Push标准</a>。苹果的Safari由于其一贯的封闭式发展，目前仍然未支持Push API规范。</p><p><img src="https://img.alicdn.com/tfs/TB1aj.nY.z1gK0jSZLeXXb9kVXa-1896-1202.png"></p><h2>3、WebPush规范</h2><p>WebPush规范分为三部分：WebPush的推送方式(<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8030">RFC8030</a>)，WebPush消息的加密(<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8291">RFC8291</a>)，客户端浏览器与应用服务的识别(<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8292">RFC8292</a>)。</p><h3>3.1、WebPush工作方式</h3><p><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8030">RFC8030</a>中将Push服务分为三个角色：</p><ul><li>UA就是用户浏览器；</li><li>Push Service就是<a target="_blank" rel="noopener" href="https://firebase.google.com/docs/cloud-messaging">FCM</a>、<a target="_blank" rel="noopener" href="https://mozilla-push-service.readthedocs.io/en/latest/">Mozilla Push Service</a>、MNS等云服务；</li><li>App Server就是我们自己开发的应用。</li></ul><p><img src="https://img.alicdn.com/tfs/TB1gGZwY.Y1gK0jSZFMXXaWcVXa-996-604.png" alt="WebPush工作方式"></p><p>整个过程分为一下几步：</p><p>1、用户在浏览器中点击接受订阅后，会向Push Service发起订阅请求；</p><p>2、Push Service会为用户的浏览器分配一个订阅信息；</p><p>3、开发者需要在拿到订阅信息后上传到自己的App Server上；</p><p>4、后面应用服务器就可以使用浏览器的订阅信息要求Push Service向用户推送相应的Push消息了。</p><p>看上去很简单的步骤，这里面其实涉及了很多问题：</p><ul><li><p>Push Service会与若干个浏览器建立非常多的TCP连接，高效的管理这些连接对Push Service是个挑战。好在现在I/O multiplex技术很成熟，Java中也已经有Netty这样的高性能网络库了。</p></li><li><p>App Server向Push Service推送消息后，如果用户浏览器没打开，需要等到用户浏览器打开才能收到消息。消息的实时性可能收到影响，这个时候可能需要设置一下消息的过期时间(TTL)。</p></li><li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/PushSubscription/expirationTime">浏览器订阅信息的过期问题</a>，Push规范提供了这个字段，但是<a target="_blank" rel="noopener" href="https://blog.pushpad.xyz/2018/09/web-push-subscription-age-affects-delivery-rates/">实际多久过期取决于Push Service</a>，WebPush标准没有强制订阅信息到期。</p><blockquote><p>这里有统计各浏览器订阅信息时长的统计：<a target="_blank" rel="noopener" href="https://blog.pushpad.xyz/2018/09/web-push-subscription-age-affects-delivery-rates/">https://blog.pushpad.xyz/2018/09/web-push-subscription-age-affects-delivery-rates/</a></p></blockquote></li><li><p>Push消息的安全性，首先要求应用站点必须基于HTTPS协议，另外为了保证中间人Push Service拿到消息后无法将消息传给第三方或者篡改消息，在<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8291">RFC8291</a>中定义了WebPush消息加密的标准。</p></li><li><p>App Server如何向Push Service标识自己，从而保证拿到用户订阅信息后只有App Server能发送给制定的浏览器，其他人通过该订阅信息无法发送消息给用户。<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8292">RFC8292</a>中就定义了应用服务器识别协议VAPID(Voluntary Application Server Identification)。有了VAPID，Chrome上就不再需要遵循FCM的推送步骤，也<a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2016/07/web-push-interop-wins#introducing_vapid_for_server_identification">不需要在Firebase中创建项目拿到<code>gcm_sender_id</code>了</a>。</p></li></ul><h3>3.2、VAPID协议与消息加密协议</h3><p>对开发者来说，VAPID协议是WebPush的关键，因为这个规范定义了App Server与Push Service的握手以及确定Push Service往哪个客户端发送消息。</p><p>这个过程其实也很简单，前提是你对公钥加密算法比较熟悉：</p><p>1、首先需要创建一对公/私钥，公钥由运行在浏览器端的Web站点持有，私钥由我们的App Server持有。</p><p>2、当用户在浏览器点击接受订阅后，Web程序需要将公钥作为options参数传入到<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/PushManager/subscribe">PushManager.subscribe()</a>方法中。</p><p>3、调用subscribe方法后，浏览器会向Push Service发送订阅请求注册该浏览器。请求中包括Web程序的公钥，Push Service会返回一个Token用于标识该浏览器。下图是Chrome向FCM注册设备时的Http报文：</p><p><img src="https://img.alicdn.com/tfs/TB1SoMCY.z1gK0jSZLeXXb9kVXa-2578-1384.png" alt="subscribe"></p><p>4、拿到这个token，我们就可以拼接出一个http endpoint向push service发送消息了。</p><p>比如上面的token就可以拼接出FCM的endpoint：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://fcm.googleapis.com/fcm/send/fDWFicUHqAw:APA91bFuV2sz0Uz55b1WkLdfXMcUDlA9w7dZZJyvn1XMTPhW0rqMND83gjQ_s6gP60xZn-ubnroyCxJpr4Ejkk-H_F23H0pCwOpyKjEDp3QZdPJlNM1-RmOxWtcOFGjSI5MiKE3F4Qtn</span><br></pre></td></tr></table></figure><p>5、同时浏览器还会生成一对用于加密Push消息的公/私钥。</p><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/PushSubscription/getKey">Subscription.getKey(name)</a>方法可以获取两个Key：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// p256h是客户端生成的公钥，私钥会保存在浏览器中。</span></span><br><span class="line"><span class="comment">// 这样能保证App Server加密后的数据只能被相应的浏览器揭秘</span></span><br><span class="line"><span class="comment">// 而不会被中间人Push Service解密</span></span><br><span class="line"><span class="keyword">var</span> key = subscription.<span class="title function_">getKey</span>(<span class="string">&#x27;p256dh&#x27;</span>);</span><br><span class="line"><span class="comment">// 客户端还会生成一个用于加密的认证信息</span></span><br><span class="line"><span class="keyword">var</span> auth = subscription.<span class="title function_">getKey</span>(<span class="string">&#x27;auth&#x27;</span>);</span><br></pre></td></tr></table></figure><p>6、服务端存储了这endpoint、publicKey、auth三个信息后，就可以给客户端推送push了。这里AppServer的加密方式和HTTPS的有点类似，它不是使用客户端的PublicKey直接对Push消息加密，而是根据客户端的PublicKey生成一个类似于HTTPS会话密钥的对称密钥，再使用<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Galois/Counter_Mode">AES/GCM</a>对称加密算法对消息体进行加密。这样结合了对称加密的高速与非对称加密的安全。具体加密机制可以参考<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8291">RFC8291</a>。</p><h3>3.3、WebPushLib</h3><p>要自己实现VAPID和消息加密的这一套流程，那肯定得费九牛二虎之力的(也确实有前人自己实现了，看<a target="_blank" rel="noopener" href="https://golb.hplar.ch/2019/08/webpush-java.html">这里</a>)。不过比较幸运是<a target="_blank" rel="noopener" href="https://github.com/web-push-libs">WebPushLib</a>早在15年使用Javascript实现了这一套算法，后面陆续也有了其他语言的实现。我觉得16年AE的那个前辈没有成功的原因就是没有这么一个java库（<a target="_blank" rel="noopener" href="https://github.com/web-push-libs/webpush-java/issues?q=is:issue+is:closed+sort:created-asc">因为Java的这个库是16年5月30号才开始开发的</a>）。</p><p>有了WebPushLib一切就如拨云见日，但是AE还是有一个问题亟待解决。</p><h2>4、AE的多站点授权问题</h2><p>AE由于国际化的特性，每个站点都会有不同域名，比如主战是<code>www.aliexpress.com</code>，俄罗斯站点域名是<code>aliexpress.ru</code>，德国站点是<code>de.aliexpress.com</code>…。除此之外，AE业务很复杂，根据业务还会有<code>my.aliexpress.com</code>，<code>trade.aliexpress.com</code>，<code>sale.aliexpress.com</code>，<code>best.aliexpress.com</code>等域名。</p><p>Web Push Permission的权限是基于域名的，每个域名都会有自己的权限，这就可能导致同一用户会有多个订阅信息。推送时可能会给同一个用户推送重复的消息。</p><p><a target="_blank" rel="noopener" href="https://www.google.com/search?q=multi+origin+web+push">谷歌了一下multi origin web push</a>，谷歌官方都说没有完美的解决方案。唯一提到一个解决方案是根据浏设备信息(屏幕大小等数据)生成一个id，用作标识。这个我们前期也用了<a target="_blank" rel="noopener" href="https://github.com/fingerprintjs/fingerprintjs">fingerprint</a>生成了一个browserId，但是第一次用的时候囊括了所有的数据包括浏览器的插件和版本信息，导致browserId不稳定。</p><p><img src="https://img.alicdn.com/tfs/TB1j.7LY1L2gK0jSZPhXXahvXXa-2816-1288.png" alt="Multi Origin web push"></p><p>后面受<a target="_blank" rel="noopener" href="https://www.daraz.pk/">daraz</a>的灵感，觉得可以通过二次弹窗跳到统一的域名进行授权。<a target="_blank" rel="noopener" href="https://www.foxpush.com/demos.html">这个网站</a>有几个Demo可以展示这种做法。</p><p><img src="https://img.alicdn.com/tfs/TB1HvZ4o8Bh1e4jSZFhXXcC9VXa-2582-1464.png" alt="subscribe"></p><p>这种方案将授权收口到一个域名上，好处显而易见，不用维护多套域名的授权信息，极大的避免了web push消息重复推送的问题。</p><p>但是还有一个主要矛盾，每个域名站点怎么确定它是否需要弹窗进行跳转。比如<code>www.xxx.com</code>域名跳转到了订阅页面，后面<code>de.xxx.com</code>、<code>ru.xxx.com</code>域名就不应该弹窗跳转。这貌似又进入了一个死胡同，还是需要browserId的唯一标识对用户浏览器进行识别。</p><p>有一个妥协产品方案是，让每个域名都弹窗一次，弹完后在cookie中记录个数据，保证下次不弹窗。这种方案的弊端是用户真的在<code>www.xxx.com</code>、<code>de.xxx.com</code>、<code>ru.xxx.com</code>站点间切换，第一次进入的时候每个站点都会弹窗一次。另外用户如果把<code>www.xxx.com</code>站点cookie清除了，后面还是会弹窗。</p><p>已经绞尽脑汁儿了，看上去简直不能再有别的方案了。</p><p>最后受<a target="_blank" rel="noopener" href="https://documentation.onesignal.com/docs/web-push-complex-integrations">Complex Web Push Integrations</a>文章和<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/40240155/how-subscribe-pushmanager-via-iframe-in-chrome/40256223#40256223">StackOverflow</a>这篇回答的启发，捣鼓了一个iframe的方案可以完美解决弹窗问题。</p><p>目前我们的主要矛盾是，<code>www.xxx.com</code>、<code>de.xxx.com</code>、<code>ru.xxx.com</code>每个站点都会弹跳转弹窗，所以如果这几个站点都能访问到<code>subscribe.xxx.com</code>存在浏览器中的授权数据就能确定自己是否需要弹窗了。</p><p>我们可以在<code>www.xxx.com</code>、<code>de.xxx.com</code>、<code>ru.xxx.com</code>这几个站点内嵌一个不可见的iframe，iframe内负责提供<code>subscribe.xxx.com</code>域名下授权信息，主站通过访问iframe的<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLIFrameElement/contentWindow">contentWindow</a>对象拿到授权数据。有个问题是iframe是不允许跨站点访问的，好在HTML5中提供了<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">Window.postMessage()</a>API支持window间的跨站点通信。</p><p><img src="https://img.alicdn.com/tfs/TB1Jw_dpkcx_u4jSZFlXXXnUFXa-1492-886.png" alt="postMessage"></p><p><strong>Refs：</strong></p><p>浅谈Push消息推送：<a target="_blank" rel="noopener" href="https://www.atatech.org/articles/173453">https://www.atatech.org/articles/173453</a></p><p>WebPush相关规范：<a target="_blank" rel="noopener" href="https://tools.ietf.org/wg/webpush/">https://tools.ietf.org/wg/webpush/</a></p><p>web-push-basic-knowledge：<a target="_blank" rel="noopener" href="https://pushpushgo.com/en/blog/web-push-basic-knowledge/">https://pushpushgo.com/en/blog/web-push-basic-knowledge/</a></p><p>web-push-notifications-history-effectiveness-more：<a target="_blank" rel="noopener" href="https://blog.resellerclub.com/web-push-notifications-history-effectiveness-more/">https://blog.resellerclub.com/web-push-notifications-history-effectiveness-more/</a></p><p>get-started-web-push-notifications-tutorial-demo：<a target="_blank" rel="noopener" href="https://blogs.windows.com/msedgedev/2018/05/22/get-started-web-push-notifications-tutorial-demo/">https://blogs.windows.com/msedgedev/2018/05/22/get-started-web-push-notifications-tutorial-demo/</a></p><p>Web Push Notification Demo From Chrome：<a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/codelabs/push-notifications">https://developers.google.com/web/fundamentals/codelabs/push-notifications</a></p><p>web-push-protocol：<a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/push-notifications/web-push-protocol">https://developers.google.com/web/fundamentals/push-notifications/web-push-protocol</a></p><p>Web Push Notifications Demo From Edge：<a target="_blank" rel="noopener" href="https://webpushdemo.azurewebsites.net/">https://webpushdemo.azurewebsites.net/</a></p><p>Send WebPush by Firebase：<a target="_blank" rel="noopener" href="https://golb.hplar.ch/2018/01/Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html">https://golb.hplar.ch/2018/01/Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html</a></p><p>Sending Web Push Notifications with Java：<a target="_blank" rel="noopener" href="https://golb.hplar.ch/2019/08/webpush-java.html">https://golb.hplar.ch/2019/08/webpush-java.html</a></p><p>sending-vapid-identified-webpush-notifications-via-mozillas-push-service：<a target="_blank" rel="noopener" href="https://blog.mozilla.org/services/2016/08/23/sending-vapid-identified-webpush-notifications-via-mozillas-push-service/">https://blog.mozilla.org/services/2016/08/23/sending-vapid-identified-webpush-notifications-via-mozillas-push-service/</a></p><p>web-push-interop-wins：<a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2016/07/web-push-interop-wins">https://developers.google.com/web/updates/2016/07/web-push-interop-wins</a></p><p>how-to-reduce-unsubscribe-rate-push-notification：<a target="_blank" rel="noopener" href="https://blog.pushengage.com/how-to-reduce-unsubscribe-rate-push-notification/">https://blog.pushengage.com/how-to-reduce-unsubscribe-rate-push-notification/</a></p><p>web-push-subscription-age-affects-delivery-rates：<a target="_blank" rel="noopener" href="https://blog.pushpad.xyz/2018/09/web-push-subscription-age-affects-delivery-rates/">https://blog.pushpad.xyz/2018/09/web-push-subscription-age-affects-delivery-rates/</a></p><p>web-push-complex-integrations：<a target="_blank" rel="noopener" href="https://documentation.onesignal.com/docs/web-push-complex-integrations">https://documentation.onesignal.com/docs/web-push-complex-integrations</a></p><p>cross-document-communication-with-iframes：<a target="_blank" rel="noopener" href="https://benohead.com/blog/2015/12/07/cross-document-communication-with-iframes/">https://benohead.com/blog/2015/12/07/cross-document-communication-with-iframes/</a></p></div><div class="article-copyright"><p>本作品采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a> 进行许可。</p><p>转载时请注明<a href="https://blog.hufeifei.cn/2020/10/Alibaba/WebPush/">原文链接</a>：https://blog.hufeifei.cn/2020/10/Alibaba/WebPush/</p></div><footer class="article-footer"><div class="article-tag"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Alibaba/" rel="tag">Alibaba</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JAVA/" rel="tag">JAVA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebPush/" rel="tag">WebPush</a></li></ul></div></footer></div><div id="article-reward"><i class="iconfont ic-money"></i><div>鼓励一下</div><table><thead><tr><th style="text-align:center">支付宝</th><th style="text-align:center">微信</th></tr></thead><tbody><tr><td style="text-align:center"><img width="150" src="https://www.hufeifei.cn/reward-img/alipay.jpg"></td><td style="text-align:center"><img width="135" src="https://www.hufeifei.cn/reward-img/wechat.jpg"></td></tr></tbody></table></div><nav id="article-nav"><a class="article-nav-link-wrap" href="/2020/12/%E7%94%9F%E6%B4%BB/2020/" id="article-nav-newer"><strong class="article-nav-caption">Newer</strong><div class="article-nav-title">告别24岁，告别理想，告别2020</div></a><a class="article-nav-link-wrap" href="/2020/08/Alibaba/BigData/" id="article-nav-older"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">数据处理大观园——一个从无到有的大数据平台</div></a></nav></article><div id="waline-comments"></div><script type="module">import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';init({"el":"#waline-comments","pageview":true,"enable":true,"serverURL":"https://api.waline.blog.hufeifei.cn","avatar":"mp","pageSize":10,"lang":"zh-cn","placeholder":"Just go go","visitor":true,"recordIP":true,"requiredFields":["nick"]});</script></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">关注微信公众号</h3><div class="widget wechat"><img src="//www.hufeifei.cn/wechat-public-account.jpg"></div></div><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C&C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/J2EE/">J2EE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux%E8%BF%90%E7%BB%B4/">Linux运维</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/">Ruby</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Rust/">Rust</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E6%97%A5%E5%B8%B8/">代码日常</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%95%86%E4%B8%9A/">商业</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E6%B5%8E%E4%B8%8E%E9%87%91%E8%9E%8D/">经济与金融</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/">计算机组成</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/AVL/" style="font-size:11.11px">AVL</a> <a href="/tags/Alibaba/" style="font-size:14.44px">Alibaba</a> <a href="/tags/Android/" style="font-size:18.89px">Android</a> <a href="/tags/B-Tree/" style="font-size:12.22px">B-Tree</a> <a href="/tags/BKD-Tree/" style="font-size:10px">BKD-Tree</a> <a href="/tags/BST/" style="font-size:10px">BST</a> <a href="/tags/BigData/" style="font-size:11.11px">BigData</a> <a href="/tags/C/" style="font-size:14.44px">C</a> <a href="/tags/CGlib/" style="font-size:10px">CGlib</a> <a href="/tags/CS/" style="font-size:11.11px">CS</a> <a href="/tags/Canal/" style="font-size:10px">Canal</a> <a href="/tags/ClassLoader/" style="font-size:10px">ClassLoader</a> <a href="/tags/ClickHouse/" style="font-size:10px">ClickHouse</a> <a href="/tags/Config/" style="font-size:10px">Config</a> <a href="/tags/Cryptography/" style="font-size:10px">Cryptography</a> <a href="/tags/DB/" style="font-size:20px">DB</a> <a href="/tags/Dapper/" style="font-size:10px">Dapper</a> <a href="/tags/DataStructure/" style="font-size:14.44px">DataStructure</a> <a href="/tags/Debezium/" style="font-size:10px">Debezium</a> <a href="/tags/Diamond/" style="font-size:10px">Diamond</a> <a href="/tags/Distributed/" style="font-size:13.33px">Distributed</a> <a href="/tags/ElasticSearch/" style="font-size:10px">ElasticSearch</a> <a href="/tags/Encoding/" style="font-size:10px">Encoding</a> <a href="/tags/FastJson/" style="font-size:10px">FastJson</a> <a href="/tags/File/" style="font-size:10px">File</a> <a href="/tags/FlowMarketing/" style="font-size:10px">FlowMarketing</a> <a href="/tags/Grade/" style="font-size:10px">Grade</a> <a href="/tags/Gson/" style="font-size:10px">Gson</a> <a href="/tags/HTTP/" style="font-size:10px">HTTP</a> <a href="/tags/Handler/" style="font-size:10px">Handler</a> <a href="/tags/Hanlder/" style="font-size:10px">Hanlder</a> <a href="/tags/Hessian/" style="font-size:10px">Hessian</a> <a href="/tags/IO-Multiplex/" style="font-size:10px">IO-Multiplex</a> <a href="/tags/JAVA/" style="font-size:18.89px">JAVA</a> <a href="/tags/JVM/" style="font-size:10px">JVM</a> <a href="/tags/KD-Tree/" style="font-size:10px">KD-Tree</a> <a href="/tags/KDB-Tree/" style="font-size:10px">KDB-Tree</a> <a href="/tags/Kafka/" style="font-size:10px">Kafka</a> <a href="/tags/Kubernetes/" style="font-size:10px">Kubernetes</a> <a href="/tags/LSM-Tree/" style="font-size:11.11px">LSM-Tree</a> <a href="/tags/Linux/" style="font-size:17.78px">Linux</a> <a href="/tags/Lock/" style="font-size:11.11px">Lock</a> <a href="/tags/Lucene/" style="font-size:10px">Lucene</a> <a href="/tags/MQ/" style="font-size:10px">MQ</a> <a href="/tags/Macro/" style="font-size:10px">Macro</a> <a href="/tags/Magisk/" style="font-size:10px">Magisk</a> <a href="/tags/MultiDex/" style="font-size:10px">MultiDex</a> <a href="/tags/MySQL/" style="font-size:17.78px">MySQL</a> <a href="/tags/NIO/" style="font-size:10px">NIO</a> <a href="/tags/Nginx/" style="font-size:11.11px">Nginx</a> <a href="/tags/OGNL/" style="font-size:10px">OGNL</a> <a href="/tags/OpenResty/" style="font-size:10px">OpenResty</a> <a href="/tags/OpenTelemetry/" style="font-size:10px">OpenTelemetry</a> <a href="/tags/Oracle/" style="font-size:10px">Oracle</a> <a href="/tags/PostgreSQL/" style="font-size:10px">PostgreSQL</a> <a href="/tags/RB-Tree/" style="font-size:10px">RB-Tree</a> <a href="/tags/Redis/" style="font-size:10px">Redis</a> <a href="/tags/Rust/" style="font-size:10px">Rust</a> <a href="/tags/Sharding/" style="font-size:10px">Sharding</a> <a href="/tags/SpringBoot/" style="font-size:10px">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size:10px">SpringCloud</a> <a href="/tags/SpringCloudConfig/" style="font-size:10px">SpringCloudConfig</a> <a href="/tags/Sqlite/" style="font-size:10px">Sqlite</a> <a href="/tags/SurfaceView/" style="font-size:10px">SurfaceView</a> <a href="/tags/VSCode/" style="font-size:11.11px">VSCode</a> <a href="/tags/WebFlux/" style="font-size:10px">WebFlux</a> <a href="/tags/WebPush/" style="font-size:10px">WebPush</a> <a href="/tags/Web%E6%8C%96%E6%8E%98/" style="font-size:11.11px">Web挖掘</a> <a href="/tags/awk/" style="font-size:10px">awk</a> <a href="/tags/bit-hack/" style="font-size:10px">bit-hack</a> <a href="/tags/cheat-sheet/" style="font-size:10px">cheat sheet</a> <a href="/tags/curl/" style="font-size:10px">curl</a> <a href="/tags/epoll/" style="font-size:10px">epoll</a> <a href="/tags/gRPC/" style="font-size:10px">gRPC</a> <a href="/tags/grep/" style="font-size:10px">grep</a> <a href="/tags/kqueue/" style="font-size:10px">kqueue</a> <a href="/tags/libev/" style="font-size:10px">libev</a> <a href="/tags/libevent/" style="font-size:10px">libevent</a> <a href="/tags/libuv/" style="font-size:10px">libuv</a> <a href="/tags/metaq/" style="font-size:10px">metaq</a> <a href="/tags/poll/" style="font-size:10px">poll</a> <a href="/tags/sed/" style="font-size:10px">sed</a> <a href="/tags/select/" style="font-size:10px">select</a> <a href="/tags/ssh/" style="font-size:10px">ssh</a> <a href="/tags/%E5%8E%86%E5%8F%B2/" style="font-size:10px">历史</a> <a href="/tags/%E5%95%86%E4%B8%9A/" style="font-size:10px">商业</a> <a href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size:10px">心理学</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size:11.11px">生活</a> <a href="/tags/%E7%A8%8E%E6%94%B6/" style="font-size:10px">税收</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:14.44px">算法</a> <a href="/tags/%E7%BB%8F%E6%B5%8E/" style="font-size:15.56px">经济</a> <a href="/tags/%E8%90%A5%E9%94%80/" style="font-size:10px">营销</a> <a href="/tags/%E8%B4%A7%E5%B8%81/" style="font-size:10px">货币</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size:16.67px">随笔</a></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/2024/04/economic/value-added-tax/">增值税与贫富差距</a></li><li><a href="/2024/01/Net/x-forward-for/">“真”的IP真的是真的吗？</a></li><li><a href="/2024/01/paper/MarkupLM-web-extract/">【译】基于MarkupLM的web数据抽取</a></li><li><a href="/2023/09/economic/tax-reform/">直接税改革——王朝周期律的胜负手</a></li><li><a href="/2023/09/Rust/macro-rules-learning/">Rust中的宏</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">网站运营不易</h3><div class="ads-wrapper"><div class="google_ads"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7111912103882824" data-ad-slot="8429272980" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></aside></div><footer id="footer"><div class="outer"><div class="inner" id="footer-info"><p><a href="https://beian.miit.gov.cn/" target="_blank">赣ICP备17009276号</a><i class="far fa-copyright"></i>2016 ~ 2024 胡飞飞</p><p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><i class="fas fa-angle-right"></i>Theme by <a target="_blank" rel="noopener" href="https://github.com/holmofy/hexo-theme-paper">paper</a></p></div></div></footer></div><nav id="mobile-nav"><a class="mobile-nav-link" href="//www.hufeifei.cn">主页</a><a class="mobile-nav-link" href="/">博客</a><a class="mobile-nav-link" href="/archives">归档</a><a class="mobile-nav-link" target="_blank" rel="noopener" href="//algo.hufeifei.cn">算法</a><a class="mobile-nav-link" href="/book">书籍</a><a class="mobile-nav-link" href="/github">Github</a></nav><script src="//cdnjs.loli.net/ajax/libs/jquery/3.0.0/jquery.min.js"></script><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/script.js"></script></div><script>
  $(document).ready(function() {
    $('figure.codeblock').find('.tab').click(function() {
        var $codeblock = $(this).parent().parent().parent();
        var $tab = $(this);
        // remove "active" css class on all tabs
        $tab.siblings().removeClass('active');
        // add "active" css class on the clicked tab
        $tab.addClass('active');
        // hide all tab contents
        $codeblock.find('.highlight').hide();
        // show only the right one
        $codeblock.find('.highlight.' + $tab.text()).show();
    });
  });
  </script><script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'BPJzNs1QEtbYa3Bn0gMAQHBAzX3Jm71llGUKHTkKEUs3D9xiDYZ0DWJ3S9sfCAAJHxXEoBkUANFyONjeIlgrJUo'' });</script></body></html>